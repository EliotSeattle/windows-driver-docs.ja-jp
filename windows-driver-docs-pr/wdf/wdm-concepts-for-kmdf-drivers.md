---
title: WDF ドライバーでの WDM の概念
description: WDF ドライバーでの WDM の概念
ms.assetid: 164b4882-a5a3-45d3-a2f5-53367b396439
keywords:
- カーネルモードドライバー WDK KMDF、WDM
- KMDF WDK、WDM
- カーネルモードドライバーフレームワーク WDK、WDM
- フレームワークベースのドライバー WDK KMDF、WDM
- WDM ドライバー WDK KMDF
- バス列挙型 WDK KMDF
- バスドライバー WDK KMDF
- 関数ドライバー WDK KMDF
- ドライバーのフィルター WDK KMDF
- ドライバースタック WDK KMDF
- スタック WDK KMDF
- デバイススタック WDK KMDF
- Irp WDK KMDF
- I/o 要求パケット WDK KMDF
- I/o 要求 WDK KMDF、Irp
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: b54f8c54ea5a1ad6a7b006191f8c1a32816ded66
ms.sourcegitcommit: b316c97bafade8b76d5d3c30d48496915709a9df
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/13/2020
ms.locfileid: "79242855"
---
# <a name="wdm-concepts-for-wdf-drivers"></a>WDF ドライバーでの WDM の概念


Windows ドライバーフレームワーク (WDF) は、Microsoft Windows Driver Model (WDM) インターフェイスのラッパーです。 フレームワークでは、多くの WDM 概念を簡素化し、他の概念を完全に隠すことができますが、WDM ドライバーの基本的な概念について理解しておく必要があります。 具体的には、[ドライバーの種類](#driver-types)、[ドライバースタック](#driver-stacks)、[デバイススタック](#device-stacks)、および[i/o 要求パケット](#io-request-packets)について理解しておく必要があります。

### <a name="driver-types"></a>ドライバーの種類

Windows ベースのドライバーは、[バスドライバー](https://docs.microsoft.com/windows-hardware/drivers/kernel/bus-drivers)、[関数ドライバー](https://docs.microsoft.com/windows-hardware/drivers/kernel/function-drivers)、および[フィルタードライバー](https://docs.microsoft.com/windows-hardware/drivers/kernel/filter-drivers)の3種類に分けられています。 バスドライバーは、親バスに接続されている子デバイスを検出し、その特性を報告することによって、i/o バスをサポートします。 (このアクティビティは*バス列挙*と呼ばれます)。関数ドライバーは、デバイスとバスの i/o 操作を制御します。 フィルタードライバーは、ユーザーアプリケーションとドライバーの間、または個別のドライバー間で流れるデータを受信、確認、および変更する場合があります。

バス用のドライバーは、子も列挙する関数ドライバーです。 ドライバーは、バス上の子デバイスを列挙するときに "バスドライバー" として機能します。 それ以外の場合、バスアダプターのハードウェアにアクセスする i/o 操作を処理するときに、同じドライバーがバスの "関数ドライバー" として機能します。

ユーザーモードドライバーフレームワーク (UMDF) ドライバーをバスドライバーにすることはできません。

### <a name="driver-stacks"></a>ドライバー スタック

Windows オペレーティングシステムでは、WDM ドライバーは、*ドライバースタック*と呼ばれる垂直方向の呼び出しシーケンスに階層化されます。 スタック内の最上位のドライバーは、通常、要求がオペレーティングシステムの i/o マネージャーを通過した後に、ユーザーアプリケーションから i/o 要求を受信します。 下位のドライバーレイヤーは、通常、コンピューターのハードウェアと通信します。

単純なドライバースタックには、バスドライバーがスタックの一番下に含まれています。バスドライバーはバス固有の i/o 操作を処理し、接続されている子デバイスを列挙します。 通常、1つまたは複数のデバイス固有の関数ドライバーがバスドライバーを超えています。 これらの関数ドライバーは、バスに接続されているデバイスへの i/o 操作を処理します。 フィルタードライバーは、関数ドライバーの上に配置することも、バスドライバーと関数ドライバーの間に配置することもできます。 実行中のシステムには、さまざまな種類のデバイスをサポートする複数のドライバースタックがあります。

### <a name="device-stacks"></a>デバイススタック

各ドライバースタックは、1つまたは複数の*デバイススタック*をサポートします。 デバイススタックは、WDM 定義[**デバイス\_オブジェクト**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/ns-wdm-_device_object)構造から作成される*デバイスオブジェクト*のセットです。 各デバイススタックは、1つのデバイスを表します。 各ドライバーは、デバイスごとにデバイスオブジェクトを作成し、各デバイスオブジェクトをデバイススタックにアタッチします。 デバイススタックは、デバイスが接続され、取り外されると、システムが再起動されるたびに、作成および削除されます。

バスドライバーは、子デバイスが電源に接続されているか、接続が切断されたことを検出すると、プラグアンドプレイ (PnP) マネージャーに通知します。 応答として、PnP マネージャーは、親デバイス (つまり、バス) に接続されている子デバイスごとに物理デバイスオブジェクト (PDO) を作成するようにバスドライバーに要求します。 PDO がデバイススタックの一番下になります。

次に、PnP マネージャーは、(まだ読み込まれていない場合は) 各デバイスをサポートするために関数とフィルタードライバーを読み込み、PnP マネージャーはこれらのドライバーを呼び出します。これにより、各デバイスオブジェクトを作成し、デバイススタックの一番上に追加できるようになります。 関数ドライバーは、機能デバイスオブジェクト (FDOs) を作成し、フィルタードライバーはフィルターデバイスオブジェクトを作成します (フィルター DOs)。

I/o マネージャーは、デバイスのドライバーに i/o 要求を送信すると、デバイススタック内の最上位のデバイスオブジェクトを作成したドライバーに要求を渡します。 このドライバーが、要求を次の下位のドライバーに渡すように要求した場合、i/o マネージャーはデバイススタックを使用して次の下位のドライバーを特定します。 (次の下位のドライバーは、次の下位のデバイスオブジェクトを作成したドライバーです)。

WDF は、各 WDM デバイスオブジェクトのフレームワークデバイスオブジェクトを作成します。 フレームワークベースのドライバーは、WDM デバイスオブジェクトではなく、これらのフレームワークデバイスオブジェクトにアクセスします。

### <a name="io-request-packets"></a>I/O 要求パケット

I/o マネージャーは、i/o 要求パケット (Irp) を作成することによって、ドライバーにアプリケーションの i/o 要求を送信します。 IRP には、i/o 操作 (読み取り/書き込み操作など) を実行する要求、または i/o 制御 (IOCTL) アクション (状態を返すなど) を実行する要求を含めることができます。 さらに、PnP マネージャーは、ドライバーが実行する必要がある PnP および電源管理操作を表す Irp を作成し、これらの Irp をドライバーに送信します。

通常、ユーザーアプリケーションが読み取り操作または書き込み操作を要求したときに、i/o マネージャーによって読み取りまたは書き込みの IRP が作成されます。 I/o マネージャーは、ドライバースタックの一番上にあるドライバーに IRP を渡します。このドライバーは、要求をサービスするか、次の下位のドライバーに要求を渡します。 一部の要求はスタックの一番下に移動し、一部は上位レベルのドライバーによって完全に処理されます。

ドライバーが IRP を受信するたびに、ドライバーは、操作を処理する必要があるデバイスを表すデバイスオブジェクトへのポインターも受け取ります。 そのため、ドライバースタック内のドライバーは、デバイスオブジェクトを使用して、特定の要求がどのような接続先のデバイスにアクセスするかを判断します。

WDF ドライバーは通常、Irp に直接アクセスしません。 このフレームワークは、読み取り、書き込み、およびデバイス i/o 制御操作を表す WDM Irp を、カーネルモードドライバーフレームワーク (KMDF) および UMDF ドライバーが i/o キューで受信するフレームワーク要求オブジェクトに変換します。 このフレームワークは、PnP および電源管理の Irp を内部で処理し、イベントコールバック関数を使用して PnP および電源イベントのドライバーを通知します。

 

 





