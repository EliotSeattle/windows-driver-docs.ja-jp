---
Description: USB ETW と Netmon を使用して、Windows で認識されない USB デバイスをトラブルシューティングする方法の例を示します。
title: 導入事例 - 不明な USB デバイスのトラブルシューティング
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 1a9909ed6a0ab9fbc506ad3bca3bf5a3fcfaa0e4
ms.sourcegitcommit: b3859d56cb393e698c698d3fb13519ff1522c7f3
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/05/2019
ms.locfileid: "57349423"
---
# <a name="case-study-troubleshooting-an-unknown-usb-device-by-using-etw-and-netmon"></a>ケース スタディ:ETW と Netmon を使用した不明な USB デバイスのトラブルシューティング


このトピックでは、USB ETW と Netmon を使用して、Windows で認識されない USB デバイスをトラブルシューティングする方法の例を示します。

この例では、デバイスに接続されていることと、デバイス マネージャーとユーザー インターフェイス (UI) の他の部分で不明なデバイスとして表示されます。 ハードウェア ID が USB\\不明です。 診断をさらに、ETW トレースを開始、および、再度デバイスに接続されているデバイスが接続されていません。 不明なデバイスとして、デバイスが表示された後、は、トレースを停止しました。

-   [不明なデバイスの問題について](#about-the-unknown-device-problem)
-   [イベント トレースの分析の開始](#starting-the-event-trace-analysis)
-   [USB デバイスの概要イベント](#usb-device-summary-events)
-   [イベントの説明とデータ ペイロード](#event-description-and-data-payload)
-   [USB Netmon フィルター](#usb-netmon-filters)
-   [エラー イベントと状態コードを理解します。](#status-codes)
-   [問題のイベントから下位の読み取り](#reading-backwards-from-problem-events)
-   [関連トピック](#related-topics)

## <a name="about-the-unknown-device-problem"></a>不明なデバイスの問題について


不明な USB デバイスの問題をデバッグするには、USB ドライバー スタックは、ユーザーがシステムに接続するときに、デバイスを列挙するを理解することができます。 USB の列挙体については、ブログ投稿「を参照してください。 [USB スタックはデバイスを列挙する方法でしょうか。](https://go.microsoft.com/fwlink/p/?linkid=617517)

通常、USB ドライバー スタックは、デバイスを列挙するために失敗した場合、ハブのドライバーを Windows デバイスの到着を報告し、USB デバイスがデバイス マネージャーで、不明なデバイスとしてマークされています。 デバイスがデバイス ID の USB\\VID\_0000 & PID\_USB の 0000 とハードウェア ID および互換性のある ID\\不明。 不明なデバイスとしての USB デバイスを列挙するために USB ハブのドライバーにより、次のイベント。

-   ポートは、要求が列挙中にタイムアウトをリセットします。
-   USB デバイスのアドレスの設定要求が失敗しました。
-   USB デバイスのデバイスの記述子の要求が失敗しました。
-   [USB デバイス記述子](usb-device-descriptors.md)形式が正しくないと、検証に失敗しました。
-   構成記述子の要求が失敗しました。
-   [USB 構成記述子](usb-configuration-descriptors.md)形式が正しくないと、検証に失敗しました。

Windows 7 では、列挙に失敗した不明なデバイスがエラーでマークされます[コード 43](https://go.microsoft.com/fwlink/p/?linkid=617523)デバイス マネージャーでします。

デバイスが失敗とマークされている場合[コード 28](https://go.microsoft.com/fwlink/p/?linkid=617525)デバイス マネージャーで、デバイスは正常に列挙しますが、不明なデバイスでは引き続きします。 このエラー コードは、デバイスが列挙中に製品 ID 文字列を提供していないと、Windows ドライバーをインストールするデバイスの対応する INF が見つかりませんだったことを示します。

## <a name="starting-the-event-trace-analysis"></a>イベント トレースの分析の開始


これは、デバイスの障害であるために、USB パーサー Netmon を使用して、ログ ファイルを分析することをお勧めします。

**イベント トレース ログを表示するには**

1.  Netmon を実行**ファイル -&gt;オープン -&gt;キャプチャ**、ファイルを選択します。
2.  最初のイベントの選択、**フレーム概要**ウィンドウで、SystemTrace の説明があります。 この図は、画面の外観の最初のイベントを選択するとします。

    ![microsoft ネットワーク モニター](images/devicefailure-etl.png)

3.  ネットワーク モニターを表示する列をカスタマイズするには、列名を右クリックして**列の選択**します。
4.  最初のイベントは、型として識別される**SystemTrace**、全般的なログ情報が含まれています。 ツリーを展開することができます、**フレーム詳細**失われたイベントの数などの情報を表示するウィンドウおよびトレースの開始時刻。

## <a name="usb-device-summary-events"></a>USB デバイスの概要イベント


イベント 2 は、ログに最初の USB イベントです。 これと後続のいくつかのイベントは、USB ホスト コント ローラー、ハブ、およびトレースを開始したときに、システムに接続されたデバイスを説明します。 デバイスの概要イベントまたはイベントの概要だけは、このイベントのグループを呼んでいます。 最初のイベントと同様に概要イベントではドライバのアクティビティは説明しません。 概要のイベントには、ログ記録セッションの開始時のデバイスの状態が記録されます。 その他のイベントは、バス、クライアント ドライバーとの対話またはシステム、または内部の状態の変更で実行される操作を表します。

USB ハブ、USB ポート ドライバーは、概要のイベントを記録します。 イベント ログに記録するドライバーは、プロトコル名 列で識別されます。 たとえば、USB ポート ドライバーによってログに記録されるイベントには、し、USBPort\_MicrosoftWindowsUSBPORT プロトコルの名前。 通常、USB イベントのトレースには、hub の概要イベント数のシーケンスの後に、ポートの概要イベントのシーケンスが含まれています。 多くの USB ポート、および USB ハブの概要イベントにより、その説明に「情報」または「属性」単語があります。

概要のイベントの終了を識別する方法はありますか ログの先頭に USB ハブのイベントのタイムスタンプ パターンに重大な中断がある場合その区切り、おそらく、デバイスの概要の終わりです。 それ以外の場合、任意の USB ハブ イベントの後に、最初の USB ポート イベントは、最初の非集計イベントでは可能性があります。 次のページの図 3 は、このサンプルのトレースの最初の非集計イベントを示します。

この例ではここでは、デバイスの概要イベントをスキップするために、トレースを開始したときに関心のあるデバイスをシステムに接続がありません。

![microsoft ネットワーク モニター](images/devicefailure-etl1.png)

## <a name="event-description-and-data-payload"></a>イベントの説明とデータ ペイロード


サンプル ログで、デバイスの概要イベントの後に最初のイベントは、USB ハブ待機 Wake IRP 完了イベントです。 デバイスに接続されているおよびホスト コント ローラーまたはハブがウェイク アップする応答。 コンポーネントのウェイク アップを決定するには、イベントのデータを見てください。 次の形式では約でツリー構造で表示されているフレームの詳細ウィンドウでは、データです。

```cpp
Frame information
ETW event header information
    ETW event descriptor (Constant information about the event ID such
    as error level)
Event payload (Data logged at the time of the event)
    Name of a USB-specific structure
        Structure members and their values (Types: numbers, strings,
        or arrays)
    ...
```

USB ハブ待機 Wake IRP 完了イベントのペイロード データを展開し、fid という ETW 構造が表示されます\_USBHUB\_ハブ。 構造の名前には、次のコンポーネントがあります。

<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th>項目</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><strong>fid_</strong></p></td>
<td><p>USB ETW 構造の一般的なプレフィックス。</p></td>
</tr>
<tr class="even">
<td><p> <strong>USBHUB_</strong></p></td>
<td><p>USB ハブのドライバーが、イベントを記録することを示します。</p></td>
</tr>
<tr class="odd">
<td><p><strong>文字列の残りの部分</strong></p></td>
<td><p>構造体のデータを記述するオブジェクトの名前。 このイベントでは、ハブ オブジェクトです。</p></td>
</tr>
</tbody>
</table>



USB ハブのドライバーを使用して、 **fid\_USBHUB\_ハブ**USB ハブを記述する構造体。 ハブに、データ ペイロードでこのハブの構造を持つイベントを参照してくださいし、構造体の内容を使用して、特定のハブを割り出すことができます。 図 4 とフレームの詳細 ウィンドウを示しています、 **fid\_USBHUB\_ハブ**構造を展開してそのフィールドを表示します。

![microsoft ネットワーク モニター - フレームの詳細](images/framedetails.png)

ハブの構造は USB ETW イベントで頻繁に表示されるその他の 2 つの構造によく似ています**fid\_USBHUB\_デバイス**と**fid\_し、USBPORT\_デバイス**。 次の重要なフィールドは、次の 3 つのすべての構造に共通です。

<a href="" id="fid-idvendor"></a>**fid\_idVendor**  
USB 仕入先 ID (VID) のデバイス。

<a href="" id="-fid-idproduct"></a> **fid\_idProduct**  
USB プロダクト ID (PID)、デバイスの。

<a href="" id="-fid-portpath"></a> **fid\_PortPath**  
使用する USB デバイスが接続されているハブの 1 から始まるポート番号のリスト。 一覧内のポート番号の数が含まれている、 **PortPathDepth**フィールド。 ルート ハブ デバイスでは、この一覧はすべて 0 になります。 ルート ハブのポート、PortPath の値に直接接続されている USB デバイスの\[0\]デバイスが接続されているポートのルート ハブのポート番号です。 1 つまたは複数の他の USB ハブを通じて接続されている USB デバイスの場合は、ハブのポート番号の一覧は、ルート ハブのポートで開始され、(ルート ハブからの距離) の順序で追加のハブで続行します。 すべてのゼロを無視します。 以下に例を示します。

| サンプル値         | 説明                                                                                                                       |
|----------------------|-----------------------------------------------------------------------------------------------------------------------------------|
| \[0, 0, 0, 0, 0, 0\] | イベントは、ルート ハブ (pc で USB ホスト コント ローラーによって制御される直接ポート) を参照します。                                  |
| \[3, 0, 0, 0, 0, 0\] | イベントは、ハブまたはルート ハブのポート番号 3 に接続されているデバイスを指します。                                            |
| \[3, 1, 0, 0, 0, 0\] | ハブは、3 のルート ハブのポートに接続されます。 イベントは、ハブまたはこの外部ハブのポート 1 に接続されているデバイスを指します。 |



関心のあるすべてのデバイスのポートのパスを監視する必要があります。 デバイスが列挙されているときに、VID と PID は、不明な 0 としてログに記録されたです。 VID と PID はいない一部のリセットなどの低レベル デバイス要求中に表示および中断します。 これらの要求は、デバイスに接続されているハブに送信されます。

ログのサンプルでは、Wake 待機の完了イベントは、6 個のゼロとポートのパスを持ちます。 イベントでは、ルート ハブにスリープ解除待機操作を示します。 あるため、アクション論理: ルート ハブがウェイク アップするため、ルート ハブのポートに、デバイスを接続します。

## <a name="usb-netmon-filters"></a>USB Netmon フィルター


時間がある場合は、時系列でのログ内の各イベントを確認できます。 エクスペリエンスを使用してもイベントの説明の一覧をスキャンして、重要なイベントをすばやく識別するために困難です。 すばやく詳細不明なデバイスの原因を特定するには、Netmon フィルター機能を使用することができます。

**USB のエラー フィルター**

Netmon での USB エラー フィルターを有効にするには、クリックして**フィルター -&gt;表示フィルター -&gt;フィルターの読み込み -&gt;標準フィルター -&gt; USB -&gt; USB ハブ エラー**、順にクリックします**適用**で、**ディスプレイ フィルター**ウィンドウ。

USB のエラー フィルターは、次の表に示すように条件を満たすものだけにイベントの一覧を絞り込みます。

| フィルター テキスト                                                                       | 説明                                                                                                                                               |
|-----------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------|
| (し、USBPort\_MicrosoftWindowsUSBUSBPORT と NetEvent.Header.Descriptor.Opcode 34 = =) | オペコード 34 の USB ポート イベントは、ポート エラーです。                                                                                                      |
| (USBHub\_MicrosoftWindowsUSBUSBHUB と NetEvent.Header.Descriptor.Opcode 11 を = =)   | オペコード 11 USB ハブのイベントは、ハブ エラーです。                                                                                                        |
| (NetEvent.Header.Descriptor.Level == 0x2)                                         | レベルが 0x2 イベントは、通常はエラーです。                                                                                                            |
| (USBHub\_MicrosoftWindowsUSBUSBHUB と NetEvent.Header.Descriptor.Id 210 = =)      | USB ハブのイベント ID 210 では、イベントの「USB ハブの例外の記録」です。 詳細については、[エラー イベントの概要と状態コード](#status-codes)を参照してください。 |



このイメージに表示されるイベントの小さなセットを示しています、**フレーム概要**ウィンドウで、サンプルのトレース ログに、USB エラー フィルターを適用した後。

![microsoft ネットワーク モニター](images/devicefailure-etl2.png)

一連のエラーの概要を表示するには、各エラー イベントを簡単に表示できます。 観察する重要なフィールドを含める**fid\_NtStatus**、 **fid\_UsbdStatus**、および**fid\_DebugText**します。 詳細については、[エラー イベントの概要と状態コード](#status-codes)を参照してください。 フィルターを無効にするには、をクリックして、**削除**ボタン、**ディスプレイ フィルター**ウィンドウ。

**カスタム Netmon フィルター**

ネットワーク モニターでは、カスタム フィルターを作成できます。 最も簡単な方法では、次の方法のいずれかで、画面上のデータからフィルターを作成します。

-   内のフィールドを右クリックし、**フレームの詳細**ペイン**ディスプレイ フィルターを選択した値を追加**します。
-   内のフィールドを右クリックし、**フレーム概要**ペイン**追加\[フィールド名\]ディスプレイ フィルターを**します。

演算子を変更することができます (など、OR、AND、および = =) と適切なフィルター式を作成するフィルターの値。
## <a name="understanding-error-events-and-status-codes"></a>エラー イベントと状態コードを理解します。


USB ハブの例外のほとんどがあるこの不明なデバイスの例では、 **fid\_DebugText** CreateDeviceFailure のデータ。 どの重大な例外は、明確ではありませんが、デバッグ テキストは、原因、ヒントを示します。 新しいデバイスに関連する操作に失敗しました。 ここでは、隣接するデバイスの作成失敗イベントが冗長なことを想定しています。 最後の 2 つの例外は、CreateDeviceFailure\_ポップアップと GenErr\_UserIoctlFailed します。 ポップアップ例外サウンドなどのエラーをユーザーに公開されましたが、これらのエラーのすべてが関連する不明なデバイスの問題。

USB のエラー イベント、およびその他のイベントの問題に関する重要な情報を提供するデータにステータス値であります。 状態の値の情報は、次の表に、リソースを使用して確認できます。

| ステータスの種類                                                          | リソース                                                                                                                                                                                                                         |
|----------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **fid\_NtStatus**                                                    | 参照してください[NTSTATUS 値](https://go.microsoft.com/fwlink/p/?linkid=617532)します。                                                                                                                                                          |
| USB 要求ブロック (URB) の状態フィールドまたは**fid\_UsbdStatus** | USBD として値を検索\_inc のステータス\\api\\usb.h Windows Driver Kit (WDK) にします。 使用することも、 [USBD\_状態](https://msdn.microsoft.com/library/windows/hardware/ff539136)します。 このトピックでは、シンボリック名と、USBD の意味を示します\_状態の値。 |



## <a name="reading-backwards-from-problem-events"></a>問題のイベントから下位の読み取り


エラー イベントの前にログに記録されるイベントは、エラーの原因に関する重要な手がかりを提供可能性があります。 不明なデバイスの根本原因を特定しようとするエラーの前にログに記録されるイベント確認する必要があります。 この例では、開始、CreateDeviceFailure の旧バージョンとの参照\_ポップアップ イベント、最後から 2 番目の例外。 クリックして、USB エラー フィルターが有効になっていると、このイベントを選択します。**削除**で、**ディスプレイ フィルター**ウィンドウ。 USB のエラー フィルターに表示されたまま、**ディスプレイ フィルター**ペイン、およびを再適用できますが後でします。 フィルターが無効になっているようになりましたが、および**フレーム概要** ウィンドウでは、この図のようにすべてのイベントが表示されます。

![microsoft ネットワーク モニター](images/devicefailure-etl3.png)

2 つのイベント、CreateDeviceFailure の直前にログに記録される\_ポップアップ イベントがディスパッチと USB 制御転送を完了します。 **Fid\_し、USBPORT\_デバイス**ポート [パス] フィールドは転送のターゲットがルート ハブであることを示す 0 両方のイベント。 Fid で\_し、USBPORT\_URB\_コントロール\_ステータスの完了イベントの転送構造は、0 (USBD\_状態\_成功)、転送がしたことを示します成功しました。 前のイベントの検証を続行します。

上の次の 2 つのイベントは、4 番目の (最後) デバイスの作成失敗イベントと 4 番目 (最後) CreateDeviceFailure 例外について確認しました。

[次へ] の前のイベントは、エンドポイントを閉じる。 このイベントは、エンドポイントが有効でなくなったことを意味します。 イベント データは、そのデバイス上のデバイスとエンドポイントの両方について説明します。 デバイスのポート パス\[1、0、0、0, 0, 0\]します。 トレースしました、システムはさらに接続していたデバイスのみホスト コント ローラー (ルート ハブ) を持つため、このポートのパスでは、ハブについては説明しません。 閉じられたエンドポイントはプラグが差し込まれている 1 つのデバイス上に配置する必要があります、デバイスのパスは 1 であることようになりました。 ドライバーは、行われるデバイスのエンドポイントを前に検出された問題のためにアクセスできない可能性があります。 前のイベントの検証を続行します。

[次へ] の前のイベントは、完了した USB 制御転送します。 イベント データは、転送のターゲットのデバイス (ポートのパスは 1) を示しています。 Fid\_し、USBPORT\_エンドポイント\_記述子構造体は、エンドポイントのアドレスが 0 である、これは、USB で定義された既定のコントロール エンドポイントを示します。 URB 状態は、0xC0000004 です。 状態が 0 でないため、転送が成功したいない可能性があります。 詳細については、この USBD\_状態値を参照してください usb.h と[エラー イベントの概要と状態コード](#status-codes)。

```cpp
#define USBD_STATUS_STALL_PID ((USBD_STATUS)0xC0000004L)
```

意味:デバイスには、失速パケットの識別子が返されます。 どのような要求は、エンドポイントで停滞していますか。 イベント ログに記録されたその他のデータは、要求が、標準的なデバイス制御の要求をしたことを示します。 解析された要求を次に示します。

```cpp
  Frame: Number = 184, Captured Frame Length = 252, MediaType = NetEvent 
+ NetEvent: 
- MicrosoftWindowsUSBUSBPORT: Complete Internal URB_FUNCTION_CONTROL_TRANSFER 
  - USBPORT_ETW_EVENT_COMPLETE_INTERNAL_URB_FUNCTION_CONTROL_TRANSFER: Complete Internal URB_FUNCTION_CONTROL_TRANSFER 
   + fid_USBPORT_HC: 
   + fid_USBPORT_Device: 
   + fid_USBPORT_Endpoint: 
   + fid_USBPORT_Endpoint_Descriptor: 
   + fid_URB_Ptr: 0x84539008 
   - ControlTransfer: 
    + Urb: Status = 0xc0000004, Flags 0x3, Length = 0 
    - SetupPacket: GET_DESCRIPTOR 
     + bmRequestType: (Standard request) 0x80 
       bRequest: (6) GET_DESCRIPTOR 
       Value_DescriptorIndex: 0 (0x0) 
       Value_DescriptorType: (1) DEVICE 
       _wIndex: 0 (0x0) 
       wLength: 64 (0x40)
```

結合、bRequest (取得\_記述子) 値を持つ\_DescriptorType (デバイス) にして、要求が get デバイス記述子をしたことを確認できます。

USB 列挙を続行するには、デバイス、デバイス記述子とは、この要求に反応する必要があります。 代わりに、デバイスには、列挙が失敗する原因となった、要求が停滞しています。 そのため、4 つすべてのデバイスの作成エラーは、デバイスの記述子の停止要求によって発生しました。 デバイスが不明である列挙が失敗したためと、デバイスがそのデバイス記述子の要求を完了していないために、列挙が失敗したことを判断します。

## <a name="related-topics"></a>関連トピック
[USB の ETW を使用してください。](using-usb-etw.md)  
[Windows のイベント トレースは USB](usb-event-tracing-for-windows.md)  



