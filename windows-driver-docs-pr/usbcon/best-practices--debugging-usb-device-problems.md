---
Description: This topic provides tips for debugging USB device problems by using ETW events.
title: ETW イベントを使用して USB デバイスの問題のデバッグ
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: f416387697ba48af38bcff2921ec3d2592dd8b28
ms.sourcegitcommit: a33b7978e22d5bb9f65ca7056f955319049a2e4c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/31/2019
ms.locfileid: "56549646"
---
# <a name="debugging-usb-device-issues-by-using-etw-events"></a>ETW イベントを使用して USB デバイスの問題のデバッグ


このトピックでは、ETW イベントを使用して USB デバイスに関する問題をデバッグするためのヒントを提供します。

-   [デバイスの列挙体のエラーを診断します。](#diagnosing-device-enumeration-failures)
-   [デバイスの起動障害を診断します。](#diagnosing-device-start-failures)
-   [デバイスの挿入のタイミングのプロファイリング](#profiling-device-insertion-timing)
-   [デバイスのソフトウェアが開始したタイミングを再開します。](#software-initiated-device-resume-timing)
-   [デバイスのハードウェアが開始したタイミングを再開します。](#hardware-initiated-device-resume-timing)
-   [選択的からハブ再開中断のタイミング](#hub-resume-from-selective-suspend-timing)

## <a name="diagnosing-device-enumeration-failures"></a>デバイスの列挙体のエラーを診断します。


ほとんどのデバイス列挙の障害の根本原因を特定するには、USB ハブ列挙タスクに関連付けられている ETW イベントを使用することができます。

**USB ハブの列挙タスクに関連付けられているトレース ログにイベントを表示するには**

1.  Netmon を開き、「開始列挙体のポート」など、列挙型のイベントを探します。 クリックしてイベントを**フレーム概要**ウィンドウ。
2.  このイベントのタスクが返ったら USB ハブの列挙があることを確認、**タスク**イベントのフィールド。
    1.  **フレーム詳細**ウィンドウで、展開、 **Net イベント**、展開、**ヘッダー**、展開、**記述子**を見つけて、 **タスク**フィールド。
    2.  タスク フィールドに値 2 (USB ハブ列挙) が含まれていることを確認します。

3.  タスク値 2 を持つハブ ドライバーからのものだけを表示するイベントをフィルター処理します。
    1.  右クリックし、**タスク**フィールド。
    2.  選択**選択した値を追加**に**ディスプレイ フィルター**します。
    3.  内のイベントを右クリックし、**フレーム概要**ペイン**追加**に「プロトコル名」**ディスプレイ フィルター**します。
    4.  **ディスプレイ フィルター**ウィンドウで、変更するには、"OR""AND"。 次の例は、その結果のフィルターを示しています。
        ```cpp
        NetEvent.Header.Descriptor.Task == 0x2 AND ProtocolName == "USBHub_MicrosoftWindowsUSBUSBHUB"
        ```

        Netmon でフィルターを使用する方法については、「USB Netmon フィルター」を参照してください[ケース スタディ。ETW と Netmon を使用して不明な USB デバイスのトラブルシューティングを](case-study--troubleshooting-an-unknown-usb-device-by-using-etw-and-netmon.md)します。

## <a name="diagnosing-device-start-failures"></a>デバイスの起動障害を診断します。


デバイスがハブ ドライバーの中に起動に失敗した場合のデバイスの処理の I/O 要求パケット (IRP) を開始、エラーのトラブルシューティングを行うには、USB デバイス開始タスクに関連付けられている ETW イベントを使用することができます。 ネットワーク モニターでは、「USB デバイスを起動 IRP ディスパッチ」などのデバイス開始イベントを探します。 のみ 21 (USB デバイスの開始) のタスクの値を持つハブのドライバーからを表示するイベントをフィルター処理することができます。 このようなフィルターを作成する方法の詳細については、このトピックの「デバイス列挙の障害の診断」を参照してください。

## <a name="profiling-device-insertion-timing"></a>デバイスの挿入のタイミングのプロファイリング


時間を要している箇所ハブ ドライバーでデバイスの挿入中に列挙型のイベントのタイムスタンプを調べることで確認できます。

**列挙型のタイミング**

デバイスの挿入時間、デバイスを列挙するために使用されるハブのドライバーが、時間の部分は、次の 2 つのイベントの間で経過。

-   ポートの列挙を開始します。
-   完了ポートの列挙体

**タスクの列挙体のプロファイリング**

USB ハブのドライバーでは、デバイスを列挙する場合は、次の順序で次のイベントが記録されます。

-   ポートの列挙を開始します。
-   列挙体 Debounce が完了しました
-   PDO の列挙体の作成
-   最初の列挙体ポート リセットの完了
-   列挙型の完全な CreateDevice
-   列挙体のポートを 2 つ目のリセットの完了
-   列挙型の完全な InitializeDevice
-   列挙型の完全な SetupDevice
-   完了ポートの列挙体

列挙タスクごとにハブのドライバーの使用時間を確認するのには、上記のイベントまでの経過時間を計算します。
**IoInvalidateDeviceRelations と IRP の間の経過時間\_MN\_クエリ\_デバイス\_リレーション**

クエリ デバイス リレーション IRP の待機中に、システムが使用されるデバイスの挿入時の部分を確認するのには、次の 2 つのイベントまでの経過時間を測定します。

-   完了ポートの列挙体
-   USB ハブ クエリ デバイス リレーション (BusRelations) IRP のディスパッチ

**IRP の完了までの経過時間\_MN\_クエリ\_デバイス\_のリレーションと IRP\_MN\_開始\_デバイス**

デバイスの挿入、プラグ アンド プレイのマネージャーと開始 IRP の受信に新しい物理デバイス オブジェクト (PDO) を報告するまでの部分の決定に次の 2 つのイベント間の経過時間の測定します。

-   USB ハブ クエリ デバイス リレーション IRP の完了
-   USB デバイスのスタート IRP のディスパッチ

**IRP のタイミングを開始します。**

ハブのドライバーが IRP の開始の処理に費やされた時間を確認するのには、次の 2 つのイベントまでの経過時間を測定します。

-   USB デバイスのスタート IRP のディスパッチ
-   USB デバイスのスタート IRP の完了

## <a name="software-initiated-device-resume-timing"></a>デバイスのソフトウェアが開始したタイミングを再開します。


デバイスの機能のドライバーでは、中断状態からデバイスを再開するには、D0 デバイス電源要求を送信できます。 中断から再開して、転送要求の準備ができるデバイスの時刻の必要な量を確認するのには、次の 2 つのイベントまでの経過時間を測定します。

-   USB デバイス セット D0 デバイス電源 IRP のディスパッチ
-   USB デバイス セット D0 デバイス電源 IRP の完了

## <a name="hardware-initiated-device-resume-timing"></a>デバイスのハードウェアが開始したタイミングを再開します。


再開のシグナルをバスには、中断状態から再開するデバイスをによりします。 転送要求の準備完了状態を再開するデバイスの時刻の必要な量を確認するのには、次の 2 つのイベントまでの経過時間を測定します。

-   親のハブが中断されることはありません。
    -   USB デバイス待機ウェイク IRP の完了
    -   USB デバイス セット D0 デバイス電源 IRP の完了
-   親のハブが中断されます。
    -   再開のハブをセレクティブ サスペンドから開始 (デバイスとホスト コント ローラー間のいずれかのハブのこれらのイベントの最初の)
    -   USB デバイス セット D0 デバイス電源 IRP の完了

## <a name="hub-resume-from-selective-suspend-timing"></a>選択的からハブ再開中断のタイミング


選択的から再開するハブの時間の必要なサイズを判断することができます、次の 2 つのイベントまでの経過時間を測定することによって一時中断します。

-   選択的からハブの再開を中断します。
-   完了したハブの再開

**注**  ハブ再開タイミングは、ハブの下のすべてのデバイスと可能性がある一部またはすべてが再開されたハブ上ハブの再開のタイミングによって異なります。

 

## <a name="related-topics"></a>関連トピック
[Windows のイベント トレースは USB](usb-event-tracing-for-windows.md)  



