---
Description: Guidelines for choosing the best driver model for developing a USB client driver that acts as the device's function driver.
title: USB ドライバーを開発するためのドライバー モデルを選択します。
ms.date: 05/09/2018
ms.localizationpriority: medium
ms.openlocfilehash: 86e7f84cfe9b766beb4a0cd7c59d8089f8dd19e6
ms.sourcegitcommit: a33b7978e22d5bb9f65ca7056f955319049a2e4c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/31/2019
ms.locfileid: "56528103"
---
# <a name="choosing-a-driver-model-for-developing-a-usb-client-driver"></a>USB クライアント ドライバーを開発するためのドライバー モデルの選択


このトピックでは、デバイスの機能のドライバーとして機能する USB クライアント ドライバーを開発するための最適なドライバー モデルを選択するためのガイドラインを提供します。

USB デバイス製造元では、アプリケーション、デバイスの機能にアクセスするための手段を提供する必要があります多くの場合。 USB デバイスにアクセスするための最適なメカニズムを選択するには、最も簡単な方法で開始し、必要がある場合にのみより複雑なソリューションに移動します。 次の一覧は、このトピックで説明する選択肢をまとめたものです。

1.  デバイスが Windows に付属している受信トレイのドライバーを USB デバイス クラスに所属している場合は、ドライバーを作成する必要はありません。
2.  場合は、デバイスには、Microsoft 提供のクラス ドライバーはありません。 デバイスは 1 つのアプリケーションによってアクセスが、関数のドライバーとして WinUSB を読み込みます。
3.  同時実行アプリケーションがアクセスする必要がある、デバイス、デバイスにアイソクロナス エンドポイントが設定されていない場合は、UMDF ベースのクライアント ドライバーを記述します。
4.  場合クラス ドライバー、WinUSB、または UMDF ソリューションでは、オプション KMDF ベースのクライアント ドライバーを記述します。
5.  KMDF によって、特定の機能がサポートされていない場合は、WDM ルーチンを呼び出すハイブリッド ドライバーを作成します。

最も一般的なアプローチは、デバイス ドライバーを実装するようにしています (としてと呼ばれる、 *USB クライアント ドライバー*このドキュメントでは次のように設定します) デバイス スタックを上記の関数のドライバーとしてドライバーをインストールするインストール パッケージを提供し、。Microsoft 提供の USB ドライバー スタックです。 クライアント ドライバーでは、デバイスのファイル ハンドルを取得するアプリケーションが使用できるデバイスのインターフェイスを公開します。 アプリケーションは、Windows Api を呼び出すことによって、ドライバーとの通信にこのファイルのハンドルを使用できます。

USB デバイスへのアクセスを提供する最も柔軟な方法は、デバイスの要件にカスタマイズされているドライバーを記述します。 ただし、ドライバーを実装するには、多くの作業が必要です。 ドライバーは、デバイスが削除されたときに新しいデバイスが検出された、電源管理、I/O 操作、突然の取り外し、状態管理、およびクリーンアップのドライバーの初期化などの複雑なタスクを実行する必要があります。 ドライバーを記述することを選択する前に、次の質問をください。

-   [Microsoft 提供のドライバーを使用できますか。](#can-you-use-a-microsoft-provided-driver)
-   [USB クライアント ドライバーを作成する場合は、どのドライバー モデルをお勧めしますか。](#if-you--write-a-usb-client-driver--which-driver-model-is-best-)

## <a name="can-you-use-a-microsoft-provided-driver"></a>Microsoft 提供のドライバーを使用できますか。


可能性があります*いない*場合、ドライバーを作成する必要があります。

-   デバイスは、Microsoft でサポートされている USB デバイス クラスに属しています。

    その場合は、デバイス ドライバーとしてクラスに対応するドライバーが読み込まれます。 Windows に付属している受信トレイのドライバーのデバイス クラスの一覧は、次を参照してください。 [USB デバイス クラス ドライバーが Windows に含まれる](supported-usb-classes.md)します。

-   デバイスはデバイス クラスに属していません。

    このようなデバイスの場合、Microsoft から提供されたを読み込むことができるかどうかを判断するデバイスの機能を評価[WinUSB](winusb.md) (Winusb.sys) デバイスの機能のドライバーとして。 WinUSB を使用すると、場合に最適なソリューションです。

    -   デバイスは、1 つのアプリケーションによってアクセスされます。
    -   デバイスには、一括、割り込み、またはアイソクロナス エンドポイントがサポートしています。
    -   デバイスが Windows XP Service Pack 2 (SP2) および以降のバージョンの Windows を実行して、ターゲット コンピューターを操作するためのものです。

    WinUSB 関数ドライバーとして読み込むカスタム USB ドライバーを実装するのには同じことを提供します。 たとえば、WinUSB は、デバイスにパッケージ化されているアプリケーションによってのみアクセスされる電子の気象観測計の推奨されるアプローチです。 また、デバイスとの通信を診断およびファームウェアの点滅と便利です。

    Winusb.sys に要求を送信するアプリケーションを簡単に提供を公開するには、Winusb.dll、ユーザー モード DLL [WinUSB functions](https://msdn.microsoft.com/library/windows/hardware/ff540046#winusb)します。 アプリケーションでは、デバイスへのアクセス、構成、およびデバイスのエンドポイントへのデータ転送にこれらの関数を呼び出すことができます。

    WinUSB は場合、オプションではありません。

    -   デバイスは、複数のアプリケーションによってアクセスされます。
    -   デバイスでは、カーネル モードの Windows オペレーティング システムでサポートされている関数があります。 たとえば、モデム関数 (ある TAPI をサポートしています) または LAN 関数 (ある NDIS をサポートしています) は、ユーザー モード ソフトウェア モデム デバイスを管理する Usbser.sys ドライバーをサポートするインターフェイスを使用する必要があります。

    Windows 8 の新しい互換性 ID WinUSB インストールの INF に追加されました。 デバイスのファームウェアに互換性のあるその ID が含まれている場合は、デバイスの機能のドライバーとして既定で WinUSB が読み込まれます。 これは、ハードウェアの製造元が、WinUSB デバイスの INF ファイルを配布する必要はないことを意味します。 詳細については、次を参照してください。 [WinUSB デバイス](automatic-installation-of-winusb.md)します。

## <a name="if-you-write-a-usb-client-driver-which-driver-model-is-best"></a>USB クライアント ドライバーを作成する場合は、どのドライバー モデルをお勧めしますか。


答えは、デバイスの設計に依存します。 最初に、特定のドライバー モデルがお客様の要件を満たすかどうかを決定します。 いくつかの設計に関する考慮事項は、USB デバイスへのアクセスを複数の同時実行アプリケーションとアイソクロナス エンドポイント経由のストリーミング データをサポートするかどうかに基づいています。

ドライバーを作成する場合は、次のオプションに示します。

-   [ユーザー モード ドライバー フレームワーク](https://docs.microsoft.com/windows-hardware/drivers/wdf/)(UMDF)

    UMDF では、デバイス ドライバー インターフェイス (Ddi) クライアント ドライバーを使用して、プラグ アンド プレイのマネージャーと電源マネージャーなどの Windows コンポーネントとの統合を提供します。 UMDF には、USB デバイス、ユーザー モードでのハードウェアを抽象化し、ドライバーの I/O 操作を簡略化するための特殊化されたターゲット オブジェクトも提供します。 UMDF インターフェイスに加えて WDF 提供強化されたデバッガーの拡張機能とトレース ツール ユーザー モード ドライバー用です。 UMDF はコンポーネント オブジェクト モデル (COM) に基づいており、C++ 開発者を簡単には、ユーザー モード ドライバーを開発します。

    次のような場合に、USB デバイスの UMDF ベースのクライアント ドライバーを実装します。

    -   デバイスは、複数のアプリケーションで同時にによってアクセスされます。
    -   デバイス サポート一括または割り込み転送します。

    ユーザー モードで実行されているドライバーでは、(仮想) のユーザーのアドレス空間のみにアクセスでき、システムにはるかに低いリスクが発生することができます。 カーネル モード ドライバーは、システム アドレス空間と内部システム構造体にアクセスできます。 正しくないコード化されたカーネル モード ドライバーは、他のドライバーや、システムに影響する問題が発生し、最終的に、コンピューターがクラッシュする可能性があります。 そのため、ユーザー モード ドライバーはセキュリティと安定性の観点からカーネル モード ドライバーよりも安全にできます。

    ユーザー モード ドライバーのもう 1 つの利点は、すべての Win32 Api が活用できます。 たとえば、ドライバーは、Winsock、圧縮、暗号化 Api などの Api を呼び出すことができます。 これらの Api では、カーネル モード ドライバーを使用できません。

    UMDF ベースのクライアント ドライバーは USB デバイス アイソクロナス エンドポイントをサポートするためのオプションではありません。

    **注**  Windows 8.1 UMDF のバージョン 2.0 が導入されています。 バージョン 2.0、UMDF に多くの KMDF ドライバーを使用できるメソッドを呼び出し、C プログラミング言語で UMDF ドライバーを記述できます。 UMDF version 2.0 を使用して、USB の低いフィルター ドライバーを記述することはできません。

     

-   [カーネル モード ドライバー フレームワーク](https://docs.microsoft.com/windows-hardware/drivers/wdf/)(KMDF)

    KMDF は新しい種類のハードウェアをサポートするために拡張するドライバー モデルを簡単に設計されています。 KMDF は、Ddi とカーネル モードの USB ドライバーを Windows Driver Model (WDM) ドライバーを以前より簡単に実装するデータ構造を提供します。 さらに、KMDF Microsoft USB ドライバー スタックを使用する完全に機能しているクライアント ドライバーの記述に使用できる特殊な入力/出力 (I/O) ターゲットを提供します。

    特定の機能を KMDF を使用しない場合、ドライバーは WDM ルーチンを呼び出す必要があります。 ドライバーは、WDM インフラストラクチャ全体を実装する必要はありませんが、選択された一連の WDM ルーチンにアクセスする KMDF メソッドを使用します。 たとえば、アイソクロナス転送を実行する KMDF ベースのクライアント ドライバーは、USB ドライバー スタックへの要求を記述する WDM スタイルの翻訳を送信できます。 このようなドライバーが呼び出されて*ハイブリッド ドライバー*このドキュメントで設定します。

    KMDF には、ポート ミニポート ドライバー モデルもサポートしています。 たとえば、上端にストリーミングするカーネルを使用するミニポート ドライバー (USB web カメラ) などのストリーミング カーネルでは、USB ドライバー スタックに要求を送信するのに KMDF の USB I/O ターゲット オブジェクトを使用できます。 NDIS ドライバーは、USB などのプロトコルに基づくバス KMDF を使用して書き込むこともできます。

    純粋な WDM ドライバーは、簡単ではありません、複雑でない堅牢なは。 KMDF の進化、この種類のドライバーを記述する必要はなくなりました。

Microsoft Visual Studio 2012 を含む**USB ユーザー モード ドライバー**と**USB カーネル モード ドライバー**それぞれ UMDF および KMDF の USB クライアント ドライバーのスターター コードを生成するテンプレート。 テンプレート コードでは、ハードウェアとの通信を有効にするには、USB ターゲット デバイス オブジェクトを初期化します。 詳しくは、次のトピックをご覧ください。
-   [最初、USB クライアント ドライバー (UMDF) の記述します。](implement-driver-entry-for-a-usb-driver--umdf-.md)
-   [最初、USB クライアント ドライバー (KMDF) の記述します。](tutorial--write-your-first-usb-client-driver--kmdf-.md)

UMDF および KMDF ドライバーを実装する方法については、Microsoft Press の書籍を参照してください。 *、Windows Driver Foundation でのドライバーの開発*します。

## <a name="winusb-umdf-kmdf-feature-comparison"></a>WinUSB、UMDF、KMDF 機能の比較


次の表では、WinUSB、UMDF に基づく USB ドライバー、および KMDF ベースの USB ドライバーの機能をまとめたものです。

| 機能                                                                                                          | WinUSB | UMDF | KMDF |
|------------------------------------------------------------------------------------------------------------------|--------|------|------|
| 複数の同時実行アプリケーションをサポートしています                                                                        | X     | 〇  | 〇  |
| アプリケーションのアドレス空間からのアドレス空間のドライバーを分離します。                                                     | X     | 〇  | X   |
| 一括のサポート、割り込み、およびコントロールの転送                                                                  | 〇    | 〇  | 〇  |
| アイソクロナス転送をサポートしています                                                                                   | ⁴ を [はい] します。  | X   | 〇  |
| USB スタックの上位レイヤーとしてフィルター ドライバーなどのカーネル モード ドライバーのインストールをサポートしています | X     | X   | 〇  |
| 選択的なサポートを中断し、待機/ウェイク状態                                                               | 〇    | 〇  | 〇  |

 

次の表は、さまざまなバージョンの Windows でサポートされている WDF オプションをまとめたものです。

| Windows のバージョン        | WinUSB | UMDF | KMDF |
|------------------------|--------|------|------|
| Windows 8              | 〇    | 〇  | 〇  |
| Windows 7              | 〇    | 〇  | 〇  |
| Windows Vista          | Yes¹   | Yes¹ | 〇  |
| Windows Server 2003    | X     | X   | 〇  |
| Windows XP             | Yes²   | Yes² | 〇  |
| Microsoft Windows 2000 | X     | X   | Yes³ |

 

**注**   Yes¹:WinUSB と UMDF は、Windows の x86 ベースおよび x64 ベースのバージョンでのみサポートされます。

Yes²:WINUSB と UMDF は、Windows XP Service Pack 2 (SP2) または以降のバージョンの Windows でサポートされます。

Yes³:KMDF は、Windows 2000 SP4 または以降のバージョンの Windows でサポートされます。

Yes⁴:アイソクロナス転送は、Windows 8.1 または Windows の以降のバージョンでサポートされます。

 

Windows XP SP2support WinUSB の 32 ビット バージョンのすべてのクライアント Sku。 WinUSB は Windows XP; にネイティブではありません。WinUSB 共同インストーラーによるインストールがあります。 すべての Windows Vista Sku と以降のバージョンの Windows WinUSB をサポートします。

## <a name="related-topics"></a>関連トピック
[USB クライアント ドライバー開発を入門](getting-started-with-usb-client-driver-development.md)  
[WinUSB](winusb.md)  
[最初、USB クライアント ドライバー (UMDF) の記述します。](implement-driver-entry-for-a-usb-driver--umdf-.md)  
[最初、USB クライアント ドライバー (KMDF) の記述します。](tutorial--write-your-first-usb-client-driver--kmdf-.md)  



