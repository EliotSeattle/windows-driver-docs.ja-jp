---
Description: このトピックでは、まず、U1 および U2 遷移を有効にするためにソフトウェアによって実行される最初のセットアップについて説明し、次に、ハードウェアでのこれらの移行のしくみについて説明します。
title: U1 と U2 の移行
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 3e8cc5f049fcc6da78c0fb140f81e7bcece05522
ms.sourcegitcommit: b316c97bafade8b76d5d3c30d48496915709a9df
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/13/2020
ms.locfileid: "79242751"
---
# <a name="u1-and-u2-transitions"></a>U1 と U2 の移行


このトピックでは、まず、U1 および U2 遷移を有効にするためにソフトウェアによって実行される最初のセットアップについて説明し、次に、ハードウェアでのこれらの移行のしくみについて説明します。

## <a name="initial-setup-by-software"></a>ソフトウェアによる初期セットアップ


このトピックでは、ソフトウェアがデバイスを列挙する方法について説明します。

U1 または U2 遷移が発生すると、ソフトウェアはデバイスの列挙中に次の手順を実行します。

1.  ソフトウェア交換 U1 または U2 は、列挙プロセス中にデバイスとの待機時間情報を終了します。 この交換の最初の部分として、デバイス固有の待機時間は、デバイスが SuperSpeed USB デバイス機能の bU1DevExitLat フィールドと wU2DevExitLat フィールドに格納されます (USB 3.0 仕様のセクション9.6.2.2 で定義されています)。 交換の2番目の部分として、ホストは、USB 3.0 仕様のセクション9.4.12 に従って SET\_SEL コントロール転送を送信することによって、デバイスの終了待機時間の合計をデバイスに通知します。 待機時間の情報には、上流のリンクとコントローラーに関連付けられている待ち時間が含まれます。
2.  このソフトウェアは、デバイスが接続されている DS ポートに対して、ポート\_U1\_TIMEOUT とポート\_U2\_タイムアウトの2つの値を構成します。 これらの値を決定する際、ソフトウェアはデバイスの特性 (エンドポイントの種類など) と、デバイスを U1 または U2 から U0 に戻すことに関連付けられている待機時間を考慮します。 次の表では、タイムアウト値について説明します。

    **表 1.ポート\_U1\_タイムアウトとポート\_U2\_タイムアウト値**

    | 値   | 説明                                                                                                                                                                                                                  |
    |---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | 01H-ファー | DS ポートは、非アクティブな状態が一定期間続くと、移行を開始する必要があります。 正確な期間は、タイムアウト値から取得されます。 ポートは、保留中のトラフィックがない限り、リンクパートナーによって開始される遷移を受け入れる必要があります。 |
    | FFH     | DS ポートは遷移を開始することはできませんが、保留中のトラフィックがある場合を除き、リンクパートナーによって開始される遷移を受け入れる必要があります。                                                                                    |
    | 0       | DS ポートは遷移を開始することはできず、リンクパートナーによって開始された遷移を受け入れることはできません。                                                                                                                |

     

3.  \_U2\_タイムアウト値が 01H-ファーの間にある場合は、手順 2. の結果として、ハードウェアに追加の手順が実行されます。 DS ポートは、その値についてリンクパートナーに通知します。 この手順の重要性については、「U1 から U2 への直接の移行」を参照してください。
4.  このソフトウェアでは、デバイスまたはハブごとに2つの値を構成します。 U1\_ENABLE と U2\_、SET\_機能を送信することによって有効にします (U1\_ENABLE/U2\_ENABLE) 制御転送です。 次の表では、これらの値について説明します。

    **表 2.U1\_ENABLE と U2\_有効な値**

    | 値    | 説明                                                                                                                       |
    |----------|-----------------------------------------------------------------------------------------------------------------------------------|
    | 有効  | 米国ポートは、デバイスポリシーによって許可されている場合に、リンクパートナーによって開始される遷移を開始し、遷移を受け入れることができます。 |
    | 無効 | 米国ポートでは遷移を開始することはできませんが、リンクパートナーによって開始される遷移を受け入れることができます。                          |

     
## <a name="hardware-transitions"></a>ハードウェアの移行


このトピックでは、U1 と U2 へのハードウェアの移行について説明します。

ソフトウェアによる初期セットアップの後、ハードウェアは、ソフトウェアからの介入なしに、U1 と u2 に自律的に移行します。

リンクは、パケットがアクティブに転送されている限り、作業中の状態 (U0) にあります。 パケットが送信されていない場合、リンクはアイドル状態と見なされます。 アイドル状態の場合、リンクパートナーは、U1 または U2 への移行を開始できます。 もう一方のリンクパートナーは、切り替え効果を受け入れるか拒否するかを選択できます。 リンクパートナーが遷移を受け入れると、リンクはその U 状態に移行します。 移行が拒否された場合、リンクは U0 に残ります。

### <a name="ds-port-initiated-transitions"></a>DS ポートで開始された遷移


DS ポートは、ポートの非アクティブ状態を追跡するタイマー機構を実装します。 タイマーは、そのポートがパケットを送信または受信するたびにリセットされます。 また、タイマーは、ソフトウェアプログラムによって新しいタイムアウト値が設定されたときにリセットされます。 ソフトウェアによって、U1 または U2 の遷移のみを開始するように DS ポートがプログラミングされている場合、リンクが最初に U0 に入ったときに、DS ポートがタイマーを開始します。 タイマーの値は、ソフトウェアによってプログラムされた U1 (または U2) のタイムアウト値に基づいています。 タイマーの有効期限が切れたときにリンクが U0 にある場合、DS ポートは U1 (または U2) 遷移を開始します。

デバイスがパフォーマンスや待機時間の要件を満たすデバイスの能力に影響を与える可能性があることがデバイスで認識されている場合、米国のポートリンクパートナーは移行を拒否することを選択できます。 たとえば、デバイスが ERDY 通知を送信し、ホストからの転送要求を予期している場合、デバイスは、その間に U1 または U2 の状態遷移を拒否する可能性があります。

ソフトウェアによって、U1 と U2 の両方の遷移を開始するように DS ポートがプログラミングされている場合、DS ポートはまず、タイマーに基づいて U1 遷移を開始します (このセクションで既に説明しました)。 U1 から U2 への移行については、このトピックの「 **u1 から u2 への直接移行**」で説明されています。

リンクが U1 または U2 内にある場合、ポートに接続されているデバイスのトラフィックを受信するたびに、DS ポートがポートを U0 に戻すことができます。

### <a name="device-us-port-initiated-transitions"></a>デバイス (US ポート) で開始された遷移


デバイスは、この機能がソフトウェアによって有効になっている限り、U0 から U1 または U0 から U2 への移行を開始することを選択できます。 デバイスが U1 へのリンクを移行する場合、リンクは、DS ポートの U2 タイマーに基づいて直接 U2 に移行できます (「U1 から U2 への直接移行」を参照してください)。 ただし、U2 タイマーが設定されていない場合、デバイスは、U1 から U2 への直接遷移を独自に開始することはできません。 この場合、デバイスは、U2 への移行を開始する前に、U0 へのリンクを戻す必要があります。

デバイスは、これらの遷移を開始するタイミングを決定する際に、終了の待機時間とパフォーマンスの要件を考慮する必要があります。 デバイスが遷移をどの程度積極的に開始できるかについての意思決定を支援するために、ソフトウェアでは、このドキュメントで前述した「ソフトウェアによる初期セットアップ」で説明したさまざまな終了待機時間の値も提供します。

リンクが U1 または U2 にある場合、米国のポートは、いつでもポートを U0 に戻すことができます。 通常、US ポートは、ホストにパケットを送信しようとしていることを認識している場合、またはホストからパケットを予測している場合に、U0 への移行を開始します。

### <a name="advantages-of-device-initiated-lpm"></a>デバイスによって開始される LPM の利点


DS ポート用にソフトウェアによって設定されるタイマー値は、一般的なヒューリスティックに基づいています。 これらのタイマー値を選択すると、ソフトウェアによって、デバイスのパフォーマンスが損なわれないようにすることができます。 デバイスのパフォーマンスを維持するために、ソフトウェアでは小さすぎる値を選択することはできません。 DS ポートで開始される移行はタイマーに基づいており、デバイスの正確な状態を考慮しないため、このメカニズムでは、デバイスを U1 または U2 状態に送信する可能性があるすべての機会を利用することはできません。

一方、デバイスには、その特性と現在の状態に関する正確な知識があります。 そのため、次の転送が行われるタイミングについて、インテリジェントな推測を行うことができます。 デバイスでは、その情報に基づいて、パフォーマンスに大きな影響を与えずに、これらの遷移をアクティブに開始することを選択できます。

たとえば、デバイスは、そのエンドポイントの1つに NRDY 通知を送信し、しばらくの間トラフィックがないことを認識しています。 その場合、デバイスは U1 または U2 への移行を直ちに開始できます。 デバイスは、ERDY 通知を送信する直前に、そのデータを送信するための準備として、リンクを U0 に戻すことができます。 このプロセスの詳細については、USB 3.0 仕様の「C. 3.1」を参照してください。

## <a name="direct-transition-from-u1-to-u2"></a>U1 から U2 への直接移行


リンクが U1 にある場合は、リンクを U0 に入力せずに、U2 に直接移行できる可能性があります。 これは、U1 への移行を開始したリンクパートナーに関係なく発生する可能性があります。 ただし、U2 への移行が行われるのは、リンクの DS ポートの U2 タイムアウトが 01H-ファーの値に設定されている場合のみです。

「ソフトウェアによる初期セットアップ」セクションでは、DS ポートがタイムアウト値をリンクパートナーに通知できるようにする追加の手順について説明します。 リンクが U1 に入った後、両方のリンクパートナーは、DS ポートの U2 タイムアウト値に従って設定されたタイムアウト値を使用してタイマーを開始します。 トラフィックが原因でタイマーがリセットされず、有効期限が切れた場合、両方のリンクパートナーは、その間に明示的な通信を行わずに、自動的に U2 に移行します。

### <a name="transitions-from-u1-or-u2-to-u3"></a>U1 または U2 から U3 への移行


U1 または U2 への移行はハードウェアで自律的に開始されますが、U3 への移行はソフトウェアによって開始されます。 U3 遷移は、非アクティブな期間が経過した後にのみ開始されるため、移行の前に、リンクが U1 または U2 (U0 ではなく) にある可能性があります。

USB 3.0 仕様では、U1 または U2 から U3 への直接遷移は定義されていません。 親ハブまたはコントローラーは、リンクを自動的に U0 に移行してから U3 に移行する役割を担います。

### <a name="u1-or-u2-transitions-for-hubs"></a>ハブの U1 または U2 の移行


USB 3.0 仕様では、US ポートで U 状態遷移を開始するタイミングについて、ハブに関する特定のガイドラインを提供しています。 すべての DS ポートがリンク状態 U1 以下である場合、ハブは、ソフトウェアが U1 遷移を開始するハブを有効にしたと仮定して、US ポートで U1 遷移を開始する必要があります。

同様に、すべての DS ポートがリンク状態 U2 以下である場合、ハブは、ソフトウェアが U2 遷移を開始するためにハブを有効にしたと仮定して、US ポートで U2 遷移を開始する必要があります。

**注**   DS ポートにデバイスが接続されていない場合は、ポートの状態が Rx. 検出であり、U2 よりも低いことに注意してください。 デバイスが接続されていない場合、ハブは、その米国のポートを U2 に送信します。 また、すべての DS ポートが、最初は U1 以下であり、U2 以下に移行する場合、ハブは US ポートを U1 から U2 に移行する必要があります。 この遷移は、U2 アクティビティタイマーに基づいていないため、ハブは US ポートを U0 にしてから U2 に送信する必要があります。

 

## <a name="packet-deferring"></a>パケットの遅延


USB 3.0 仕様では、パケットの遅延と呼ばれるメカニズムが記述されています (「1.2.2」を参照してください)。 このメカニズムは、バスの使用率に対する LPM の影響を最小限に抑えるために使用されます。

ホストがデバイスに転送要求を送信し、そのアップストリームリンクが U1 または U2 にある場合、ホストは、リンクが U0 に戻って、デバイスが応答するまで待機することで、バス帯域幅を無駄にする可能性があります。 この待機を避けるために、親ハブは、遅延パケットヘッダーをホストに送信することによって、デバイスの代わりに応答します。 ホストは NRDY と同様の方法で遅延パケットヘッダーを処理し、その後、他のエンドポイントとの転送を開始します。 同時に、ハブはリンクの U0 遷移を開始し、遅延パケットについてデバイスに通知します。 デバイスは、デバイスの転送準備ができたことを示すために、ホストに ERDY を送信します。 その後、ホストはデバイスへの転送を再スケジュールすることができます。

デバイスの重要な役割は、ERDY を送信した後、ホストが ERDY に応答を送信するか、 **Terdytimeout** (500 ミリ秒) の時間が経過するまで、デバイスがリンクを U0 に保持することです。 その間、デバイスは U1 または U2 遷移を開始せず、リンクパートナーによって開始された移行も拒否する必要があります。

 

 
 

 

 




