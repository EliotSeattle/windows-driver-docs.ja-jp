---
Description: This topic provides an overview of the Universal Serial Bus (USB) driver stack architecture.
title: Windows での USB ホスト側のドライバー
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 31e021cffe443cab922140fab6d5c5c32af6460d
ms.sourcegitcommit: a33b7978e22d5bb9f65ca7056f955319049a2e4c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/31/2019
ms.locfileid: "56551957"
---
# <a name="usb-host-side-drivers-in-windows"></a>Windows での USB ホスト側のドライバー


このトピックでは、ユニバーサル シリアル バス (USB) ドライバー スタックのアーキテクチャの概要を示します。

次の図は、Windows 8 の USB ドライバー スタックのアーキテクチャ ブロック図を示します。 図には、USB 2.0 と USB 3.0 用の別の USB ドライバー スタックを示します。 Windows では、デバイスが xHCI コント ローラーに関連付けられている場合に、USB 3.0 ドライバー スタックが読み込まれます。 USB 3.0 スタックは、Windows 8 の新機能です。

Windows では、eHCI や oHCI、uHCI コント ローラーに接続されているデバイスの USB 2.0 ドライバー スタックが読み込まれます。 USB 2.0 ドライバー スタックは、Windows XP Service Pack 1 (SP1) および以降のバージョンの Windows オペレーティング システムに付属しています。

![usb 2.0 および 3.0 ドライバー スタックのアーキテクチャ ブロック図](images/usb-driver-stack-3.png)

-   [USB 3.0 ドライバー スタック](#usb-3-0-driver-stack)
    -   [USB 3.0 ホスト コント ローラー ドライバー (Usbxhci.sys)](#usb-3-0-host-controller-driver--usbxhci-sys)
    -   [USB ホスト コント ローラーの拡張機能 (Ucx01000.sys)](#usb-host-controller-extension--ucx01000-sys)
    -   [USB ハブのドライバー (Usbhub3.sys)](#usb-hub-driver-usbhub3-sys)
-   [USB 2.0 ドライバー スタック](#usb-2-0-driver-stack)
-   [USB 共通クラス ジェネリック親ドライバー (Usbccgp.sys)](#usb-common-class-generic-parent-driver--usbccgp-sys--)
-   [WinUSB (Winusb.sys)](#winusb-winusb-sys)
-   [USB クライアント ドライバー](#usb-client-driver)
-   [クライアント ドライバー用のヘルパー ライブラリ](#helper-libraries-for-client-drivers)
-   [関連トピック](#related-topics)

## <a name="usb-30-driver-stack"></a>USB 3.0 ドライバー スタック


USB 3.0 スタックは、Windows 8 の新機能です。 Microsoft では、カーネル モード ドライバー フレームワーク (KMDF) インターフェイスを使用して、新しいドライバーを作成します。 KMDF ドライバー モデルは、複雑さを軽減し、安定性が向上します。

### <a href="" id="usb-3-0-host-controller-driver--usbxhci-sys"></a>USB 3.0 ホスト コント ローラー ドライバー (Usbxhci.sys)

XHCI ドライバーは、USB 3.0 ホスト コント ローラー ドライバーです。 XHCI ドライバーの役割は、転送要求のブロックを上位レイヤー ドライバーからのマッピングの転送を要求 MMIO レジスタと xHCI コント ローラーのハードウェアには、ホストのメモリ ベースのデータ構造体の初期化とに要求を送信しますハードウェア。 転送を完了するは、ドライバーは、ハードウェアから転送の完了イベントを処理し、ドライバー スタックの上位イベントを伝達します。 また、xHCI コント ローラー デバイスのスロットとエンドポイント コンテキストを制御します。

XHCI ドライバーは、Windows 8 の新機能は以前のバージョンのオペレーティング システムで使用可能だった eHCI ミニポート ドライバーの拡張機能ではありません。 新しいドライバーは、カーネル モード ドライバー フレームワーク (KMDF) インターフェイスを使用して作成し、すべてのコント ローラーの電源管理と PnP イベント KMDF を使用します。 Windows では、ホスト コント ローラーに対するデバイス スタックの関数のデバイス オブジェクト (FDO) として xHCI ドライバーを読み込みます。

### <a href="" id="-usb-host-controller-extension--ucx01000-sys--"></a> USB ホスト コント ローラーの拡張機能 (Ucx01000.sys)

USB ホスト コント ローラー拡張機能ドライバー (KMDF 拡張機能) とは、xHCI ドライバーなど、基になるクラスに固有のホスト コント ローラー ドライバーに新しい拡張機能です。 新しいドライバーは、拡張可能なホスト コント ローラーのドライバーを開発する今後の予想されるは、他の種類をサポートするためには設計されています。 USB ホスト コント ローラー拡張機能では、ハブのドライバーに共通の抽象化されたインターフェイスが汎用ホスト コント ローラーのドライバーに要求をキュー メカニズムを提供し、選択した特定の関数をオーバーライドとして機能します。 すべての I/O 要求は、xHCI ドライバーの前に、ホスト コント ローラーの拡張機能ドライバーをドライバーが上限に到達によって開始されます。 I/O 要求を受信するとは、ホスト コント ローラーの拡張機能は、要求を検証しますし、し、ターゲット エンドポイントに関連付けられた、適切な KMDF キューに要求を転送します。 XHCI ドライバーでは、処理のための準備ができたら、キューから要求を取得します。 USB ホスト コント ローラーの拡張機能ドライバーの役割は次のとおりです。

-   XHCI ドライバーを USB に固有のオブジェクトを提供します。
-   XHCI ドライバーに KMDF イベント コールバック ルーチンを提供します。
-   管理し、ホスト コント ローラーに関連付けられているルート ハブの操作を制御します。
-   チェーンの MDLs、ストリーム、およびなどのクライアント ドライバーで構成可能な機能を実装します。

### <a href="" id="usb-hub-driver-usbhub3-sys"></a>USB ハブのドライバー (Usbhub3.sys)

新しいハブ ドライバー 3.0 のデバイスの USB ドライバー スタックで、KMDF ドライバー モデルは使用します。 ハブのドライバーは、主に、これらのタスクを実行します。

-   USB ハブおよびそのポートを管理します。
-   デバイスと、ダウン ストリームのポートに接続されているその他のハブを列挙します。
-   列挙されたデバイスとハブの物理デバイス オブジェクト (Pdo) を作成します。

Windows では、ハブのデバイス スタックで FDO としてハブのドライバーを読み込みます。 デバイスの列挙とハブの管理、新しいドライバーでは、ステート マシンのセットを通じて実装されます。 ハブのドライバーは、電源管理と PnP 関数 KMDF に依存します。 ハブのドライバー ハブの管理機能に加えて、予備のチェックと USB クライアント ドライバーのレイヤーから送信された特定の要求の処理も実行します。 たとえば、ハブのドライバーは、要求で構成されるエンドポイントを決定する select 構成要求を解析します。 情報を解析するには後、は、ハブのドライバーは、USB ホスト コント ローラーの拡張機能またはさらに処理する要求を送信します。

## <a name="usb-20-driver-stack"></a>USB 2.0 ドライバー スタック


Windows では、eHCI や oHCI、uHCI コント ローラーに接続されているデバイスの USB 2.0 ドライバー スタックが読み込まれます。 USB 2.0 ドライバー スタックのドライバーは、Windows XP SP1、および以降のバージョンの Windows オペレーティング システムに付属します。 USB 2.0 ドライバー スタックは、USB 2.0 仕様で定義されている高速の USB デバイスを容易に設計されています。

USB の下部にあるドライバー スタックは、ホスト コント ローラー ドライバーです。 ポート ドライバー、Usbport.sys、および 1 つまたは複数同時に実行される 3 つのミニポート ドライバーで構成されます。 ホスト コント ローラーのハードウェアが検出されると、これらのミニポート ドライバーのいずれかを読み込みます。 ミニポート ドライバーが読み込まれた後は、ポート ドライバー、Usbport.sys を読み込みます。 ポート ドライバーは、特定のプロトコルに依存しないホスト コント ローラー ドライバーの職務のこれらの側面を処理します。

Usbuhci.sys (ユニバーサル ホスト コント ローラー インターフェイス) のミニポート ドライバーでは、Windows 2000 に付属していた Uhcd.sys miniclass ドライバーを置き換えます。 Usbohci.sys (オープン ホスト コント ローラー インターフェイス) のミニポート ドライバーには、Openhci.sys が置き換えられます。 Usbehci.sys ミニポート ドライバーでは、高速の USB デバイスをサポートし、Windows XP SP1 以降および Windows Server 2003 以降のオペレーティング システムに導入されました。

USB 2.0 をサポートする Windows のすべてのバージョン、オペレーティング システムは USB 1.1 と USB 2.0 ホスト コント ローラーを同時に管理できます。 オペレーティング システムでは、両方の種類のコント ローラーが存在することを検出、ホスト コント ローラーごとに 1 つずつ、2 つの別のデバイス ノードを作成します。 その後、Windows は、USB 2.0 準拠のホスト コント ローラー ハードウェアか Usbohci.sys Usbehci.sys ミニポート ドライバーまたは USB 1.1 に準拠しているハードウェアのシステムの構成によって Openhci.sys を読み込みます。

ポートは、ドライバーは、USB バス ドライバー、Usbhub.sys、ハブのドライバーとも呼ばれます。 これは、システム上の各ハブのデバイス ドライバーです。

## <a name="usb-common-class-generic-parent-driver-usbccgpsys"></a>USB 共通クラス ジェネリック親ドライバー (Usbccgp.sys)


USB の一般的なクラスの一般的な親ドライバーは、複合デバイス用の Microsoft 提供の親ドライバーです。 ハブのドライバーを列挙し、親複合ドライバーを読み込む場合**deviceClass**が 0 または 0xef と**numInterfaces**デバイス記述子では 1 より大きい。 ハブのドライバーとして親複合ドライバーの互換性のある ID を生成する"USB\\複合"。 Usbccgp.sys では、Windows Driver Model (WDM) ルーチンを使用します。

親複合ドライバーでは、複合デバイスのすべての関数を列挙し、それぞれの PDO を作成します。 これにより、適切なクラスまたはクライアント ドライバーは、デバイス内の各関数に、読み込まれます。 各関数のドライバー (子 PDO) は、親のドライバーに USB ハブのドライバーに送信する要求を送信します。

Usbccgp.sys は Windows XP SP1、および以降のバージョンの Windows オペレーティング システムに含まれています。 関数を実装するために、ドライバーが更新された Windows 8 で中断し、リモート ウェイク アップ機能、USB 3.0 仕様で定義されています。

詳細については、[USB 汎用親ドライバー (Usbccgp.sys)](usb-common-class-generic-parent-driver.md)を参照してください。

## <a name="winusb-winusbsys"></a>WinUSB (Winusb.sys)


Windows USB (WinUSB) は、USB デバイスの Microsoft 提供の汎用ドライバーです。 WinUSB アーキテクチャは、カーネル モード ドライバー (Winusb.sys) とユーザー モードのダイナミック リンク ライブラリ (Winusb.dll) で構成されます。 デバイスのユーザー定義関数のドライバーを必要としない場合、機能のドライバーとして Winusb.sys デバイスのカーネル モード スタックでインストールできます。 ユーザー モード デバイス I/O 制御要求のセットを使用して、または呼び出すことによって、プロセスは Winusb.sys と通信し、できる**WinUsb\_Xxx**関数。 詳細については、[WinUSB](winusb.md)を参照してください。

Windows 8 での WinUSB、Winusb.inf、Microsoft から提供された情報 (INF) ファイルを含む USB\\MS\_COMP\_WINUSB デバイス識別子の文字列として。 これにより、Winusb.sys MS OS 記述子に一致する WinUSB 互換性のある ID を持つこれらのデバイスの機能のドライバーとして自動的に読み込まれたを取得できます。 このようなデバイスでは、WinUSB デバイスと呼ばれます。 いないハードウェアの製造元が、エンドユーザーの簡単なドライバーのインストール処理を行う、WinUSB デバイスの INF ファイルを配布するに必要です。 詳細については、[WinUSB デバイス](automatic-installation-of-winusb.md)を参照してください。

## <a name="usb-client-driver"></a>USB クライアント ドライバー


複合または複合ではない各 USB デバイスは、クライアント ドライバーによって管理されます。 USB クライアント ドライバーは、USB ドライバー スタックのクライアントであるクラスまたはデバイス ドライバーです。 このようなドライバーには、このクラスにはと、Microsoft またはサード パーティ ベンダーからのデバイス固有ドライバーが含まれます。 Microsoft によって提供されるクラス ドライバーの一覧を表示するには、[のサポートされている USB デバイス クラスに対するドライバー](supported-usb-classes.md)を参照してください。 クライアント ドライバーは、USB ドライバー スタックによって公開されるパブリック インターフェイスを呼び出すことによって、デバイスと通信する要求を作成します。

複合デバイス用のクライアント ドライバーがドライバー スタック内の場所を除き、非複合デバイス用のクライアント ドライバーと変わりありません。

非複合デバイス用のクライアント ドライバーは、ハブのドライバーのすぐ上に階層化されます。

Windows を読み込みます複合 USB デバイスの複数の関数を公開し、親クラスのドライバーがない場合、[一般的な親の USB ドライバー (Usbccgp.sys)](usb-common-class-generic-parent-driver.md)ハブ ドライバーと、クライアント ドライバーの層の間。 親のドライバーは、複合デバイスの関数ごとに個別の PDO を作成します。 一般的な親ドライバー上は、クライアント ドライバー (Fdo 関数) が読み込まれます。 ベンダーは、関数ごとに別のクライアント ドライバーを提供することができます。

USB クライアント ドライバーは、ユーザー モードまたはカーネル モード ドライバーの要件に応じてのいずれかで実行できます。 USB クライアント ドライバーは、KMDF、UMDF、または WDM ルーチンを使用して記述できます。

## <a name="helper-libraries-for-client-drivers"></a>クライアント ドライバー用のヘルパー ライブラリ


マイクロソフトでは、カーネル モード ドライバーと USB ドライバー スタックと通信するアプリケーションに役立つ次のヘルパー ライブラリを提供します。

-   しくみ

    Microsoft では、USB クライアント ドライバーのルーチンをエクスポートするしくみのライブラリを提供します。 ヘルパー ルーチンは、クライアント ドライバーの運用タスクを簡略化します。 たとえば、ヘルパー ルーチンを使用すると、USB クライアント ドライバーを構築できます[USB 要求のブロック (翻訳)](communicating-with-a-usb-device.md)構成をなど、特定の操作を選択し、USB ドライバー スタックにこれらの翻訳を送信します。

-   Usbdex.lib

    このヘルパー ライブラリは Windows 8 の新機能です。 ライブラリでは、ルーチンの割り当てと翻訳の構築について主にエクスポートします。 これらのルーチンは、一部のしくみによってエクスポートされたレガシ ルーチンを置き換えます。 新しいルーチンでは、クライアント ドライバーの登録のためのハンドルを保持する USB ドライバー スタックを登録する必要があります。 そのハンドルは、他の Usbdex.lib ルーチンへの呼び出しに使用されます。 新しいルーチンによって割り当てられた特定の翻訳は、追跡と処理の向上のため USB ドライバーを使用する URB コンテキストを持っています。 詳細については、[割り当てと構成の翻訳](how-to-add-xrb-support-for-client-drivers.md)を参照してください。

-   Winusb.dll

    Winusb.dll が公開しているユーザー モード DLL [WinUSB functions](https://msdn.microsoft.com/library/windows/hardware/ff540046#winusb) Winusb.sys を通信するためのカーネル モードでデバイスの機能のドライバーとして読み込まれます。 アプリケーションでは、これらの関数を使用するデバイスを構成して、デバイスに関する情報を取得、I/O 操作を実行します。 これらの関数の使用方法の詳細については、[WinUSB 関数を使用して、USB デバイスへのアクセス方法](using-winusb-api-to-communicate-with-a-usb-device.md)を参照してください。

## <a name="related-topics"></a>関連トピック
[ユニバーサル シリアル バス (USB) ドライバー](https://msdn.microsoft.com/library/windows/hardware/ff538930)  
[USB ドライバー開発ガイド](usb-driver-development-guide.md)  



