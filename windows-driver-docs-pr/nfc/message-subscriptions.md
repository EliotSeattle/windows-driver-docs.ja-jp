---
title: NFP メッセージサブスクリプション
description: NFP メッセージサブスクリプション
ms.assetid: ECE9C495-978F-4BD7-95BC-B68432F9B81E
keywords:
- NFC
- 近距離無線通信
- proximity
- 近距離近接通信
- NFP
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 51ff1d58af1cfa651808dc451b36fcc59de4bacd
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72832119"
---
# <a name="nfp-message-subscriptions"></a>NFP メッセージサブスクリプション


サブスクリプションは、ドライバー内で一意のオープンハンドルとして表されます。 サブスクリプションは、"Sub\\" デバイス名前空間のハンドルを開くことによってアクティブになります。 サブスクリプションの種類は、"Sub\\" プレフィックスに続くすべてのものとして定義されます。

メッセージ受信時のコールバックは、完了した[**IOCTL\_NFP\_\_次\_サブスクライブ**](https://docs.microsoft.com/windows-hardware/drivers/ddi/nfpdev/ni-nfpdev-ioctl_nfp_get_next_subscribed_message)された\_メッセージを取得することによって与えられます。

サブスクリプションは、 [**IOCTL\_NFP\_DISABLE**](https://docs.microsoft.com/windows-hardware/drivers/ddi/nfpdev/ni-nfpdev-ioctl_nfp_disable)を使用して一時的に無効にすることができます。

サブスクリプションは、 [**IOCTL\_NFP\_有効に**](https://docs.microsoft.com/windows-hardware/drivers/ddi/nfpdev/ni-nfpdev-ioctl_nfp_enable)することで再び有効にすることができます。

## <a name="handles"></a>ハンドル数


メッセージ型をサブスクライブするクライアントは、まずドライバーへの新しいハンドルを開きます。 以前のパブリケーションやサブスクリプションなどのハンドルを再利用することはできません。 これらが不要になった場合は、適切に動作するクライアントによって閉じられます。

ハンドルを開くときに、クライアントはメッセージサブスクリプションの種類を設定します。 これは、"Pubs\\" ではなく "Sub\\" というプレフィックスが付いている点を除いて、パブリッシングで使用されるメカニズムと同じです。

型を読み取る機能がありません。

### <a name="required-actions"></a>必要なアクション

-   ドライバーは、プロトコルコンポーネント (最初の '. ' の前) を解析する必要があります。 認識されていないプロトコルは、ステータス\_オブジェクト\_パスで完了する必要があり\_\_見つかりません
-   文字列がバッファーの長さ内で NULL で終了しない場合、ドライバーは、状態\_無効な\_パラメーターを持つ IOCTL を完了する必要があります。
-   プロトコルにサブタイプが必要で、文字列バッファーのサブタイプコンポーネントが 1 (1) 文字未満または250文字を超える場合、ドライバーは状態\_無効\_パラメーターを持つ IOCTL を完了する必要があります。
-   文字列バッファーのプロトコルコンポーネントが250文字を超えている場合、ドライバーは、状態\_無効\_パラメーターを持つ IOCTL を完了する必要があります。
-   ドライバーは、最初の NULL を文字列の末尾として解釈する必要があります。
-   ドライバーでは、サブスクリプションの "ペアリング: Bluetooth" の種類が認識される場合があります。
-   ドライバーは、"WindowsUri" 型を認識している必要があります。
-   ドライバーは、サブスクリプションの "DeviceArrived" の種類のみを認識している必要があります。
-   ドライバーでは、サブスクリプションの "デバイスが使用されていません" の種類を認識している必要があります。
-   ドライバーでは、サブスクリプションの "WindowsMime" の種類のみを認識している必要があります。
-   ドライバーは "WindowsMime" を認識している必要があります。 各種.
-   プロトコルがサブスクリプションに対してのみ認識され、IOCTL が "Pubs\\" を指定している場合、ドライバーは、状態\_オブジェクト\_パス\_が見つから\_なかったことを示す IOCTL を完了する必要があります。
-   プロトコルがパブリケーションに対してのみ認識され、IOCTL が "Sub\\" を指定している場合、ドライバーは、状態\_オブジェクト\_パス\_が見つからない\_ことを示す IOCTL を完了する必要があります。
-   一部のプロトコル (名前空間) は予約されています。 このドキュメントで明示的に指定されていない限り、ドライバーは次の文字で始まるプロトコルを認識できません。
    -   ウィンドウ
    -   ドライブ
    -   組み合わせる
    -   "NDEF"
-   同じ型の2つの開いているハンドルは、2つの異なるエンティティを表す必要があります。
-   *CreateFile*が成功した場合、ハンドルは "サブスクリプションハンドル" になり、他の種類のハンドルに変更することはできません。
-   この IOCTL が成功した後、ハンドルが終了する前に、このサブスクリプションの型と一致する近接通信テクノロジを介してメッセージを受信するたびに、そのメッセージのデータをクライアントに配信するためにファイルハンドルに添付する必要があります。

## <a name="unsubscribe"></a>サブスクライブ


クライアントは、メッセージの受信を停止するために、サブスクリプションハンドルを閉じます。 クライアントプロセスが終了すると、クライアントの代わりに開いているすべてのファイルハンドルが閉じられます。

### <a name="required-actions"></a>必要なアクション

ハンドルが閉じている場合、ドライバーは、サブスクリプションによって使用されているすべてのメモリを再利用する必要があります。

-   ドライバーは、型の文字列データを再利用する必要があります。
-   受信したキューを削除して、再利用する必要があります。
-   保留中の IOCTL は、状態\_取り消された状態で完了する必要があります。

## <a name="malicious-peers"></a>悪意のあるピア


悪意のあるピアデバイスが近接通信テクノロジを使用してサービス拒否 (DOS) 攻撃を仕掛けると、クライアントが、ドライバーが過剰にメモリを使用するのを防ぐために、"受信した" キューを十分な速度でドレインできない可能性があります。

### <a name="required-actions"></a>必要なアクション

50メッセージが現在 "受信済み" キューにあるときにメッセージが受信された場合、ドライバーは、特定のメッセージをキューに置いたり、クライアントに配信したりすることはできません (最新のメッセージは削除されます)。

## <a name="unresponsive-or-misbehaving-clients"></a>クライアントの応答不能または誤動作


要求された IOCTL\_NFP の送信に失敗したため、クライアントが "受信済み" キューのドレインを停止した場合は、10 ~ 20 秒\_10-20sec \[のサブスクライブされた[ **\]メッセージ要求を取得\_\_\_** ](https://docs.microsoft.com/windows-hardware/drivers/ddi/nfpdev/ni-nfpdev-ioctl_nfp_get_next_subscribed_message)ドライバーは、クライアントが削除されたと想定する必要があります。 通常の状況では、クライアントは1秒 \[1s\]内の要求を適切に更新する必要があります。 この場合、ドライバーは "CompleteEventImmediately" カウンターを0に設定し、クライアントがウェイクアップして必要な IRP を送信するまでカウンターを増やさないようにする必要があります。

### <a name="required-actions"></a>必要なアクション

ドライバーは、"CompleteEventImmediately" カウンターを0に設定する必要があります。また、クライアントが置換された\_IOCTL を送信しなかった場合は、10-20 秒以内に[ **\_次\_サブスクライブされた\_メッセージ\_取得**](https://docs.microsoft.com/windows-hardware/drivers/ddi/nfpdev/ni-nfpdev-ioctl_nfp_get_next_subscribed_message)するように、カウンターを増やさないでください。以前の IOCTL 完了の。

## <a name="malformed-messages"></a>間違った形式のメッセージ


クライアントは、 [**IOCTL\_\_NFP**](https://docs.microsoft.com/windows-hardware/drivers/ddi/nfpdev/ni-nfpdev-ioctl_nfp_get_next_subscribed_message)から返されたすべてのエラー (STATUS\_BUFFER\_OVERFLOW を除く) を削除または無視することがあります。この場合、次\_サブスクライブされた\_メッセージ\_ます。 そのため、間違った形式のメッセージが受信されたことが原因で、ドライバーはこれらのエラー条件だけを完了することはできません。

### <a name="required-actions"></a>必要なアクション

-   ドライバーは、許可されている最大メッセージサイズを超えるメッセージをクライアントに配信することはできません。
-   ドライバーは、長さ0のメッセージをクライアントに配信することはできません。
-   ドライバーは、一部のメッセージをサブスクライバーに配信してはなりません。
-   ドライバーは、強力な CRC に障害が発生したことを示すメッセージをクライアントに配信することはできません。

      NFC フォーラム認定では、この**こと**が nfc 対応の NFP プロバイダーに対して保証されます。

     

-   ドライバーは、強力な CRC に失敗したメッセージの信頼性の高いトランスポートを使用するか、再送信を試みる必要があります。

      NFC フォーラム認定では、この**こと**が nfc 対応の NFP プロバイダーに対して保証されます。

     

## <a name="duplicate-subscriptions"></a>重複するサブスクリプション


このドライバーでは、クライアントがメッセージの種類を2回サブスクライブする場合、クライアントはメッセージを受信したときに2回メッセージを受信する必要があることを前提としています。

### <a name="required-actions"></a>必要なアクション

同じクライアントによってサブスクライブされている場合でも、ドライバーは重複するサブスクリプションを受け入れてレポートする必要があります。

 

 
## <a name="related-topics"></a>関連トピック
[NFC デバイスドライバーインターフェイス (DDI) の概要](https://docs.microsoft.com/windows-hardware/drivers/ddi/index)  
[近距離無線近接 DDI リファレンス](https://docs.microsoft.com/windows-hardware/drivers/ddi/index)  

