---
title: デバイスのインストール時の自動構成
description: デバイスのインストール時の自動構成
ms.assetid: 04b53767-4b5e-450d-96ab-b029cdf62b36
keywords:
- デバイスのインストール中の自動構成 WDK プリンター
- プリンター自動構成 WDK プリンター、デバイスのインストール中
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 8caee1e13b68eca2aebff84cc2ea4f26b8297e2b
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72842842"
---
# <a name="autoconfiguration-during-device-installation"></a>デバイスのインストール時の自動構成


次の図は、デバイスがインストールされたときの自動構成のデータフローを示しています。

![デバイスをインストールするときの自動構成のデータフローを示す図](images/autocfginstall.png)

1.  プリンターがインストールされている場合、スプーラは `DrvPrinterEvent` を呼び出してプリンターの\_イベント\_呼び出しで初期化することによってドライバーを初期化します。

2.  ドライバーは、 [bidi 通信インターフェイス](https://docs.microsoft.com/windows-hardware/drivers/ddi/_print/index)を使用して、必要なデータを取得します。たとえば、\\DuplexUnit: installed および \\Printer: installed などのインストール可能なオプションの値が含まれます。

3.  Bidi 通信インターフェイスは、ポートモニターでこれらの属性の値を照会します。 ポートモニターには、要求されたデータの一部がキャッシュにある場合があります。 次の手順でわかりやすくするために、\\プリンターの値がポートモニターのキャッシュにあり、\\DuplexUnit: がインストールされていないことを前提としています。

4.  ポートモニターにキャッシュがあり、要求された値を1つ以上保存した場合、ポートモニターはこれらの値を bidi 通信インターフェイスに返します。 キャッシュ内にない値については、ポートモニターによってエラー\_\_データは返されません。 ポートモニターがキャッシュを実装していてもキャッシュが空の場合、bidi クエリは失敗する可能性があることに注意してください。 この問題を回避するには、キャッシュにデータが設定されたときに、ポートモニターから bidi 通信インターフェイスに通知する必要があります。

5.  Bidi 通信インターフェイスは、受信した情報をポートモニターからドライバーに渡します。 Bidi 通信インターフェイスからポートモニターへの呼び出しによって何らかの理由でエラーが発生した場合、ドライバーはこれらの属性の既定値を設定する必要があります。 ポートモニターは、要求された属性に関する情報を受信するとすぐに、この情報を含む通知を bidi 通信インターフェイスに送信します。

    ドライバーは \\の値を使用してレジストリを更新します (ポートモニターのキャッシュから取得されます)。また、\\DuplexUnit: Installed の既定値がインストールされています。

6.  ポートモニターは、キャッシュされた値 (\\Printer: Installed) を含めて、デバイスに両方の値を照会します。

7.  デバイスは、照会された属性の値をポートモニターに送信します。 値がキャッシュ内に存在しない属性、またはキャッシュ内の値と異なる値を持つ属性の場合、ポートモニターは新しい値をキャッシュに配置します。

8.  ポートモニターは、以前にキャッシュに存在しなかった値または変更された値を含む通知をスプーラに送信します。 この例では、ポートモニターが \\DuplexUnit: Installed の新しい値についての通知をスプーラに送信します。 キャッシュされた値がデバイスから受信した新しい値と同じ場合、ポートモニターはスプーラーに通知を送信しないことに注意してください。

9.  スプーラは `DrvPrinterEvent`を呼び出すことによってポートモニタからの通知に応答し、呼び出しのすべての変更された値に加えて、プリンタ\_イベント\_構成\_更新を渡します。 このアクションでは、次の2つの目的で、値がキャッシュに初めて格納されたか、値が変更された属性の値をドライバーに通知します (この例では\\DuplexUnit: Installed)。レジストリを更新します。 スプーラーは、プリンターごとに `DrvPrinterEvent`の呼び出しをシリアル化して、ドライバーがスレッドセーフである必要がないようにします。

    デバイス情報はレジストリに格納されるため、ドライバーは、物理デバイスと直接通信しなくても、UI またはデバイスの機能情報を更新するための呼び出しを満たすことができます。 ドライバーは、レジストリに格納されている情報が正しいことを確認できます。これは、変更通知によってデバイスに対するクエリが実行され、デバイスの構成状態が更新されるためです。

10. ドライバーは、最新の構成に従って UI を更新します。

    ドライバーは、デバイスのインストール中に変更が発生した日時を判断できます。これは、通知メッセージに変更後の値が含まれているためです。 ただし、通知が大きすぎて通知メカニズムを使用して送信できない場合、通知には1つ以上の ReducedSchema インスタンスが含まれます。各インスタンスは、デバイスの特性が変更されたことを示しますが、新しい値の詳細は含まれません。

 

 




