---
title: V4 ドライバー セットアップ概念
description: V4 印刷ドライバーモデルは、ユーザーエクスペリエンスを向上させ、サポートコストを削減するために、新しいセットアップモデルを使用します。
ms.assetid: C1DF5496-14CF-4BF4-B85C-AF1A691C7AF2
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: c550830ab211b64b876bcf9ad4bba835d0607005
ms.sourcegitcommit: ab64169b631da4db3f0b895600f1c38a22cb7e2e
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/03/2020
ms.locfileid: "75652859"
---
# <a name="v4-driver-setup-concepts"></a>V4 ドライバー セットアップ概念


V4 印刷ドライバーモデルは、ユーザーエクスペリエンスを向上させ、サポートコストを削減するために、新しいセットアップモデルを使用します。

V4 印刷ドライバーは、ドライバーストアから直接実行されます。これにより、ファイルの競合が発生する可能性がなくなり、インストールのパフォーマンスが向上します。 V4 セットアップモデルは引き続き INF ファイルを使用しますが、プリンター固有のセットアップディレクティブをキャプチャするための新しいマニフェストファイルも使用します。

## <a name="device-identifiers"></a>デバイス Id


**互換 id**。 Windows の新しいバージョンをリリースした後にリリースされるデバイスをドライバーでサポートできるようにするため、ドライバーを更新する必要がないため、互換 Id は印刷クラスドライバーの重要な概念です。 これは、HardwareID の場合よりも、デバイスがデバイスでより限定的な印刷ドライバーのサポートをアドバタイズできるためです。

特定の互換 Id が既に印刷クラスドライバーによってサポートされている場合、v4 印刷ドライバーはそれを再度指定することはできません。 印刷ドライバーの日付が印刷クラスドライバーの日付よりも新しい場合、印刷ドライバーは Windows Update サイトから自動的にダウンロードされます。

デバイスには、値が1284ID の文字列に含まれている必要があります。 既存の印刷クラスドライバーでデバイスがサポートされている場合は、印刷ドライバーでその互換 Id を使用する必要があります。それ以外の場合は、次の形式を使用することをお勧めします。

1284\_CID\_&lt;製造元識別子&gt;\_&lt;PDL 識別子&gt;\_デバイスファミリ識別子

例: 1284\_CID\_FA\_PCL5e\_レーザー

既存のデバイスでの互換 Id が既に実装されている場合、印刷ドライバーは引き続きこれらの Id を使用します。

互換 Id は、TCP/IP ベースの印刷デバイスのインストールでは使用されません。 そのため、ユーザーはドライバーの名前のみを使用して、適切なドライバーを識別する必要があります。 Print クラスドライバーに関しては、印刷クラスドライバーでサポートされているすべてのデバイスの web サイトに互換性リストを用意することをお勧めします。 ルールと制限の完全な一覧を含め、ハードウェアに互換 Id を実装する方法の詳細については、「[印刷デバイスで互換性のある id を実装する方法](https://docs.microsoft.com/previous-versions/windows/hardware/design/dn613942(v=vs.85))」を参照してください。

Microsoft では、いくつかの標準の互換 Id をサポートしています。 次の表は、これらの標準のタイプ Id と、関連する PDL ファイルの種類を示しています。

| PDL ファイルの種類      | 標準の互換 Id |
|--------------------|-----------------------|
| XPS                | 1284\_CID\_MS\_XPS    |
| OpenXPS (ECMA-388) | 1284\_CID\_MS\_OXPS   |
| PCL6               | 1284\_CID\_MS\_PCL6   |
| PS                 | 1284\_CID\_MS\_PS     |

 

これらの標準の印刷クラスドライバーは、ごく一部の機能だけをサポートしているので、これらのクラスドライバーを利用する製造元は、Bidi を使用して、特定の用紙サイズと構成を追加する拡張ドライバー構成を実装する必要があります。 次の表は、標準の print クラスドライバーでサポートされている機能と関連するオプションを示しています。

| 機能    | オプション           |
|------------|-------------------|
| 用紙サイズ | Letter、A4        |
| 解像度 | 300dpi、600 dpi    |
| [メディアの種類] | 普通紙       |
| N-Up       | 1、2、4、6、9、16 |

 

**プリンター Driverid**。 プリンタードライバー Id は、プリンター共有のドライバー間の互換性、およびドライバーとプリンターの拡張機能との互換性を判断するために使用される新しい識別子です。 たとえば、サーバー上のドライバーでマニフェストファイルにプリンター Driverid が指定されていて、ドライバーが共有されている場合、このプリンターに接続しているクライアントは、ローカルのドライバーストアを検索し、で同じプリンター Driverid を指定するドライバーを Windows Update します。ドライバーの INF。 一致するものが見つかった場合は、そのドライバーを使用して接続が行われます。 クライアントコンピューターは、ドライバー名を使用して一致する結果をフィルター処理しません。

次の方法で、すべての互換性のあるドライバーに対してプリンター Driverid を指定する必要があります。

-   V4 マニフェストでのプリンター Driverid ディレクティブの使用。

-   V4 ドライバー INF の HardwareID として。

2つの異なるドライバーが同じプリンター Driverid を共有するには、共有と互換性がある必要があります。 接続が常に成功するには、2つのドライバーが次の操作を実行できる必要があります。

-   同じ PDL をサポートする

-   同じ種類の構成ファイル (GPD または PPD) を使用する

-   サーバードライバーの GPD、PPD、または制約 JS ファイルに指定されている機能やオプションを表示できる

-   同じプリンターの拡張機能をサポートする

スプーラでは、これらの制限は検証されず、プリンター Driverid のみを使用して、2つのドライバーが共有と互換性があるかどうかを示します。 上記の項目のいずれかに変更が加えられた場合、製造元はドライバーのプリンター Driverid を変更する必要があります。

プリンターの拡張機能は、PrinterDriverIDs 経由でドライバーに関連付けることもできます。 そのため、プリンター Driverid を共有する2つのドライバーは、両方とも同じプリンターの拡張機能を使用する必要があります。 最後にインストールされたプリンターの拡張機能によって、対象の PrinterDriverIDs を使用しているすべてのデバイスの以前のプリンターの拡張機能が上書きされるため、同じアプリを使用して適切に動作する必要があります。

**Guid を使用するためのベストプラクティス**。 Guid は、v4 印刷ドライバーモデルを通じて広く使用されています。ほとんどの場合、プリンター Driverid、さらにはプリンター Extensionid、EventID、ModelID でも使用されます。 これらは、システム内のさまざまな項目を一意に識別するために使用されるか、サービスや共有などのために同じものを識別するために使用されます。

新しい Guid を作成する場合は、Microsoft Visual Studio に含まれている GUID、または SDK に含まれている GUID などの GUID ジェネレーターを常に使用してください。 誤ってコピーおよび貼り付けされた手動で作成された Guid と Guid は、競合が発生しやすくなります。

## <a name="setup-behaviors"></a>セットアップの動作


**印刷キューの名前**。 V3 ドライバーの場合、印刷キュー名は最初にドライバー名、次にユーザーによって指定されていました。 印刷クラスドライバーの導入により、ドライバー名はデバイスをユーザーが認識できるようになります。 V4 印刷ドライバーを実行するためにインストールされているプラグアンドプレイデバイスについては、次のように Windows によってキューの名前が自動的に変更されます。

1. 最初に、印刷キュー名はドライバー名に設定されます。

2. ドライバーが v4 印刷ドライバーの場合、Windows は Bidi を使用してデバイスに対してクエリを実行します。

」を参照します。 \\DeviceInfo: FriendlyName が指定されている場合は、新しいキュー名として使用されます。

b. それ以外の場合は、Windows によって \\DeviceInfo: Manufacturer、\\DeviceInfo: ModelName が照会されます。

i. 両方が指定されている場合は、Windows によって "Manufacturer ModelName" に連結されます。

ii. これらの Bidi クエリの1つだけが失敗した場合、Windows は、キュー名として他のクエリから正常に返された結果を使用します。

3. すべての Bidi クエリが失敗した場合、Windows は IEEE 1284ID を使用して製造元とモデルの名前を決定します。

」を参照します。 DESCRIPTION または DES が指定されている場合は、新しいキュー名として使用されます。

b. それ以外の場合、Windows は製造元、製造、モデル、または MDL を検索します。

i. 両方が指定されている場合は、Windows によって "製造元のモデル" に連結されます。

ii. これらのうちの1つだけが失敗した場合は、他のキーの値がキュー名として使用されます。

**プリンターの追加ウィザード**。 ドライバー名は、**プリンターの追加ウィザード**でドライバーを選択したユーザーが使用できる唯一の識別子となります。 Tcp/ip 自動検出をサポートするには、TCP/IP ベースのデバイスで[ポートモニター MIB (PWG 5107.1-2005)](https://www.pwg.org/standards.html)を実装する必要があります。 ハードウェア ID (HWID) マッピングを使用して印刷クラスドライバーに追加された既存のデバイスでは、デバイス固有のモデル名を追加で使用することもできます。

## <a name="changing-ports-and-dealing-with-printer-devnodes"></a>ポートの変更とプリンタ Devnodes の処理


一貫した UI エクスペリエンスを提供するために、すべての印刷キューにソフトウェアデバイスノード (devnode) が与えられます。 これは、UI でプリンターが検出される方法であり、仮想プリンター、共有プリンターへの接続、およびネットワークプリンターは、プラグアンドプレイ (PnP) プリンターと同じ方法で列挙およびアクセスできます。 物理 PnP プリンターのソフトウェア devnodes は、キューの作成をトリガーした PnP devnode からプロパティを継承します。

2つの異なるオブジェクトが関係している場合、UI によって devnodes がデバイスコンテナーにグループ化されます。 このグループ化により、多機能プリンター (MFP) を **[デバイスとプリンター]** フォルダーに1つのアイコンとして表示できるようになります。 すべての関数が同じアイコンの下に表示されるためには、MFP 内のすべての関数のコンテナー ID が同じである必要があります。 これは、PnP デバイスに対して自動的に実行されます。

キューに関連付けられているポートを変更すると、キューの devnode に関連付けられているコンテナー ID が変更されます。 これにより、キューは、物理デバイスの残りの PnP オブジェクトと同じデバイスコンテナーの下にグループ化されなくなります。 キューと PnP オブジェクトが分離された状況を適切にクリーンアップするための十分な情報がオペレーティングシステムにありません。 場合によっては、これがユーザーの実際の目的です。 ポート名を変更するユーザーまたはアプリケーションのみが、意図された結果を認識しています。また、キューのポートが変更された後に、混乱した状態をクリーンアップするのは、ユーザーまたはアプリケーションによって決まります。 次の2つの例は、適切にクリーンアップする方法を示す手順を示しています。

1. IT 管理者がプリンターを設定する– IT 管理者は、WS 探索を使用してネットワーク上のプリンターを検索し、tcp/ip 管理プロセスと同様に TCP/IP にポートを変更します。

」を参照します。 [デバイスとプリンター] フォルダーには、"デバイス" が1つだけ存在することを想定しています。

b. 解決方法: IT 管理者は、[デバイスとプリンター] フォルダーから WSD PnP devnode を削除します。

2. IHV セットアップソフトウェア– IHV はカスタムポートモニターと共にドライバーをインストールします (v4 ではカスタムポートモニターは許可されていませんが、v3 ドライバーにも同じ devnode 処理が適用されます)。 IHV は、印刷キューの USB ポートを、デバイスの製造元が作成するポートに変更します。

」を参照します。 [デバイスとプリンター] フォルダーには、"デバイス" が1つだけ存在することを想定しています。

b. ソリューション \#1-PnP devnode は引き続き必要です。セットアッププログラムは、PnP オブジェクトと一致するように、キュー devnode のコンテナー ID を変更します。

c. ソリューション \#2 – PnP devnode は不要です。セットアッププログラムによって、元の PnP デバイスが削除されます。

**ドライバーの順位付け**。 V4 印刷ドライバーの導入によって、プラグアンドプレイ順位付けの動作が変更されることはありません。 デバイスが接続されている場合は、スコアが最高の利用可能なドライバーが選択されます。 選択したドライバーが印刷クラスのドライバーであり、Windows Update サイトに一致する適切なドライバーがある場合、選択したドライバーは、次回ユーザーが Windows の更新プログラムをダウンロードするときに自動的に置き換えられます。

ドライバーの順位付けの詳細については、「 [Windows がドライバーをランク付けする方法](https://docs.microsoft.com/windows-hardware/drivers/install/how-setup-ranks-drivers--windows-vista-and-later-)」を参照してください。

## <a name="driver-setup-best-practices"></a>ドライバーセットアップのベストプラクティス


**パッケージ化**。 V4 印刷ドライバーは、共有ファイルを処理するために、**必要**な機能を使用せず、INF ファイルディレクティブ、またはコアドライバーテクノロジを**含み**ます。 そのため、v4 印刷ドライバーは、ごくわずかな例外のみを含む自己完結型である必要があります。

V4 印刷ドライバーは、Windows が提供する共通ファイルへの依存関係を継続して実行できます。 これらのファイルには、Ntprint.inf または NTPrint4 のファイルが含まれます。 ドライバーには、v4 マニフェストファイルで**requiredfiles**ディレクティブを指定することによって、これらのファイルを含めることができます。

デバイスまたは PDL の基本的なレンダリング機能を提供する既存の印刷クラスドライバーがある場合は、 **requiredclass**ディレクティブを使用してクラスドライバーへの依存関係を取得するメカニズムも存在します。 このディレクティブを使用すると、Windows は v4 印刷ドライバーと必要な印刷クラスドライバーの両方のファイルを使用してドライバーをビルドします。 GPD ファイルと PPD ファイルがマージされます。最も具体的なファイルは、特定のファイルよりも優先されます。 次の図は、GPD/PPD ファイルのマージに使用されるロジックを示しています。また、Bidi から取得した拡張ドライバー構成ファイルも含まれています。 JavaScript の制約など、その他のドライバーファイルは、ドライバーパッケージにマージされません。

![gpd/ppd ファイルマージロジック](images/gpd-ppdmergelogic.png)

**プリンターのモデル線**。 プラグアンドプレイは、モデル線のすべてのハードウェア Id とすべての互換 Id の暗黙的な順位付けを保持します。 その結果、パートナーは、順位付けに関して予期しない動作を避けるために、次のベストプラクティスを使用することをお勧めします。

v4 印刷ドライバー

1. V4 印刷ドライバーの Inf では、次の2種類のモデル線を定義する必要があります。

」を参照します。 HardwareID lines: "Driver name" = INSTALL\_SECTION, busenumerator\\HardwareID

b. プリンター Driverid 行: "ドライバー名" = インストール\_セクション、{GUID}

2. V4 印刷ドライバー Inf では、個々の行にバス固有のハードウェア Id を定義する必要があります。

」を参照します。 "Driver name" = INSTALL\_SECTION, WSDPRINT\\HardwareID

b. "Driver name" = INSTALL\_SECTION, USBPRINT\\HardwareID

c. "Driver name" = INSTALL\_SECTION、LPHARDWAREID UM\\

印刷クラスドライバー

1. 印刷クラスドライバーの Inf では、3種類のモデル線を定義する必要があります。

」を参照します。 HardwareID lines: "Driver name" = INSTALL\_SECTION, HardwareID

b. プリンター Driverid 行: "ドライバー名" = インストール\_セクション、{GUID}

c. 互換 Id 行: "Print Class Driver name" = INSTALL\_SECTION,, 1284\_CID\_CompatID

2. Print クラスドライバーの Inf では、バスの列挙子を定義することはできません (たとえば、WSDPRINT\)

## <a name="related-topics"></a>関連トピック
[印刷デバイスで互換性のある Id を実装する方法](https://docs.microsoft.com/previous-versions/windows/hardware/design/dn613942(v=vs.85))  
[Windows がドライバーをランク付けする方法](https://docs.microsoft.com/windows-hardware/drivers/install/how-setup-ranks-drivers--windows-vista-and-later-)  
[ポートモニター MIB (PWG 5107.1-2005)](https://www.pwg.org/standards.html)  



