---
title: 仮想プロビジョニング
description: 仮想プロビジョニング
ms.assetid: 0D65DDCC-D207-4EA8-B5D6-56DF57221EE3
ms.date: 10/04/2019
ms.localizationpriority: medium
ms.openlocfilehash: 6ec9e06dee020367291cb7207452f1b640a6e561
ms.sourcegitcommit: c23a403b3ebea05bde96067b678a318ca9b0cabe
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/04/2019
ms.locfileid: "71939091"
---
# <a name="thin-provisioning"></a>仮想プロビジョニング

## <a name="overview"></a>概要

仮想プロビジョニングは、ジャストインタイムの割り当てを提供するエンドツーエンドのストレージプロビジョニングソリューションです。 ホストとクライアントアプリケーションで記憶域の展開と実行を計画する必要があります。 Windows Server の仮想プロビジョニング機能は、シンプロビジョニング対応の記憶域とホストサーバー間のインターフェイスとして機能します。 仮想プロビジョニングの特徴としては、仮想プロビジョニング論理ユニット (LUN) の識別、しきい値の通知、リソース枯渇のハンドル、可用性が高くスケーラブルな記憶域プロビジョニングサービスをエンドユーザーに提供するための領域の解放などがあります。

## <a name="thin-provisioning-lun-identification"></a>仮想プロビジョニング LUN Id

Windows server では、Windows Server 2012 以降の仮想プロビジョニング Lun を識別するために、T10 SCSI Block Command 3 (SBC3) の標準仕様を採用しています。 Windows Server では、最初のターゲットデバイスの列挙中に、すべてのプロパティパラメーターがターゲットデバイスから収集されます。 Windows Server によって、プロビジョニングの種類と、マップ解除とトリムの機能が識別されます。 ストレージデバイスは、SBC3 仕様に従って、プロビジョニングの種類とマッピング解除およびトリミング機能を報告します。

記憶装置が現在の機能を正確に報告していない場合は、デバイスの互換性の問題が発生する可能性があります。 たとえば、ストレージデバイスが、マップ解除コマンドをサポートしているが、マップ解除コマンドをサポートしていないことを報告した場合、ディスクフォーマットのハングの問題が発生する可能性があります。 プロビジョニングの種類の情報が正確である場合、記憶域スタックは、記憶域のプロビジョニングの種類に応じて、より適切な i/o 処理を提供できます。

## <a name="run-time-provisioning-type-or-lun-capacity-changes"></a>実行時のプロビジョニングの種類または LUN の容量の変更

記憶域管理者は、プロビジョニングの種類または LUN の容量を変更する場合があります。 プロビジョニングの種類または LUN の容量が変更された場合、ストレージアレイは、sense データが要求されたときに正しい情報を返す、ユニットのアテンションを意味する条件を生成します。 Windows Server によってシステムイベントがログに記録され、プロビジョニングの種類または LUN の容量の変化がシステム管理者に通知されます。

## <a name="threshold-and-resource-exhaustion-handles"></a>しきい値とリソース枯渇ハンドル

通常、シンプロビジョニング LUN は、LUN のサイズよりも物理ディスク領域が少なくなるように作成されます。 しきい値の通知は、ホストおよびクライアントアプリケーションに記憶域スペースの消費状態を通知するために必要な機能です。 ほとんどの仮想プロビジョニングストレージアレイは、しきい値に達したときにイベントを報告しません。 これらのシンプロビジョニング記憶域ソリューションは、独自の記憶域管理ユーティリティを使用して、しきい値の通知を解決します。 そのため、ホストとクライアントアプリケーションの場合、これらの記憶域配列が報告する唯一のイベントは永続的なリソース枯渇です。 シンプロビジョニングのストレージデバイスでは、しきい値通知ハンドル、一時的なリソース枯渇ハンドル、または永続的なリソース枯渇ハンドルを使用して、記憶域スペースの使用量が近づいている場合にシステム管理者またはクライアントアプリケーションに警告を出します。capacity.

### <a name="thin-provisioning-threshold-notification"></a>仮想プロビジョニングのしきい値の通知

記憶域管理ユーティリティは、仮想プロビジョニングのしきい値を設定します。 Windows Server は、記憶域管理ユーティリティによって設定されたしきい値を上書きしません。 仮想プロビジョニング LUN の場合、記憶域管理者は、記憶域の平均使用率に応じてしきい値を指定する必要があります。 書き込みコマンドが記憶域ターゲットデバイスによって設定されたしきい値を超えた場合、ターゲットデバイスは、sense data を使用してコマンドを終了し、"シンプロビジョニングソフトしきい値に達しました" というメッセージを送信します。 Windows Server が一致する sense データを受信すると、次のようになります。

- システムイベントは、ホスト管理者に、LUN デバイスのリソース使用率または可用性のしきい値に達したことを警告するために記録されます。
- システムイベントログには、ターゲットデバイスのログページから、使用済みおよび使用可能なマップ済みリソースに関する情報が報告されます。 これを行うには、Windows Server でシステムイベントを生成するために、論理ブロックのプロビジョニングのログページの仕様が記憶域配列でサポートされている必要があります。
- 終了したコマンドは再試行されます。

> [!NOTE]
> FILE_FLAG_WRITE_THROUGH が設定されていない場合、永続的なリソース枯渇状態がトリガーされる可能性があるため、このエラーが記録された後に送信される書き込みコマンドは失われる可能性があります。

### <a name="temporary-resource-exhaustion"></a>一時的なリソース枯渇

記憶域配列によって LUN で自動拡張機能が有効になっている場合、管理者は一時的なリソース枯渇通知を使用して、ストレージデバイスが4秒以内に LUN に追加の領域を割り当てることができるようにすることができます。 書き込みコマンドによって一時的なリソース枯渇状態が発生すると、ストレージデバイスは、sense data を使用して操作を要求するコマンドを終了し、"領域の割り当てを処理中です" というメッセージを返します。 一時的なリソース枯渇は、次のように処理されます。

- 再試行間隔を1秒に設定して、元の要求を4回再試行します。
- すべての再試行が失敗した場合、要求はアプリケーションにフェールバックされます。
- ストレージデバイスが一時的なリソース枯渇を処理しない場合、Windows Server は、永続的なリソース枯渇状態を返すことによって、ストレージデバイスが次の書き込み要求を失敗させることを想定しています。

### <a name="permanent-resource-exhaustion"></a>永続的なリソース枯渇

永続的なリソース枯渇状態は、シンプロビジョニング LUN が記憶域の最大容量制限に達したことを示します。 書き込みコマンドの実行中に永続的なリソース枯渇が発生した場合、ストレージデバイスは、sense データを使用して操作を終了し、"領域割り当てに失敗しました" というメッセージを送信します。 永続的な枯渇は次のように処理されます。

- 元の要求に FILE_FLAG_WRITE_THROUGH が設定されている場合は、アプリケーションにフェールバックされます。
- 元の要求に FILE_FLAG_WRITE_THROUGH が設定されていない場合、要求が完了していないか、物理メディアにフラッシュされていない場合、アプリケーションは成功応答を受信する可能性があります。
- "永続的なリソース枯渇" エラーメッセージを含むシステムイベントがログに記録されます。
- エラーコードが partition manager に戻され、LUN がオフラインになります。

## <a name="storage-space-reclamation-using-the-unmap-command"></a>[マップ解除] コマンドを使用した記憶域スペースの回復

領域の解放は、ファイルの削除、ファイルシステムレベルのトリミング、または記憶域の最適化操作によってトリガーできます。 ファイルシステムレベルのトリミングは、トリムまたはマップ解除操作の後に "読み取り戻りゼロ" を実行するように設計されたストレージデバイスに対して有効です。

### <a name="space-reclamation-operation-in-the-storage-stack"></a>記憶域スタックでの領域の解放操作

ファイルシステムから大きなファイルが削除されるか、ファイルシステムレベルのトリムがトリガーされると、Windows Server は、ファイルの削除またはトリム通知を対応するマップ解除要求に変換します。 ストレージポートドライバースタックは、ストレージデバイスのプロトコルの種類に応じて、マップ解除要求を SCSI マップ解除コマンドまたは ATA トリムコマンドに変換します。 ストレージデバイスの列挙中、Windows ストレージスタックは、ストレージデバイスがマップ解除コマンドまたはトリムコマンドをサポートしているかどうかに関する情報を収集します。 デバイスに SCSI マップ解除機能または ATA トリム機能がある場合は、マップ解除要求のみがストレージデバイスに送信されます。 また、Windows Server では、ストレージターゲットデバイスで LBAs のマッピングを解除するための API 実装も提供されています。 Windows Server では、T10 SCSI WRITE 同じコマンドセットが採用されていません。

### <a name="unmap-requests-from-the-hyper-v-guest-operating-system"></a>Hyper-v ゲストオペレーティングシステムからの要求をマップ解除する

仮想マシン (VM) の作成時に、Hyper-v ホストは、仮想ハードディスク (VHD) が存在する記憶装置が、マップ解除コマンドまたはトリムコマンドをサポートしているかどうかを照会します。 VM ゲストオペレーティングシステムのファイルシステムから大きなファイルが削除されると、ゲストオペレーティングシステムは、仮想マシンの仮想ハードディスク (VHD) または VHD ファイル (または VHDX ファイル) にファイル削除要求を送信します。 VM の VHD または VHDX ファイルは、次のように SCSI マップ解除要求を Windows Hyper-v ホストのクラスドライバースタックにトンネリングします。

- VM に VHD ファイルがある場合、VHD は SCSI マップ解除コマンドまたは ATA トリムコマンドを[データセット管理 i/o 制御のコード](https://docs.microsoft.com/windows-hardware/drivers/storage/data-set-management-overview)トリミング要求に変換してから、ホスト記憶装置に要求を送信します。
- VM に VHDX ファイルがある場合、VHD ファイルシステムは SCSI マップ解除コマンドまたは ATA TRIM コマンドをファイルシステムレベルのトリム要求に変換してから、ホストオペレーティングシステムに要求を送信します。

Windows Hyper-v では、ゲストオペレーティングシステムからの IOCTL DSM トリム呼び出しもサポートされています。

### <a name="windows-optimize-drives-utility"></a>Windows 最適化ドライブユーティリティ

エンドユーザーまたはシステム管理者は、ドライブの最適化ユーティリティを使用して、手動の要求を作成するか、スケジュールの構成を最適化することによって、領域を再利用できます。 ディスクドライブが仮想プロビジョニング LUN の場合は、ディスクドライブのメディアの種類が "シンプロビジョニングドライブ" として表示されます。

システム管理者は、ドライブの最適化ユーティリティを使用して、記憶域スペースの統合をスケジュールすることができます。 また、このユーティリティでは、システム管理者に対して、スケジュールされた実行が3回連続で失敗したかどうかを通知できます。

## <a name="retrieving-the-slab-mapping-state"></a>スラブマッピングの状態を取得しています

仮想プロビジョニング LUN では、すべての論理ブロックがスラブ (クラスター) にグループ化されます。 スラブのサイズは、ストレージデバイスによって報告される最適なマップ解除の粒度パラメーターによって設定されます。 すべてのスラブは、マップ済み、割り当て解除、固定状態に分類されます。 Windows Server は、割り当て解除された状態と固定された状態の両方を未マップの状態として扱います。 Windows Server では、ストレージ管理操作のために仮想プロビジョニング Lun から LBA プロビジョニングの状態を取得するための API 実装 (IOCTL DSM 割り当て) が提供されます。 アプリケーションは IOCTL DSM 割り当てルーチンを呼び出して、SCSI コマンドを送信し、特定の範囲内の各スラブのマップされた状態またはマップされていない状態を取得できます。 返される LBA プロビジョニングステータスが割り当て範囲全体を表していない場合、アプリケーションは別の SCSI コマンドを送信して、残りの LBA 範囲のプロビジョニングステータスを取得します。

ストレージデバイスは、1回の戻りで LBA 範囲全体を処理する必要はありません。 元の要求の部分 LBA 範囲が返された場合は、残りの LBA 範囲のマッピング状態を取得するために別のコマンドが送信されます。
