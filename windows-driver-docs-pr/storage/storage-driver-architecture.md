---
title: Windows 記憶装置ドライバーのアーキテクチャ
description: Windows 記憶装置ドライバーのアーキテクチャ
ms.assetid: 16636899-fab9-46e8-ab9d-b8d86519b08a
keywords:
- ストレージドライバー WDK、アーキテクチャ
- ストレージドライバー WDK、種類
ms.date: 10/08/2019
ms.localizationpriority: medium
ms.openlocfilehash: d3dac620c556b587fef571d3a3542f51c456f215
ms.sourcegitcommit: e1ff1dd43b87dfb7349cebf70ed2878dc8d7c794
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/02/2020
ms.locfileid: "75606482"
---
# <a name="windows-storage-driver-architecture"></a>Windows 記憶装置ドライバーのアーキテクチャ

周辺記憶装置の Windows オペレーティングシステムクラスとフィルタードライバーは、クラスまたはフィルタードライバーの上にある中間レベルまたは最高レベルのドライバーと、システムによって提供されるポートドライバーとの間のインターフェイスとして機能します。

ユーザーアプリケーションまたはカーネルコンポーネントからの i/o 要求は、i/o システムサービスと、ファイルシステムドライバーなどの1つ以上の中間レベルまたは最高レベルのドライバーを使用して、ストレージクラスのドライバーに届きます。 ストレージクラスドライバーは、各 IRP を次の下位のドライバーに送信する前に、SCSI コマンド記述子ブロック (CDBs) を含むシステム定義 SCSI 要求ブロック (SRBs) を使用して、Irp に入る標準の Irp を変換します。 ストレージポートドライバーは、SRBs をクラスドライバーからバス固有のコマンドに変換します。このコマンドは、i/o バスドライバーと、場合によっては1つ以上のフィルタードライバーを介して、記憶域 HBA に送信します。

次の図は、Windows storage ドライバーの多層アーキテクチャを示しています。

![nt ベースのオペレーティングシステムストレージドライバーの多層アーキテクチャを示す図](images/kg201-1.png)

図の一番下から、それぞれの種類のストレージドライバーについて説明します。

1. *ストレージポートドライバー*は、システムによって提供されるディスク、テープ、CD-ROM、DVD、およびチェンジャークラスのドライバーを含む、すべての Windows ストレージクラスドライバーへのインターフェイスを定義します。 このポート/クラスインターフェイスは、それぞれのデバイスが接続されているホストバスアダプターのアダプター固有の要件からクラスドライバーを分離します。 また、対応する HBA のすべてのデバイスドライバーについて、バスへのアクセスが同期されます。 システムは、SCSI、IDE、USB、および IEEE 1394 アダプター用の記憶ポートドライバーを提供します。

    記憶域ポートドライバーは、次の上位のドライバー (記憶域クラスドライバーまたはそれに介在するフィルタードライバー) から SRBs を受信し、次のように処理します。

    - SCSI (またはその他のバス) 用の記憶域ポートドライバーは、SRBs を CDBs on に渡して、オペレーティングシステムに依存しない HBA 固有の*Storport ミニポートドライバー*に渡します。これは対応するポートドライバーに動的にリンクされ、特定の HBA に対するハードウェア固有のサポートを提供します。 SCSI ミニポートドライバーの実装の詳細については、「 [Storport ミニポートドライバー](storport-miniport-drivers.md)」を参照してください。
    - レガシ IDE/ATAPI または IEEE 1394 バス用のストレージポートドライバーは、ストレージクラスドライバーから受信した SRBs を、基になるアダプターが必要とする形式に変換します。たとえば、バス固有のトランスポートプロトコルに従って CDBs を再パッケージ化したり、別の形式に変換したりすると、上位のドライバーが基になるバスの特性から

2. *ストレージフィルタードライバー*の上限または下限は、システム提供のストレージクラスドライバーでは提供されないデバイス固有の機能をサポートしています。 フィルターストレージドライバーが低い場合は、記憶域クラスドライバーによって発行された SRBs や Irp を監視し、必要に応じて次の下位のドライバー (記憶域ポートドライバーまたは他の記憶域フィルタードライバー) に渡す前に、それらを変更します。

    記憶域フィルタードライバーの実装の詳細については、「[ストレージフィルタードライバー](storage-filter-drivers.md)」を参照してください。

3. *ストレージクラスドライバー*は、SCSI ポート/クラスインターフェイスを使用して、システムが記憶ポートドライバーを提供する任意のバス上のデバイスの種類を制御します。 クラスドライバーは特定のデバイスクラスに固有のものです。たとえば、1つのクラスドライバーで、サポートされている任意のバス上のすべての CD-ROM デバイスを実行できます。また、すべてのディスクデバイスを制御することもできます。 ストレージクラスドライバーは、デバイスが SCSI デバイスであるかのように、CDBs を含む SRBs を構築し、それらの SRBs を次の下位のドライバー (ストレージポートドライバーまたは介在するフィルタードライバー) に発行することによって、ストレージスタック内のユーザーアプリケーションまたはドライバーからの i/o 要求を処理します。

    ストレージクラスドライバーの実装は、上位レベルのドライバーに対して透過的です。 テープまたはメディアチェンジャーデバイスのクラスドライバーは、システムによって提供されるクラスドライバーにリンクするデバイス固有の miniclass ドライバーとして実装されます。 ディスクや CD-ROM/DVD など、他の記憶装置用のシステム提供のクラスドライバーは、単一のモノリシックドライバーとして実装されます。

    ストレージクラスドライバーの実装の詳細については、「[ストレージクラスドライバー](introduction-to-storage-class-drivers.md)」を参照してください。 Tape またはチェンジャー miniclass ドライバーの実装の詳細については、それぞれ「[テープドライバー](tape-drivers-overview.md)と[チェンジャードライバー](changer-drivers.md)」を参照してください。

4. 上位フィルターのストレージドライバーは、記憶域スタックの上位にあるユーザーアプリケーションとドライバーから Irp をインターセプトし、次に小さいドライバー (記憶域クラスドライバーまたは他の記憶域フィルタードライバー) に渡す前に変更する可能性があります。 フィルタードライバーは、通常、基になるデバイスのパフォーマンスを監視します。

デバイスが接続されているバスの種類と、そのストレージポートドライバーの実装は、上位レベルのドライバーに対して透過的です。 記憶域ポートドライバーは、SCSI ポートドライバーなどのポート/ミニポートドライバーのアーキテクチャに従って実装される場合があります。IDE/ATAPI ポートドライバーなど、単一の標準のハードウェアを制御するモノリシックドライバー。または、SRBs を、IEEE 1394 ポートドライバーなど、別のドライバースタックで必要な形式に変換するフィルタードライバーとして。

システムで提供される SCSI ポートドライバーは、同じ種類の SCSI 以外の記憶装置を制御する記憶域クラスドライバーと SCSI ミニポートドライバーの間のインターフェイスとして機能することもできます。 たとえば、新しいディスクアレイコントローラー用のドライバーを記述するのではなく、ドライバーライターは、システムの SCSI ポートドライバーにリンクする擬似 SCSI ミニポートドライバーを記述し、そのインターフェイスを使用することによって、設計、開発、およびデバッグを大幅に行うことができます。ここ. このようなミニポートドライバーは、着信 SCSI コマンドをデバイス固有のコマンドに変換するために必要です。 一方、システムによって提供されるポートおよびクラスドライバーは、擬似 SCSI ミニポートの代わりに、初期化中のレジストリアクセス、リソースとオブジェクトの割り当て、同期、要求の事前サイズ設定など、必要な作業量を処理します。ミニポートのデバイスの機能に合わせて転送し、要求を再試行します。

SRBs の詳細については、「カーネルモードドライバーのアーキテクチャリファレンス」を参照してください。 CDBs に関するデバイスタイプ固有の情報については、SCSI 3 標準規格の適切なコマンドセットを参照してください。
