---
title: Architecture
description: Architecture
ms.assetid: 6a50cba8-f989-4662-8e1d-2df462cb48d9
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 34ed3905ec4e227de7f9a8e92fed16529ee83725
ms.sourcegitcommit: a33b7978e22d5bb9f65ca7056f955319049a2e4c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/31/2019
ms.locfileid: "56571980"
---
# <a name="architecture"></a>Architecture


説明、列挙型と大容量記憶装置 1667 と互換性のあるデバイスの検出プロセスでは、前に、レガシ USB 大容量記憶装置デバイスに既に存在していたプロセスを理解することをお勧めします。

USB 大容量記憶装置は、Windows XP または Vista のホスト システムに接続されて、USBStor カーネル モード ドライバーがインストールされ、読み込まれます。 このドライバーでは、デバイスに存在する論理ユニット (Lun) の数と同じ物理デバイス オブジェクト (Pdo) のディスク数を作成します。 図 1 は、1 つの LUN の USB フラッシュ デバイス (UFD) のドライバー スタックを示しています。

![図 1: レガシ usb 大容量記憶装置のドライバー スタック](images/enhancedstorage-1.png)

デバイスが接続するには、システムを LUN 0 に利用可能なデータのストレージ メディアは PDO ディスクによって表されるディスク デバイス経由にアクセスできます。 PartMgr は、メディアに格納されているパーティションの情報を認識し、VolMgr では、この情報を使用して、メディア上の論理パーティションを表す 1 つまたは複数のボリュームの Pdo を作成します。 ファイル システムの種類を識別するために各ボリュームを検査し、そのボリュームの適切なファイル システムをマウントします。 アプリケーションは、システム DOS のドライブ文字が組み込まれているファイル パスの使い慣れた用語を使用して API を使ってマウントされたボリュームを アドレス (たとえば、 *e:\\myfile*)。

レガシと 1667 大容量記憶装置デバイスの 1 つの大きな違いが、承認する前に 1667 ACT のユーザー データの部分にいない完全にアクセスできることです。 その他のメディアの付いた大容量記憶装置の従来の動作とは対照的です。 その他のメディアを使用した、接続されたデバイスでは、ストレージ データがアクセスできる必要があります。 すべての動作むしろと見なされますデバイス エラーが原因で、Windows OS プラットフォームとそのアテンダント アプリケーション エコシステムによって。 接続されている接続された、まだアクセスできないデバイスを追加するこの機能が公開想定を基になるため、アクセスできることを意味し、次の方法で、ユーザー エクスペリエンスを中断します。

-   コマンド プロンプト ウィンドウの結果を"0xC0000013"、デバイスでメディアなしのレポート ダイアログ ボックスからドライブにアクセスしようとしています。

-   アクセスできない、ドライブに関係なく、ボリュームが表示されます (実際には、初期化のターゲットを提供するために作成した、マウントされたファイル システムでバックアップ、パーティション分割と書式設定)。 次のディスクの挿入 ダイアログ ボックスの結果シェルまたは開く/保存コモン ダイアログのいずれかでこのボリュームのアイコンをクリックします。 これは、接続されている UFD のユーザー アクションにつながる命令ではありません。

-   すべて**オープン**と**名前を付けて保存**GetOpenFileName および GetSaveFileName ルーチンを呼び出すアプリケーションから結果のダイアログ ボックスが発生すると同じダイアログ ボックスが表示されます。

-   Win32 ファイル システム Api を使用するアプリケーションは、ストレージの接続がアクセスできないため、予期しない動作が発生可能性があります。

-   ブート エラー ログ エントリの表示アクセスに関する問題が発生しているため、認証されていないデバイス RMB を報告する = 0。

-   シェルの自動再生は、ドライブが接続しているときにすぐにアクセス可能と見なされます。 自動再生は、ドライブがシナリオのみアクセス可能な認証が成功したプロセスの後に対応するために設計されていません。 このような動作は、通常のシェルの大容量記憶装置デバイス エクスペリエンスから出発地です。

そのため、混乱を招くエラー ダイアログを表示し、わかりにくいアプリケーション エラーを回避するには、システム ボリュームのプレゼンテーションが完全にまで中断されます 1667 認証を使用して対応する動作を承認済みアクセスが与えられています。

図 1 では、USBStor は、指定された ACT に存在するサイロの種類ごとに新しい PDO を作成します。 図では、パスワードと証明書の認証サイロの両方が表示されます。 各サイロはサイロに対応するドライバーが読み込まれている一意の PDO を受け取ります。 ユーザー モードの承認プロセスでは、認証するためにデバイスと通信する PDO サイロへのハンドルを作成します。 この時点で、デバイスはまだを列挙できません; システム ボリュームそのためにアクセスできないストレージ ターゲットに関する混乱することはありません。 1667 サイロのみがアクセス可能で、およびユーザー操作の基になるユーザー データがアクセス可能で、状態、デバイスを取り込むこれら関数。 単純化してわかりやすくするため、単一の処理を使用したデバイスが表示されますが、デバイス上の複数の機能がある場合に、同じ原則が適用されます。

図 2 および 3 は、場所、ACT が認証され、対応するボリュームが、システムに提示されるポイントに 1667 UFD を最初に接続した時間から発生する 2 つの手順を説明します。

![図 2: (ステップ 1) ボリュームがまだ表示されません。 認証サイロのみが表示されます。](images/enhancedstorage-2.png)

ACT が、アクセスを入力するまで PDO が遅れているディスクの作成は、状態を承認します。 認証が正常に完了するし、アクセスが許可されて、フォロー アップの IOCTL USBStor には、この承認状態の変更を通知します。 USBStor がさらに、PDO、ディスクを作成し、このディスクは PDO、上にボリュームとファイル システム ドライバー スタックがインスタンス化します。 ACT データがシステムにアクセスできるこのボリュームを経由します。

![図 3: (ステップ 2) のアクセスが許可されます。 pdo のディスクとボリュームが表示されます。](images/enhancedstorage-3.png)

デバイスは、自身へのアクセスを許可するための最高の権限です。 そのため、承認の状態が見くびっていた何らかの方法で、最悪の最終的な結果は USBStor は、アクセス不可能の ACT のディスクの PDO を誤って作成が。 ただし、そのデータは、デバイスによって提供されるアクセス強制に従ってセキュリティで保護された残ります。 遅延ディスク PDO メカニズムはユーザー エクスペリエンスを有効にするためのもののみ近くに従来の大容量記憶装置のために提供します。 アクセス制御メカニズムとしてのものではありません。 1667 デバイスは、機能をセキュリティで保護されたアクセスを管理する責任を負います。

図 3 は、ボックスにパスワードと証明書サイロ ドライバーには、デザインの拡張可能な性質は、独自のドライバーを記述することで、認証と承認ワークフローの動作に参加するサード パーティ ベンダーもできます。 さらに、汎用的なサイロの認証プロセスに関連の関数のない可能性がありますも検出してアクセスできます。

IEEE 1667 仕様は、デバイス上に存在する ACT あたり 255 の独立したサイロまで、できます。 各サイロは、序数、だけでなく、そのサイロに対応するデバイスで特定の関数の実装に対応する一意のサイロの種類 ID によって識別されます。 図 3 に示すようにデバイスの場合は、単一の処理は、証明書とパスワードの両方の認証サイロを公開します。 最初のサイロは、パスワードのサイロ パスワード サイロの種類の識別子で示されています。 2 番目のサイロは、さまざまなサイロの種類の識別子を使用して証明書サイロとして認識されます。 サイロの種類のすべての識別子は、指定されたサイロ関数に対して一意で本文を制御する IEEE 1667 によって発行されます。

図 4 は、独立したドライバーが指す各デバイスに複数のサイロの種類を示します。

![図 4: かどうか、ベンダーは他のサイロには、認証のいずれかを実装できます。](images/enhancedstorage-4.png)

サード パーティの認証ホストの認証プロセスに完全に参加すると、デバイスの仕入先は、認証サイロ ドライバーおよびクライアントが認証を作成する必要があります。 ActiveStorage API には、そのドライバーを通じてサード パーティ製サイロと通信するサード パーティ提供の認証のクライアント プロセスでデバイスへのアクセスを承認する処理の容易になります。 ActiveStorage API とサード パーティの認証のクライアント間のインターフェイスは ActiveStorage API デザイン ドキュメントで説明します。

サード パーティの認証のサイロに加え、1667 デバイスは他のサイロも公開できます。 、サイロへのアクセスを提供するサード パーティ製のドライバーを展開することがありますが、このようなドライバーが絶対に必要ではありません。 仕入先は、サイロ ドライバー; せずサイロと通信することもできます。ドライバーを完全に展開する必要があるので。 サード パーティ製のアプリケーションは、デバイスへの直接生サイロ コマンドを送信する可能性があります。

長所と短所、サイロの raw モードのままになりますとサイロ ドライバーを使用したは次のとおりです。

<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">サイロのドライバー</th>
<th align="left">生のサイロ</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p><strong>-</strong> ドライバーの展開が必要です。</p></td>
<td align="left"><p>+ ドライバーは必要ありません。</p></td>
</tr>
<tr class="even">
<td align="left"><p><strong>+</strong> サイロ ドライバーによって適用されるアクセスおよびトランザクションの制御。</p></td>
<td align="left"><p>- 初歩的なアクセスとトランザクション制御 USBStor 経由で未処理の I/O によって提供されるだけです。</p></td>
</tr>
<tr class="odd">
<td align="left"><p><strong>+</strong> 承認ワークフローと UI に参加できます。</p></td>
<td align="left"><p>- 承認ワークフローと UI への参加なし。</p></td>
</tr>
<tr class="even">
<td align="left"><p><strong>+</strong> コンテキスト メニュー アクションの動作。</p></td>
<td align="left"><p>- なしのコンテキスト メニュー アクションの動作。</p></td>
</tr>
<tr class="odd">
<td align="left"><p><strong>+</strong> サイロ ドライバーに含まれる翻訳/検証レイヤーです。</p></td>
<td align="left"><p>- デバイスに直接送信された生コマンド。</p></td>
</tr>
<tr class="even">
<td align="left"><p><strong>+</strong> サイロのドライバーでは、multicommand 操作のトランザクションの整合性を提供します。</p></td>
<td align="left"><p>- SPO および SPI のレベルでトランザクションの基本的な整合性。</p></td>
</tr>
</tbody>
</table>

 

これらの考慮事項は、その特定のサイロのサイロ ドライバーを展開するかどうかを決定する、ベンダーを通知可能性があります。 場合によっては、無人、生のサイロのアクセス権を持つ残りでそのサイロの操作に関する詳細情報を 1 つのクライアント アプリケーションに対して十分です。 この方法を適切にするために、ベンダー複数のアプリケーションからの同時アクセスでは、デバイスの問題が発生しないをもことを確認する必要があります。

それ以外の場合、サイロへのさらに制限されたアクセスを提供するベンダー可能性があります。 そうである場合より広範な変換と検証レイヤーが必要です。 他のベンダーの要件では、ドライブ ボリュームに対応するシェル ドライブのフォルダー アイコンのコンテキスト メニューにカスタム動作を提供します。 これらの理由から、自分のデバイスで独自のサイロへのアクセスを提供するサイロ ドライバーを展開するベンダーができます。
