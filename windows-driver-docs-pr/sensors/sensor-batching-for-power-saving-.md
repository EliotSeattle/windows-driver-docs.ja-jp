---
title: 節電のためのセンサー データの一括処理
description: このトピックでは、Windows 10 でセンサーデータのバッチ処理を実装するためにセンサークラス拡張とセンサードライバーの間に必要なインターフェイスについて説明します。
ms.assetid: E64B9CE0-2C76-430A-ABE0-717BD27BCA8A
ms.date: 07/20/2018
ms.localizationpriority: medium
ms.openlocfilehash: 2b65a42ee27b856f8afef203d98b145131264b69
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72845543"
---
# <a name="sensor-data-batching-for-power-savings"></a>節電のためのセンサー データの一括処理


このトピックでは、Windows 10 でセンサーデータのバッチ処理を実装するためにセンサークラス拡張とセンサードライバーの間に必要なインターフェイスについて説明します。

## <a name="introduction"></a>概要


データのバッチ処理を実装するセンサードライバーを使用すると、プロセッサはセンサーデータを頻繁に受信して処理するため、アプリケーションプロセッサは電力を節約できます。 この場合、センサードライバーはセンサーハードウェアのセンサーデータサンプルをバッファーし、それらをバッチでまとめてセンサークラス拡張に転送します。 バッチ処理をサポートするには、必要なインターフェイスを実装する UMDF 2.0 universal センサードライバーを用意する必要があります。

**バッチ待機時間**

バッチ待機時間は、センサーが収集された後にデータサンプルをバッファーできる最長時間として定義されてから、センサークラス拡張に配信されます。 センサーデータのバッチ処理 "スケジュール" は、次の図に示すように、ドライバーによってセンサーイベントが配信されるときに、バッチの待機時間の値に基づいて開始されます。

![通常のデータ配信を使用する n 個のデータサンプルのコレクションと送信シーケンスを示す図](images/data-batching1.png)

データのバッチ処理を実装していないドライバーの場合、ドライバーは、使用可能になったときにセンサーデータを収集して送信するだけです。 たとえば、N 個のデータサンプルを送信する場合、ドライバーは収集を開始し、データサンプルの送信を N 回行います。

![バッチ処理されたデータ配信で2つのバッチを使用して、n 個のデータサンプルのコレクションと送信シーケンスを示す図。](images/data-batching2.png)

データのバッチ処理を実装するドライバーの場合、データ収集と配信シーケンスは、直前の図に示すようにバッチ処理されます。 バッチ待機時間の値はセンサークラス拡張によって指定されます。 たとえば、センサーハードウェアが N 個のデータサンプルを収集して転送する必要がある場合、センサードライバーはプロセスを2つのバッチに分割できます。 N 個のデータサンプルの前半は、バッチの待機時間と同じ時間間隔の後に送信されます。 その後、別のバッチ待機時間間隔の後、データサンプルの後半部分が送信され、通常の配信方法で必要とされる N 転送と比較して、合計2つの転送が行われます。

## <a name="sensor-properties"></a>センサーのプロパティ


データのバッチ処理をサポートするドライバーでは、必要な共通センサープロパティと列挙プロパティに加えて、次のプロパティも報告する必要があります。

-   PKEY\_センサー\_FifoReservedSize\_サンプル

-   PKEY\_センサー\_Fi@ Maxsize\_サンプル

-   PKEY\_センサー\_WakeCapable

詳細については、「[センサーの一般的なプロパティ](common-sensor-properties.md)と[列挙型のプロパティ](enumeration-properties.md)」を参照してください。

センサーハードウェアサブシステムがウェイクアップに対応している場合は、バッファーオーバーランを回避するために十分な時期にウェイクアップを開始する必要があります。

## <a name="optional-ddsi-functions-for-data-batching"></a>データバッチ処理用のオプションの DDSI 関数


デバイスドライバーソフトウェアインターフェイス (DDSI) 関数は、ドライバーとクラス拡張間のインターフェイスです。 データのバッチ処理をサポートするには、ドライバーが次の DDSI 関数を実装する必要があります。これにより、センサークラスの拡張でバッチの待機時間を設定できるようになります。

-   [Evtsensorsetbatchlatency](https://docs.microsoft.com/windows-hardware/drivers/ddi/sensorscx/ns-sensorscx-_sensor_controller_config)これは、指定されたセンサーのバッチ待機時間を設定するコールバック関数です。 ドライバーは、バッファーの可用性に応じて、バッチの待機時間を*BatchLatencyMs*パラメーター以下の値に設定する必要があります。

ドライバーは、必要なすべての DDSI 関数も実装する必要があります。 詳細については、「[センサー DDSI 関数](sensor-ddsi-functions.md)」を参照してください。

センサークラス拡張でバッチ待機時間を指定する場合は省略可能です。 すべてのセンサーの既定のバッチ待機時間はゼロ (0) です。これは、サンプルがバッチ処理されないことを示すために使用されます。 センサーのサンプルは、クラス拡張が**Evtsensorsetbatchlatency**を呼び出してバッチ待機時間値を設定した場合にのみ、バッチで配信されます。 そうしないと、定期的なデータ間隔でサンプルが正常に配信されます。

センサークラス拡張は、 **Evtsensorsetbatchlatency**を呼び出すことで、いつでもバッチ待機時間の値を変更できます。 特に、この関数は、指定されたセンサーが既にアクティブで実行中のときに呼び出すことができます。これにより、イベントが失われることはありません。 センサードライバーは、最新のバッチのサンプルを収集してすぐに提供することが期待されています (ベストエフォートベース)。 ドライバーは、クラス拡張によって指定されたバッチ待機時間を超えることはできません。

データのバッチ処理により、センサーデータの配信方法とイベントに対して変更が暗黙的に行われることはないことに注意してください。 バッチの待機時間が経過すると、ドライバーは SensorsCxSensorDataReady を繰り返し呼び出して、バッファー内のすべてのデータサンプルを一度に1つずつ配信します。 データサンプルには、各サンプリングが行われた日時を示すタイムスタンプ (関連する PKEY\_SensorData\_Timestamp データフィールドに含まれています) が付属しています。 PKEY\_SensorData\_Timestamp の詳細については、「 [Common data fields](common-data-fields.md)」を参照してください。

## <a name="batch-latency-and-data-rate-relationship"></a>バッチ待機時間とデータレートの関係


バッチ待機時間とデータ速度は、次のように関連しています。

![バッチ待機時間の値の式 (ミリ秒単位)。](images/batch-formula.png)

*Sensorbatching 処理\_MaxSize\_Bytes*は、バッチ化されたセンサーデータ用のバッファーの最大サイズです。 センサーが加速度計の場合は、250以上のサンプルを保持するのに十分な大きさのハードウェアバッファーを使用することをお勧めします。 データ速度はミリ秒単位で表され、1つのデータサンプルの転送にかかる時間の長さです。 センサーハードウェアがバッチに格納する必要があるサンプルの数は、データ速度に反比例します。 データ速度が小さいほど、特定のバッチの待機時間の値にバッチ化されたサンプルを格納するために必要なサンプルバッファーが大きくなります。 前の式では、バッチの待機時間は*BatchLatencyMs*によって表され、データレートは*dataratems*によって表されます。 また、 *BatchLatencyMs*と*dataratems*の組み合わせによって、 *sensorbatching\_MaxSize\_Bytes*を超えるバッファーサイズが発生した場合は、 **evtsensorsetbatchlatency**と[evtsensorsetbatchlatency が返されます。](https://docs.microsoft.com/windows-hardware/drivers/ddi/sensorscx/ns-sensorscx-_sensor_controller_config)バッチの待機時間を、前の式で示されている値に設定します。

呼び出し元が*Dataratems*よりも小さい*BatchLatencyMs*値を指定した場合、データはバッファリングされずに配信されます。

## <a name="batching-with-data-thresholds"></a>データしきい値を使用したバッチ処理


データのバッチ処理を実装するセンサードライバーでは、 [Evtsensorsetdatathresholds](https://docs.microsoft.com/windows-hardware/drivers/ddi/sensorscx/ns-sensorscx-_sensor_controller_config)を使用して0以外のデータしきい値を設定できます。 この場合、現在の読み取りと最後の読み取りの間のデータ値の差が、 **Evtsensorsetdatathresholds**を使用して設定されたデータのしきい値を超えると、データ収集、バッチ処理、および配信のプロセスが呼び出されます。 データのバッチ処理をデータのしきい値と共に使用することで、センサードライバーの電力をさらに節約できます。

センサークラス拡張によってデータのバッチ処理と共に0以外のデータのしきい値が設定されている場合、ドライバーは、正確なタイムスタンプを持つバッチサンプルを配信し、データのしきい値も考慮する必要があります。 センサーハードウェア自体が、データしきい値の適用中に正確なタイムスタンプを保持できない場合、データのしきい値を適用せずにサンプルを収集できます。 ただし、このような場合、ドライバーは、現在のデータしきい値設定を満たしていないサンプルを、センサークラス拡張に配信する前にフィルター処理する必要があります。

## <a name="sequence-diagram-examples"></a>シーケンス図の例


ここでは、[データバッチ処理のオプションの ddsi 関数](#optional-ddsi-functions-for-data-batching)に記載されているオプションのデータバッチ ddsi 関数の使用方法を示すシーケンス図を示します。 パートナーからのフィードバックに基づいてシナリオを明確にするために、必要に応じてシーケンス図を追加することがあります。

**シナリオ1**

このシナリオでは、センサークラス拡張は、センサーを開始する前にバッチ待機時間とデータ間隔を設定します。 センサーが起動すると、設定プロパティを考慮しながら、定期的にバッチが配信されます。

![センサーを開始する前に、クラス拡張でバッチ待機時間とデータ間隔を設定するシナリオを示すシーケンス図。](images/batch-scenario1.png)

**シナリオ2**

このシナリオでは、センサークラス拡張は、バッチ待機時間、データ間隔、およびデータしきい値を設定してから、センサーを開始します。 センサーが起動すると、設定プロパティを考慮しながら、定期的にバッチが配信されます。 データのしきい値を満たすサンプルがあり、指定したバッチ待機時間内に送信する必要がある場合を除き、ドライバーはバッチを配信しないことに注意してください。

![センサーを開始する前に、クラス拡張でバッチ待機時間、データ間隔、およびデータしきい値を設定するシナリオを示すシーケンス図。](images/batch-scenario2.png)

**シナリオ3**

このシナリオでは、センサークラス拡張は、センサーを開始する前にバッチ待機時間とデータ間隔を設定します。 センサーが開始されると、設定プロパティを考慮しながら、定期的にバッチが配信されます。 センサークラス拡張は、センサーの実行中のバッチ待機時間とデータ間隔を変更します。ドライバーは、実行中にデータサンプルを失うことなく、新しい値に基づいてサンプルの配信を直ちに開始します。

![センサーを開始する前に、クラス拡張でバッチ待機時間、データ間隔を設定するシナリオを示すシーケンス図。 また、データ転送を処理しながら、センサーが設定の変更にどのように応答するかを示します。](images/batch-scenario3.png)

## <a name="data-batching-hardware-configurations"></a>データバッチ処理のハードウェア構成


センサーデータは、アプリケーションプロセッサを介さずに、センサーハードウェアでバッチ処理する必要があります。 これにより、データがバッチ処理されている間、プロセッサがスリープ状態になり、電力が節約されます。 次の図は、センサーハードウェアベースのデータバッチ処理に使用できる構成を示しています。

-   **構成 1**: FIFO バッファーは、アプリケーションプロセッサに直接接続されているセンサーコンポーネントに実装されます。

-   **構成 2**: FIFO バッファーは、センサーコンポーネントが接続されている低電力センサーハードウェアコアに実装されます。 この場合、FIFO バッファーは、センサーコアの設計に応じて、複数のセンサー間で共有することも、センサー以外のコンポーネントと共有することもできます。 低電力センサーコアは、アプリケーションプロセッサに接続され、SoC に統合される可能性があります。 または、外部コンポーネントである場合もあります。

-   **構成 3**: FIFO バッファーはセンサーコンポーネントに実装されます。 センサーコンポーネントは、アプリケーションプロセッサに接続されている低電力センサーコアに接続されています。 センサーコンポーネントは SoC に統合されている場合もあれば、外部コンポーネントである場合もあります。

-   **構成 4**: FIFO バッファーはセンサーコンポーネントと低電力センサーコアに実装されています。 センサーコンポーネントは、低電力センサーコアに接続されています。これは、アプリケーションプロセッサに接続されています。 センサーコンポーネントは SoC に統合されている場合もあれば、外部コンポーネントである場合もあります。 センサーコアを使用して、浅い過剰な FIFO を拡張できることに注意してください。

注意すべき重要な点は、FIFO をセンサーコアハードウェアまたはセンサーハードウェアに実装すること、または両方に実装できることです。 ドライバーはこれをオペレーティングシステム用に抽象化し、DDSI を介して統一インターフェイスを提示します。

次の図は、上記の一覧で説明されているさまざまな構成を示しています。

![バッチ化されたセンサーデータをホストするために使用可能なハードウェア構成を示す図](images/sensor-batch-hw.png)

**バッファー-ハードウェアの完全な動作**

通常の状況下では、データが削除または失われないように、ドライバーは*BatchLatencyMs*と同じ間隔で、少なくとも1回ハードウェアバッファーを読み取ることを想定しています。 ハードウェア FIFO バッファーがいっぱいになると、それをラップして、古いイベントを上書きして、循環バッファーのように動作する必要があります。

 

 




