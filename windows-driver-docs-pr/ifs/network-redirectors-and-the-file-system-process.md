---
title: ネットワーク リダイレクターと、ファイル システムのプロセス
description: ネットワーク リダイレクターと、ファイル システムのプロセス
ms.assetid: 01bdd0d4-d03e-4b3c-ab34-1d5909cde284
keywords:
- カーネル ネットワーク リダイレクター WDK、ファイル システムのプロセス
- 非同期要求 WDK ネットワーク リダイレクター
- IRP_MJ_WRITE
- ファイル システムのディスパッチ WDK ネットワーク リダイレクター
- FSD WDK ネットワーク リダイレクター
- WDK のバッファーはファイル システム
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 3a914ddae53fd28edc569b09ee2e17df9abb9045
ms.sourcegitcommit: a33b7978e22d5bb9f65ca7056f955319049a2e4c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/31/2019
ms.locfileid: "56528584"
---
# <a name="network-redirectors-and-the-file-system-process"></a>ネットワーク リダイレクターと、ファイル システムのプロセス


ファイル システム ドライバーによって実行されるファイルの操作のほとんどは、通常、ユーザーのスレッドのコンテキストで完了します。 これらの操作には、すべてのファイル システムにファイルが同期 I/O 呼び出しが含まれます。 このような場合は、すべての作業はインライン行われます。 カーネルで操作がブロックされる可能性がありますが、作業のと同じスレッドで実行されます。 Windows 上のファイル システムは、多くの場合、ファイル システム ディスパッチ (FSD) として、ユーザーのスレッド コンテキストを使用してこの作業を呼び出します。 ほとんどの場合、FSD で作業を完了するファイル システムを試みます。

場合によっては、アプリケーションは避けたい (非同期の読み取りと例については、非同期の書き込み) のブロックがあります。 このような場合は、ファイル I/O 操作が完了するためのシステム ワーカー スレッドにディスパッチする必要があります。 Windows 上のファイル システムは、多くの場合、ファイル システムのプロセス (FSP) として、システムのワーカー スレッドのコンテキストを使用してこの作業を呼び出します。 次の例の非同期の IRP\_MJ\_書き込みネットワーク ミニ リダイレクターに送信される要求は、FSP を使用する必要があるケースを示しています。

非同期の IRP を実行する\_MJ\_書き込み要求、RDBSS またはファイル オブジェクトの FCB リソース (ファイル オブジェクトを変更するための同期オブジェクト) を取得するネットワーク ミニ リダイレクターが必要です。 FCB のリソースが既に別のスレッドによって保持されているし、RDBSS またはネットワークのミニ リダイレクターが FCB のリソースに、ユーザーのスレッドのコンテキスト (FSD) を取得すると、この操作をブロックします。 ファイル システムへの非同期要求をブロックにはなりません。 非同期要求の (IRP\_MJ\_書き込み要求など)、ファイル システム ドライバーは、必要なリソースが使用可能なかどうかを確認して最初に (たとえばネットワーク ミニ-リダイレクターの FCB リソース)。 リソースが使用できないし、ファイル システム ドライバーでは、後で完了するための作業キューに要求をポスト システム ワーカー スレッド (FSP) によって、ファイル システムには、状態が返される場合\_FSD スレッドからの保留します。 ユーザーのアプリケーションに、FSD が状態を返す\_保留中のすぐに、中に、実際の作業は、FSP システム ワーカー スレッドによって処理されます。

ファイル システム ドライバーが FSP に作業をポストする前に、いくつかのタスクを完了する必要があります。 ファイル システム ドライバーは、システムのワーカー スレッドによって作業が完了するために、FSD 内のユーザーのスレッドからのセキュリティ コンテキストをキャプチャする必要があります。 RDBSS はこれを自動的には、 [ **RxFsdPostRequest** ](https://msdn.microsoft.com/library/windows/hardware/ff554472)ネットワークのミニ リダイレクター ルーチン。 このルーチンは、ネットワークのミニ リダイレクターが状態を取得するたびに RDBSS によって呼び出される\_で保留、 **PostRequest** 、RX のメンバー\_コンテキストに設定**TRUE**。 作業が作業キューにポストする場合、ファイル システム ドライバーもを確認してください、ユーザー バッファーがシステムのワーカー スレッドによって後で使用できるようになります。 このタスクを実行する 2 つの方法はあります。

1.  ファイル システム ドライバーは、システム ワーカー スレッド (FSP) が、バッファーを後でアクセスできるように、FSP を投稿する前にカーネル メモリ領域にユーザー バッファーをマップできます。 システムのワーカー スレッドによって後でに割り当てられる常にメモリ ページもできるため、FSP 内ユーザー バッファーのロックをファイル システム ドライバーでよく使用される方法です。

2.  ファイル システムは、呼び出し元プロセスのスレッドを FSP を使用して保存でき、システムのワーカー スレッドが、FSP 中にこの呼び出し元のプロセスにアタッチできます。 使用して、 [ **KeStackAttachProcess**](https://msdn.microsoft.com/library/windows/hardware/ff549659)、システム ワーカー スレッドは、ユーザーの呼び出し元プロセスにアタッチしてユーザー バッファーへのアクセスし、ユーザーの使用して呼び出し元プロセスからデタッチし[**KeUnstackDetachProcess** ](https://msdn.microsoft.com/library/windows/hardware/ff549677)作業が完了するとします。

RDBSS はユーザーのバッファーでメソッド 1 を使用して自動的にロック、 [ **RxFsdPostRequest** ](https://msdn.microsoft.com/library/windows/hardware/ff554472) IRP のルーチンは、RX 限り要求\_コンテキスト\_フラグ\_いいえ\_PREPOSTING\_が必要ビットが設定されていない、**フラグ**、RX のメンバー\_CONTEXT 構造体。 ユーザー バッファーは、次の要求のロックされます。

-   IRP\_MJ\_ディレクトリ\_IRP のマイナー関数を使用したコントロール\_MN\_クエリ\_ディレクトリ

-   IRP\_MJ\_クエリ\_EA

-   IRP\_MJ\_マイナー関数は IRP を含まない限り読み取る\_MN\_MDL

-   IRP\_MJ\_設定\_EA

-   IRP\_MJ\_マイナー関数は IRP を含まない限りに書き込む\_MN\_MDL

方法 2 は、通常、メソッドを使用する Irp の処理に使用\_も少量の情報のみが通常渡され、返されます。 これらの Irp が次に示します。

-   IRP\_MJ\_デバイス\_コントロール

-   IRP\_MJ\_ファイル\_システム\_コントロール

-   IRP\_MJ\_内部\_デバイス\_コントロール

RDBSS のみの非同期呼び出しをサポートする、 **MrxLowIoSubmit**操作の配列。 ネットワークのミニ リダイレクターは、その他の操作を実装する必要がある場合 ([**MRxQueryFileInfo**](https://msdn.microsoft.com/library/windows/hardware/ff550770)など)、非同期の呼び出しとしてネットワークのミニ リダイレクターは FSP に要求を投稿する必要があります。 ネットワークのミニ リダイレクターは要求を受信するかどうかは**MrxQueryFileInfo** 、rx\_コンテキスト\_非同期\_操作ビットが設定で、**フラグ**RX のメンバー\_CONTEXT 構造体、ネットワークのミニ リダイレクターは非同期操作の FSP にこの要求を投稿する必要があります。 操作で、 **MrxQueryFileInfo** 、日常的なネットワーク ミニリダイレクターはまず、ユーザーのスレッドのセキュリティ コンテキストをキャプチャおよびユーザー バッファーをカーネル領域にマップ (または必要をアタッチするシステム ワーカー スレッドを設定します。ユーザーの呼び出しプロセス FSP で実行中に)。 ネットワーク ミニリダイレクターを設定し、 **PostRequest** 、RX のメンバー\_コンテキスト構造体を**TRUE**状態を返すと\_FSD から PENDING。 操作の作業キューにはシステム ワーカー スレッド (FSP) によって、作業を RDBSS によってディスパッチは。

 

 




