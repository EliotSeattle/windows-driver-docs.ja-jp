---
title: ネットワーク リダイレクターとファイル システムの処理
description: ネットワーク リダイレクターとファイル システムの処理
ms.assetid: 01bdd0d4-d03e-4b3c-ab34-1d5909cde284
keywords:
- カーネルネットワークリダイレクター WDK、ファイルシステムプロセス
- 非同期要求の WDK ネットワークリダイレクター
- IRP_MJ_WRITE
- ファイルシステムディスパッチ (WDK ネットワークリダイレクター)
- FSD WDK ネットワークリダイレクター
- WDK ファイルシステムのバッファー
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 2056e9416bc35179dcbdf0173741f07254700556
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72841052"
---
# <a name="network-redirectors-and-the-file-system-process"></a>ネットワーク リダイレクターとファイル システムの処理


ファイルシステムドライバーによって実行されるほとんどのファイル操作は、通常、ユーザーのスレッドコンテキストで完了します。 これらの操作には、ファイルシステムに対する同期ファイル i/o 呼び出しのすべてが含まれます。 このような場合は、すべての作業がインラインで実行されます。 操作はカーネル内でブロックする可能性がありますが、作業は同じスレッドで実行されます。 Windows のファイルシステムでは、多くの場合、ファイルシステムディスパッチ (FSD) としてユーザーのスレッドコンテキストを使用してこの作業を呼び出します。 ほとんどの場合、ファイルシステムは FSD での作業を完了しようとします。

アプリケーションでブロックしない場合があります (非同期の読み取りまたは非同期の書き込みなど)。 このような場合は、ファイル i/o 操作をシステムワーカースレッドにディスパッチして完了する必要があります。 Windows のファイルシステムでは、多くの場合、ファイルシステムプロセス (FSP) としてシステムワーカースレッドコンテキストを使用してこの作業を呼び出します。 ネットワークミニリダイレクターに送信される非同期 IRP\_MJ\_書き込み要求の例を次に示します。これは、FSP を使用する必要があるケースを示しています。

非同期の IRP\_MJ\_書き込み要求を実行するには、RDBSS またはネットワークミニリダイレクターが、ファイルオブジェクトの FCB リソース (ファイルオブジェクトの変更に使用される同期オブジェクト) を取得する必要があります。 FCB リソースが既に別のスレッドと RDBSS によって保持されている場合、またはネットワークミニリダイレクターがユーザーのスレッドコンテキスト (FSD) で FCB リソースを取得しようとした場合、この操作はブロックされます。 ファイルシステムへの非同期要求はブロックされません。 非同期要求 (IRP\_MJ\_書き込み要求など) の場合、ファイルシステムドライバーは、必要なリソースが使用可能かどうかを最初に確認します (たとえば、ネットワークミニリダイレクターの FCB リソース)。 リソースが使用できない場合、ファイルシステムドライバーは、システムワーカースレッド (FSP) によって後で完了するために、要求を作業キューにポストします。ファイルシステムは、FSD スレッドから状態\_PENDING を返します。 ユーザーアプリケーションに対して、FSD は状態\_直ちに返されますが、実際の作業は FSP のシステムワーカースレッドによって処理されます。

ファイルシステムドライバーが FSP にポストする前に、いくつかのタスクを完了する必要があります。 ファイルシステムドライバーは、システムワーカースレッドによって作業が完了するため、FSD 内のユーザーのスレッドからセキュリティコンテキストをキャプチャする必要があります。 RDBSS は、ネットワークミニリダイレクターの[**RxFsdPostRequest**](https://docs.microsoft.com/windows-hardware/drivers/ddi/rxprocs/nf-rxprocs-rxfsdpostrequest)ルーチンでこれを自動的に行います。 このルーチンは、RDBSS によって呼び出されます。ネットワークミニリダイレクターは、RX の**Postrequest**メンバーによって保留中のステータス\_を返すたび\_コンテキスト構造を**TRUE**に設定します。 作業が作業キューに投稿された場合、ファイルシステムドライバーは、ユーザーバッファーがシステムワーカースレッドによって後で使用できるようになるようにする必要もあります。 このタスクを実行するには、次の2つの方法があります。

1.  ファイルシステムドライバーは、FSP にポストする前にユーザーバッファーをカーネルメモリ領域にマップして、後でシステムワーカースレッド (FSP) がバッファーにアクセスできるようにします。 ファイルシステムドライバーによって一般的に使用されるメソッドは、FSP のユーザーバッファーをロックすることです。これは、メモリページは常にシステムワーカースレッドによってマップされるためです。

2.  ファイルシステムは、FSP から呼び出し元プロセスのスレッドを保存できます。また、FSP では、システムワーカースレッドがこの呼び出しプロセスにアタッチできます。 [**Kestackattachprocess**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-kestackattachprocess)を使用すると、システムワーカースレッドはユーザーの呼び出しプロセスにアタッチされ、ユーザーバッファーにアクセスして、作業の完了時に[**KeUnstackDetachProcess**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-keunstackdetachprocess)を使用してユーザーの呼び出しプロセスからデタッチします。

RDBSS は[**RxFsdPostRequest**](https://docs.microsoft.com/windows-hardware/drivers/ddi/rxprocs/nf-rxprocs-rxfsdpostrequest)ルーチン内のメソッド1を使用してユーザーバッファーを自動的にロックします。これは、RX\_コンテキスト\_フラグ\_\_、必要なビットが RX\_コンテキスト構造の**Flags**メンバーで設定されていない場合に限ります。\_ ユーザーバッファーは次の要求に対してロックされます:

-   Irp\_MJ\_DIRECTORY\_制御するために、IRP のマイナー機能を使用して\_します。クエリ\_ディレクトリ\_

-   IRP\_MJ\_クエリ\_EA

-   Irp\_MJ は、minor 関数に IRP\_\_\_が含まれていない場合に読み取りを行います。

-   IRP\_MJ\_設定\_EA

-   Irp\_MJ\_、minor 関数に IRP\_の正常な\_MDL が含まれていない限り書き込みを行う

メソッド2は、通常、少量の情報だけが渡されて返される場合には、メソッドを使用する Irp の処理に使用されます\_。 これらの Irp には、次のものが含まれます。

-   IRP\_MJ\_DEVICE\_CONTROL

-   IRP\_MJ\_ファイル\_システム\_コントロール

-   IRP\_MJ\_INTERNAL\_DEVICE\_CONTROL

RDBSS では、操作の**MrxLowIoSubmit**配列の非同期呼び出しのみがサポートされています。 ネットワークミニリダイレクターが非同期呼び出しとして他の操作 ([**MRxQueryFileInfo**](https://docs.microsoft.com/windows-hardware/drivers/ifs/mrxqueryfileinfo)など) を実装する必要がある場合、ネットワークミニリダイレクターは要求を FSP にポストする必要があります。 ネットワークミニリダイレクターが rx\_コンテキスト\_、rx\_コンテキスト構造の**Flags**メンバーで設定された非同期\_操作ビットを持つ**MrxQueryFileInfo**の要求を受け取った場合、ネットワークミニリダイレクターには、非同期操作のためにこの要求を FSP にポストする場合は。 **MrxQueryFileInfo**ルーチンの動作では、ネットワークミニリダイレクターはまず、ユーザーのスレッドのセキュリティコンテキストをキャプチャし、ユーザーバッファーをカーネル領域にマップする必要があります (または、ユーザーの呼び出しにアタッチするようにシステムワーカースレッドを設定します)。FSP での実行中に処理されます)。 次に、ネットワークミニリダイレクターは、RX\_コンテキスト構造の**Postrequest**メンバーを**TRUE**に設定し、FSD から STATUS\_PENDING を返します。 この作業は、システムワーカースレッド (FSP) による操作のために、RDBSS によって作業キューにディスパッチされます。

 

 




