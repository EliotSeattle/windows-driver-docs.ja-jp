---
title: ハンドルの管理
description: ハンドルの管理
ms.assetid: 09d9c836-1754-4a50-92a3-229a3ae05ccb
keywords:
- WDK ファイルシステムを処理します
- セキュリティ WDK ファイルシステム、脅威の最小化
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: b6d70f7573d6172ba275aa028eaf6be077253587
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72841222"
---
# <a name="handle-management"></a>ハンドルの管理


## <span id="ddk_handle_management_if"></span><span id="DDK_HANDLE_MANAGEMENT_IF"></span>


ドライバー内のセキュリティ問題の重要な原因として、ユーザーモードコンポーネントとカーネルモードコンポーネントの間で渡されるハンドルの使用があります。 カーネル環境内のハンドルの使用には、次のような既知の問題がいくつかあります。

-   間違った種類のハンドルをカーネルドライバーに渡すアプリケーション。 カーネルドライバーは、ファイルオブジェクトが必要なイベントオブジェクトを使用しようとするとクラッシュすることがあります。

-   必要なアクセス権を持たないオブジェクトをハンドルに渡すアプリケーション。 カーネルドライバーは、ユーザーに適切なアクセス許可が与えられていなくても、カーネルモードからの呼び出しによって動作する操作を実行することがあります。

-   アドレス空間に有効なハンドルではない値を渡し、システムに対して悪意のある操作を実行するシステムハンドルとしてマークされているアプリケーション。

-   デバイスオブジェクト (このドライバーによって作成されなかったハンドル) の適切なハンドルではない値を渡すアプリケーション。

これらの問題から保護するために、カーネルドライバーは、渡されたハンドルが有効であることを確認するために特に注意する必要があります。 最も安全なポリシーは、ドライバーのコンテキスト内で必要なハンドルを作成することです。 カーネルドライバーによって作成されるこれらのハンドルは、OBJ\_KERNEL\_HANDLE オプションを指定する必要があります。これにより、任意のプロセスコンテキストで有効なハンドルと、カーネルモードの呼び出し元からのみアクセスできるハンドルが作成されます。

アプリケーションプログラムによって作成されたハンドルを使用するドライバーの場合、これらのハンドルの使用は細心の注意を払って行う必要があります。

-   適切な*Accessmode* (通常は Irp-&gt;irp->requestormode)、 *DesiredAccess*、 *ObjectType*を指定して、 [**obreferenceobjectbyhandle**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-obreferenceobjectbyhandle)を呼び出してハンドルをオブジェクトポインターに変換することをお勧めします。IoFileObjectType や ExEventObjectType などのパラメーター。

-   呼び出し内で直接ハンドルを使用する必要がある場合は、関数の Zw variant ではなく、Nt バリアントの関数を使用することをお勧めします。 これにより、前のモード**がモードに**なり、信頼されていないため、オペレーティングシステムによってパラメーターチェックが行われ、検証が処理されます。 ポインターである Nt 関数に渡されるパラメーターは、前のモードが**モードの**場合、検証に失敗することがあります。 Nt ルーチンと Zw ルーチンは、エラーをチェックする必要があるエラー情報を含む*Iostatusblock* parameterwith 返します。

-   \_\_使用してエラーを適切にトラップし、必要な場合を除き\_\_する必要があります。 キャッシュマネージャー (Cc)、メモリマネージャー (Mm)、およびファイルシステムランタイムライブラリルーチン (FsRtl) の多くは、エラーが発生した場合に例外を発生させます。

適切な予防措置を取らずに、ユーザーモードアプリケーションから渡されたハンドルやパラメーターに依存するドライバーはありません。

Nt バリアントを使用してファイルを開く場合は、ファイルを閉じるために Nt バリアントも使用する必要があることに注意してください。

 

 




