---
title: システム起動時のファイル システムの状態
description: システム起動時のファイル システムの状態
ms.assetid: f6ed556a-2353-4a0d-8db1-1fb5eac3c1ef
keywords:
- レガシフィルタードライバー WDK ファイルシステム、ブートプロセス
- 従来のファイルシステムフィルタードライバー WDK、ブートプロセス
- 従来のファイルシステムドライバー WDK、ブートプロセス
- ファイルシステムレコグナイザー WDK
- FsRec WDK
- レガシフィルタードライバー WDK ファイルシステム、ドライバーの読み込み
- 従来のファイルシステムフィルタードライバーの WDK、ドライバーの読み込み
- WDK ファイルシステムの読み込み中のドライバー
- ドライバー WDK ファイルシステムを読み込んでいます
- 読み込み順序グループ WDK ファイルシステム
- 再初期化ルーチン WDK ファイルシステム
- ブートドライバー WDK ファイルシステム
- ブート開始ドライバー WDK ファイルシステム
- グローバルファイルシステムキュー WDK ファイルシステム
- ファイルシステムキュー WDK
- WDK ファイルシステムをキューに置いてください
- FsRec
ms.date: 10/16/2019
ms.localizationpriority: medium
ms.openlocfilehash: 740187d7bdfa5770d7bde74d6804beb9c7cc643d
ms.sourcegitcommit: 8c898615009705db7633649a51bef27a25d72b26
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/07/2020
ms.locfileid: "78910443"
---
# <a name="what-happens-to-file-systems-during-system-boot"></a>システム起動時のファイル システムの状態

> [!NOTE]
> 最適な信頼性とパフォーマンスを得るには、従来のファイルシステムフィルタードライバーではなく、フィルターマネージャーをサポートする[ファイルシステムミニフィルタードライバー](https://docs.microsoft.com/windows-hardware/drivers/ifs/filter-manager-concepts)を使用します。 レガシドライバーをミニフィルタードライバーに移植する方法については、「[レガシフィルタードライバーを移植するためのガイドライン](guidelines-for-porting-legacy-filter-drivers.md)」を参照してください。

ファイルシステムは、システムの起動プロセス中に初期化されます。具体的には、i/o システムの初期化中に発生します。 I/o マネージャーは、グローバルファイルシステムキューを作成し、オペレーティングシステム (OS) ローダーと PnP マネージャーによって読み込まれたファイルシステムとレガシフィルタードライバーを初期化します。

## <a name="system-boot-process"></a>システムブートプロセス

次に、ファイルシステムとレガシフィルタードライバーの開発者にとって重要な、システムブートプロセスの選択部分の概要を示します。

1. システムの起動時に、ローダーが制御をカーネルに転送する前に、OS ローダーによって、ブートファイルシステム、RAW ファイルシステム、および SERVICE_BOOT_START 型のすべてのドライバーが読み込まれます。 これらのドライバーは、カーネルが制御を取得するときにメモリ内にあります。

   ドライバーは、割り当てられている読み込み順序グループの順に読み込まれます。 ファイルシステムフィルターでは、新しいファイルシステムフィルタードライバーの読み込み順序グループのいずれかに割り当てられているものは、他のすべてのフィルタードライバーの前に読み込まれます。 これらの負荷順序グループの詳細については、「[ファイルシステムフィルタードライバーの読み込み順序グループ](load-order-groups-for-file-system-filter-drivers.md)」を参照してください。

   次に、"フィルター" 読み込み順序グループ内のすべてのドライバーが読み込まれます。 "フィルター" グループには、記憶域フィルタードライバーとファイルシステムフィルタードライバーが含まれており、サードパーティと組み込みのフィルタードライバーが含まれています。

2. I/o マネージャーは、4つのセグメントを持つグローバルファイルシステムキューを作成します。1つは、CD-ROM、ディスク、テープデバイス、およびネットワークファイルシステム用です。 その後、各ファイルシステムが登録されると、そのコントロールデバイスオブジェクトが、このキューの適切なセグメントに追加されます。 ただし、この時点では、まだ登録されていないファイルシステムは存在しないため、キューは空です。

3. PnP マネージャーは、RAW ファイルシステムとすべての SERVICE_BOOT_START ドライバーの[**Driverentry**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_initialize)ルーチンを呼び出します。

   SERVICE_BOOT_START ドライバーが他のドライバーに依存している場合は、それらのドライバーも読み込まれて起動されます。

   PnP マネージャーは、ブートデバイスドライバーの[**AddDevice**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_add_device)ルーチンを呼び出すことによって、ブートデバイスを起動します。 ブートデバイスに子デバイスがある場合は、それらのデバイスが列挙されます。 子デバイスは、ドライバーがブート開始ドライバーである場合にも構成され、開始されます。 デバイスのドライバーがすべてのブート開始ドライバーでない場合は、PnP マネージャーによってデバイスの devnode が作成されますが、デバイスは起動されません。

   この時点で、すべてのブートドライバーが読み込まれ、ブートデバイスが起動されます。

4. PnP マネージャーは、 [pnp デバイスツリー](https://docs.microsoft.com/windows-hardware/drivers/kernel/device-tree)を走査し、各 devnode に関連付けられているがまだ実行されていないドライバーを探して読み込みます。

   各 PnP デバイスが起動すると、PnP マネージャーはデバイスの子を列挙します (存在する場合)。 PnP マネージャーは、子デバイスを構成し、デバイスドライバーを読み込んで、デバイスを起動します。

   PnP マネージャーは、ドライバーの**Starttype**、 **loadordergroup**、または**Dependencies**の値に*関係なく*、各デバイスのドライバーを読み込みます。

   このステップでは、pnp 管理者は、PnP で列挙可能なデバイスのみを構成して起動します。 デバイスが PnP で列挙可能でない場合、PnP マネージャーはデバイスを無視し、子デバイスが PnP で列挙可能であっても、そのデバイスの子を列挙しません。

5. PnP マネージャーは、まだ読み込まれていない SERVICE_SYSTEM_START 種類のドライバーを読み込んで初期化します。

   ファイルシステムレコグナイザー (FsRec) は、現時点で読み込まれています。 これは、"ブートファイルシステム" の読み込み順序グループに含まれていますが、FsRec はブートファイルシステムではないことに注意してください。 実際のブートファイルシステム (ブートボリュームをマウントしたファイルシステム) は、ブートプロセスの開始時に読み込まれます。

   後の SERVICE_SYSTEM_START フェーズでは、"ファイルシステム" の [読み込み順序] グループのファイルシステムが読み込まれます。 これには、名前付きパイプファイルシステム (NPFS) とメールスロットファイルシステム (MSFS) が含まれます。 これには、NTFS、FAT、CDFS、UDF などのメディアベースのファイルシステムは含まれません。

   "ネットワーク" 読み込み順序グループに含まれるネットワークファイルシステムも、このフェーズで読み込まれます。

6. ブート時に読み込まれるすべてのドライバーが初期化されると、i/o マネージャーは、ドライバーを含むすべてのドライバーの再初期化ルーチンを呼び出します。 再*初期化ルーチン*は、ブートプロセスのこの時点で追加の処理時間を指定する必要があるブートドライバーによって登録されるコールバックルーチンです。 再初期化ルーチンは、 [**IoRegisterBootDriverReinitialization**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ntddk/nf-ntddk-ioregisterbootdriverreinitialization)または[**IoRegisterDriverReinitialization**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ntddk/nf-ntddk-ioregisterdriverreinitialization)を呼び出すことによって登録されます。

7. サービスコントロールマネージャーは、まだ読み込まれていない種類の SERVICE_AUTO_START のドライバーを読み込みます。

## <a name="file-system-recognizer"></a>ファイルシステムレコグナイザー

システムの起動後、システムに接続されているすべてのボリュームの記憶装置ドライバーが読み込まれ、起動されます。 ただし、すべての組み込みファイルシステムが読み込まれるわけではありません。すべてのファイルシステムボリュームがマウントされるわけではありません。 ファイルシステムレコグナイザー (FsRec) は、必要に応じてこれらのタスクを実行して[**IRP_MJ_CREATE**](https://docs.microsoft.com/windows-hardware/drivers/ifs/irp-mj-create)要求を処理します。

FsRec は、システム起動時の SERVICE_SYSTEM_START フェーズで読み込まれます。 これは、"ブートファイルシステム" の読み込み順序グループに含まれていますが、FsRec はブートファイルシステムではないことに注意してください。 実際のブートファイルシステム (ブートボリュームをマウントしたファイルシステム) は、ブートプロセスの開始時に読み込まれます。
