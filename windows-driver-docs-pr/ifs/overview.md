---
title: 概要
description: 概要
ms.assetid: 3b2895a2-9a2e-46eb-b8fb-47d6db4a1de0
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 8c7fa35f0624d3141040bed5ba32f6d4b36ccd41
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72841048"
---
# <a name="overview"></a>概要


## <span id="ddk_network_redirector_design_and_performance_if"></span><span id="DDK_NETWORK_REDIRECTOR_DESIGN_AND_PERFORMANCE_IF"></span>


便宜的ロック (oplock) は、ファイルサーバークライアント (SMB および SMB2 プロトコルを使用するものなど) が、パフォーマンスを向上させるために一貫した方法で特定のファイルまたはストリームのバッファリング方法を動的に変更できるようにするメカニズムを提供します。ネットワークの使用。 リモートファイル操作のネットワークパフォーマンスを向上させるために、クライアントはファイルデータをローカルにバッファーできます。これにより、ネットワークパケットを送受信する必要がなくなります。 たとえば、他のプロセスがデータにアクセスしていないことをクライアントが認識している場合、クライアントはリモートサーバー上のファイルに情報を書き込む必要がない可能性があります。 同様に、クライアントは、他のプロセスがリモートファイルにデータを書き込んでいないことをクライアントが認識した場合に、リモートファイルから先行読み取りデータをバッファーできます。 アプリケーションとドライバーは、oplock を使用して、ファイルを使用する必要がある他のアプリケーションに影響を与えることなく、透過的にファイルにアクセスすることもできます。

NTFS などのファイルシステムは、ファイルごとに複数のデータストリームをサポートします。 Oplock はストリームハンドルに付与されます。つまり、操作はファイルの指定されたオープンストリームに適用され、一般に、1つのストリームに対する操作は別のストリームの oplock には影響しません。 これには例外があります。これは、以下に明示的に記載されています。 FAT などの代替データストリームがサポートされていないファイルシステムでは、このドキュメントが "stream" を参照している場合は "file" と考えてください。

現在、8つの異なる種類の oplock があります。

-   **レベル 2** (または共有) oplock は、ストリームのリーダーが複数あり、ライターがないことを示します。 これは、クライアントの読み取りキャッシュをサポートします。

-   **レベル 1** (または排他) oplock を使用すると、クライアントは排他アクセス用にストリームを開き、クライアントが任意のバッファリングを実行できるようになります。 これは、クライアントの読み取りキャッシュと書き込みキャッシュをサポートします。

-   **バッチ**oplock (または排他的) を使用すると、クライアントコンピューターのローカルアクセサーがストリームを閉じた場合でも、クライアントはサーバーでストリームを開いたままにすることができます。 これは、バッチスクリプトの実行中などに、クライアントが同じファイルを繰り返し開いたり閉じたりする必要があるシナリオをサポートします。 これは、クライアントの読み取りキャッシュ、書き込みキャッシュ、およびハンドルのキャッシュをサポートしています。

-   **フィルター** oplock (または排他的) を使用すると、アプリケーションとファイルシステムフィルター (ミニフィルターを含む) を使用して、ストリームデータを開いて読み取ることができます。また、他のアプリケーション、クライアント、またはその両方が同じストリームにアクセスしようとしたときに "戻る" ことができます。 これは、クライアントの読み取りキャッシュと書き込みキャッシュをサポートします。

-   **読み取り**(R) oplock (共有) は、ストリームのリーダーが複数あり、ライターがないことを示します。 これは、クライアントの読み取りキャッシュをサポートします。

-   **読み取りハンドル**(RH) oplock (shared) は、ストリームに対して複数のリーダーが存在し、ライターがないこと、およびクライアントコンピューター上のローカルアクセサーがストリームを閉じている場合でも、クライアントがサーバーでストリームを開いたままにできることを示します。 これは、クライアントの読み取りキャッシュとハンドルのキャッシュをサポートしています。

-   **読み取り/書き込み**(RW) oplock (排他) を使用すると、クライアントは排他アクセス用にストリームを開き、クライアントが任意のバッファリングを実行できるようになります。 これは、クライアントの読み取りキャッシュと書き込みキャッシュをサポートします。

-   **読み取り/書き込みハンドル**(RWH) oplock (排他) を使用すると、クライアントコンピューターのローカルアクセサーがストリームを閉じた場合でも、クライアントはサーバーでストリームを開いたままにすることができます。 これは、クライアントの読み取りキャッシュ、書き込みキャッシュ、およびハンドルのキャッシュをサポートしています。

レベル1、レベル2、および Batch の oplock が Windows NT 3.1 で実装されました。 フィルター oplock が Windows 2000 で追加されました。 Windows 7 では、R、RH、RW、RWH の oplock が追加されました。

一部の oplock は非常に似ています。 特に、R は Level 2 に似ています。 RW は Level 1 に似ており、RWH は Batch に似ています。 R、RH、RW、および RWH の各 oplock (総称して "Windows 7 の oplock" と呼ばれます) が Windows 7 に追加され、呼び出し元がキャッシュの意図を表現し、oplock の中断とアップグレード (つまり、1つのレベルからより高いレベルのキャッシュに対する oplock 状態たとえば、読み取り oplock を読み取り/書き込み oplock にアップグレードします。 この柔軟性は、レベル2、レベル1、バッチ、およびフィルターの oplock によって実現することはできません (」は、総称して "レガシ oplock" と呼ばれます)。 Windows 7 の oplock と従来の oplock の違いについては、このドキュメントで後ほど説明します。

Oplock パッケージのコア機能は、カーネルに実装されます (主に*Fsrtlxxx*ルーチンを通じて)。 ファイルシステムは、ファイルシステムに oplock 機能を実装するために、このパッケージを呼び出します。 このドキュメントでは、NTFS ファイルシステムがカーネル oplock パッケージと相互運用する方法について説明します。 他のファイルシステムも同様の方法で機能しますが、若干の違いがある可能性があります。

Oplock は、ストリームハンドルで許可されます。 これは、指定されたストリームのオープンに対して oplock が付与されることを意味します。 Windows 7 以降、ストリームハンドルは*oplock キー*に関連付けることができます。これは、同じクライアントキャッシュビューに属する複数のハンドルを識別するために使用される GUID 値です (このトピックの後半の「注」を参照してください)。 ハンドルが作成されるときに、oplock キーを明示的に指定することができます ( [**IoCreateFileEx**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ntddk/nf-ntddk-iocreatefileex))。 ハンドルが作成されるときに oplock キーが明示的に指定されていない場合、そのキーが他のハンドルの他のキーと異なるように、ハンドルは一意の oplock キーとして扱われます。 Oplock が許可されたハンドル以外のハンドルでファイル操作を受信し、oplock のハンドルに関連付けられている oplock キーが操作のハンドルに関連付けられているキーと異なる場合、その操作は、現在 oplock が許可されている場合、oplock は解除されます。 Oplock は、互換性のない操作を実行しているプロセスまたはスレッドの場合でも中断されます。 たとえば、排他的 oplock が付与されているストリームをプロセスが開き、同じプロセスが別の (またはない) oplock キーを使用して同じストリームを再び開く場合、排他的な oplock は直ちに解除されます。

Oplock キーはハンドルに存在し、ハンドルが作成されるとハンドルに "配置" されることに注意してください。 Oplock が付与されていない場合でも、ハンドルを oplock キーに関連付けることができます。

  、oplock キーは、ストリームハンドルが参照する[**ファイル\_オブジェクト**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/ns-wdm-_file_object)構造に関連付けられていることに**注意**してください。 この区別は、 [DuplicateHandle](https://go.microsoft.com/fwlink/p/?linkid=124237)などを使用してハンドルが複製されるときに重要になります。 重複する各ハンドルは、基になる同じ**ファイル\_オブジェクト**構造体を参照します。

 

 

 




