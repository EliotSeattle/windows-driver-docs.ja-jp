---
title: 拡張可能スイッチ データ パス経由のパケット フロー
description: 拡張可能スイッチ データ パス経由のパケット フロー
ms.assetid: 9236CE95-F959-445F-849F-14377EE91D19
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: be0605916228f90df9632d24f199d3ad8f42c77d
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72843716"
---
# <a name="packet-flow-through-the-extensible-switch-data-path"></a>拡張可能スイッチ データ パス経由のパケット フロー


このトピックでは、Hyper-v 拡張可能スイッチのデータパスを介して、拡張可能なスイッチポートとの間でパケットを移動する方法について説明します。

**メモ** 拡張可能なスイッチインターフェイスでは、NDIS フィルタードライバーは*拡張可能なスイッチ拡張機能*と呼ばれ、ドライバースタックは*拡張可能なスイッチドライバースタック*と呼ばれます。 拡張機能の詳細については、「 [Hyper-v 拡張可能スイッチ拡張機能](hyper-v-extensible-switch-extensions.md)」を参照してください。



**メモ** このページでは、 [「Hyper-v 拡張可能スイッチ](overview-of-the-hyper-v-extensible-switch.md)と[ハイブリッド転送](hybrid-forwarding.md)の概要」で説明されている情報について理解していることを前提としています。



拡張可能スイッチでポートから受信したすべてのパケットトラフィックは、拡張可能なスイッチドライバースタックを介して同じパスに従います。 たとえば、外部ネットワークアダプター接続から受信したパケットトラフィックや、仮想マシン (VM) ネットワークアダプター接続から送信されたパケットトラフィックは、同じデータパスを経由して移動します。

次の図は、NDIS 6.40 (Windows Server 2012 R2) 以降の拡張可能なスイッチデータパスを示しています。

![ndis 6.40 以降のハイパー\-v 拡張可能スイッチアーキテクチャを示す図](images/vswitcharchitecture-ndis640.png)

次の図は、NDIS 6.30 (Windows Server 2012) の拡張可能なスイッチデータパスを示しています。

![sr-iov を使用した統合デバイスデータパスを示す図](images/vswitcharchitecture.png)

拡張可能スイッチインターフェイスのコンポーネントの詳細については、「 [Hyper-v 拡張可能スイッチのアーキテクチャ](hyper-v-extensible-switch-architecture.md)」を参照してください。

拡張可能なスイッチのデータパスは、パケットが通過する順序に従って、次の部分で構成されています。

-   [プロトコルのエッジ](#overlying-protocol-edge)
-   [受信データパス](#ingress-data-path)
-   [基になるミニポートエッジ](#underlying-miniport-edge)
-   [送信データパス](#egress-data-path)

### <a name="overlying-protocol-edge"></a>プロトコルのエッジ

1.  パケットは、スイッチポートに接続されているネットワークアダプターから拡張可能なスイッチに到達します。 これらのパケットは、拡張可能スイッチのプロトコルエッジから拡張スイッチの受信データパスを下位に送信する要求として最初に発行されます。

    拡張可能スイッチのプロトコルエッジは、受信データパスのパケットを準備します。 プロトコルエッジは、帯域外 (OOB) 拡張可能スイッチ転送コンテキストを含むこれらのパケットのコンテキスト領域を割り当てます。 このコードは、パケットが拡張可能スイッチに配信された元のポートとネットワークアダプターの接続に関する情報を OOB データに設定します。

    転送コンテキストの詳細については、「 [Hyper-v 拡張可能スイッチ転送コンテキスト](hyper-v-extensible-switch-forwarding-context.md)」を参照してください。

2.  NDIS 6.40 (Windows Server 2012 R2) 以降では、パケットが外部ネットワークアダプターからの NVGRE パケットの場合、拡張可能スイッチはパケットの帯域外 (OOB) 情報に**NativeForwardingRequired**フラグを設定します。 詳細については、「[ハイブリッド転送](hybrid-forwarding.md)」を参照してください。

3.  トラフィックに仮想サブネットがあるポートにパケットが到着した場合、拡張可能スイッチは 、 [**NDIS\_NET\_BUFFER\_LIST の VirtualSubnetId メンバーを設定\_仮想\_サブネット\_情報**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/ns-ndis-_ndis_net_buffer_list_virtual_subnet_info)構造パケットの。

    **メモ** 仮想サブネットは、HNV サブネットまたはサードパーティの仮想サブネットにすることができます。



### <a name="ingress-data-path"></a>受信データパス

1.  拡張機能は、 [*Filtersendnetbufferlists*](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-filter_send_net_buffer_lists)関数が呼び出されたときに、受信データパスからパケットを取得します。 拡張機能は、 [**NdisFSendNetBufferLists**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/nf-ndis-ndisfsendnetbufferlists)を呼び出すことによって、受信データパスの基になる拡張機能にパケットを転送します。 フィルターおよび転送拡張機能は、 [**NdisFSendNetBufferListsComplete**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/nf-ndis-ndisfsendnetbufferlistscomplete)を呼び出すことによって、受信データパスからパケットを削除することもできます。

2.  拡張機能をキャプチャするときに、受信データパスのパケットを取得すると、パケットデータを検査できます。 ただし、拡張機能のキャプチャでは、受信データパスでパケットの送信要求を完了することはできません。 これらの拡張機能は、常に、拡張可能なスイッチドライバースタック内の基になる拡張機能にパケットを転送する必要があります。

    キャプチャ拡張機能は、受信データパスのパケットを生成することもできます。 たとえば、トラフィックの状態をリモート監視アプリケーションに報告するために、拡張機能はパケットを生成する場合があります。

    拡張機能による発信パケットの詳細については、「[発信元パケットトラフィック](originating-packet-traffic.md)」を参照してください。

3.  拡張機能をフィルター処理すると、受信データパスのパケットを取得するときに、次の操作を実行できます。

    -   拡張可能なカスタムスイッチまたはポートポリシーに基づいてパケットを削除します。

        これらのポリシーの詳細については、「 [Hyper-v 拡張可能スイッチポリシー](hyper-v-extensible-switch-policies.md)」を参照してください。

        **メモ** 受信データパスで取得されたパケットには、パケットの OOB データで定義されている宛先ポートがありません。 そのため、拡張機能のフィルター選択では、パケットデータ、パケットの発信元ポート、またはネットワークアダプター接続に基づくカスタムポリシーのみを適用する必要があります。




-   受信データパスから取得したパケットを複製または変更します。

-   新しいパケットを受信データパスに挿入します。


4.  NDIS 6.40 以降では、拡張機能のキャプチャとフィルター処理の後、受信データパスの転送拡張機能の前に、拡張可能なスイッチは次の処理を実行します。
    -   パケットが外部ネットワークアダプターからの NVGRE パケットの場合、パケットヘッダー内のアドレスはプロバイダーアドレス (PA) 空間アドレスになります。 拡張可能スイッチは、パケットの帯域外 (OOB) 情報に**NativeForwardingRequired**フラグを設定することによってこれを示します。 詳細については、「[ハイブリッド転送](hybrid-forwarding.md)」を参照してください。

    -   拡張可能なスイッチは、組み込みの受信ポリシーをパケットに適用します。 これらのポリシーには、受信アクセス制御リスト (Acl)、DHCP ガード、およびルーターガードが含まれる場合があります。

5.  拡張可能なスイッチドライバースタックで転送拡張機能が有効になっていない場合、パケットの宛先ポート配列は拡張可能スイッチによって決定されます。

6.  転送拡張機能が有効になっている場合は、受信データパスでパケットを取得するときに、次の操作を行う必要があります。

    -   NDIS 6.40 以降では、パケットが NVGRE パケット (「[ハイブリッド転送](hybrid-forwarding.md)」を参照) である場合、転送拡張機能は、受信データパス内のパケットの OOB データ内の宛先ポート配列を変更できません。 ただし、パケットを削除することはできます。

    -   パケットが NVGRE パケットでない場合、転送拡張機能は、パケットの OOB データ内の宛先ポート配列に宛先ポートを追加する必要があります。

    -   転送拡張機能は、標準またはカスタムの拡張可能スイッチまたはポートポリシーに基づいてパケットを削除する必要があります。 標準のスイッチまたはポートのポリシーには、セキュリティと仮想 LAN (VLAN) のプロパティが含まれます。 拡張可能なスイッチドライバースタックで転送拡張機能が有効になっていない場合、これらのポリシーは拡張可能スイッチによって適用されます。

        **メモ** 転送拡張機能は、受信データパスのパケットをフィルター処理するときに、発信元ポートと、拡張機能によってパケットに割り当てられた宛先ポートに基づいてフィルタリング規則を適用します。




また、転送拡張機能は次の操作を実行できます。

-   受信データパスから取得したパケットを複製または変更します。

-   新しいパケットを受信データパスに挿入します。


### <a name="underlying-miniport-edge"></a>基になるミニポートエッジ

1.  拡張可能スイッチの基になるミニポートエッジにパケットが到着すると、拡張可能なスイッチによって組み込みのポリシーがパケットに適用されます。 これらのポリシーには、アクセス制御リスト (Acl) およびサービスの品質 (QoS) プロパティが含まれます。 これらのポリシーのためにパケットが破棄されない場合、拡張可能スイッチはパケットの受信を通知し、パケットを送信データパスの上に転送します。

    **メモ** パケットが配信されるポートでポートミラーリングが有効になっている場合、ミニポートエッジは、ミラーポートのパケットの OOB データに宛先ポートを追加します。 ミニポートエッジは、拡張可能なスイッチドライバースタックに転送拡張機能がインストールされ、有効になっているかどうかに関係なく、この動作を行います。 パケットの宛先ポートの配列にまだ指定されていない場合、ミニポートエッジはミラーポートのみを追加します。



2.  転送拡張機能が有効になっていない場合は、拡張可能スイッチによってパケットの宛先ポートが決定され、パケットを送信データパスの前に転送する前に、これらの宛先ポートがパケットの OOB データに追加されます。

3.  NDIS 6.40 以降では、HNV コンポーネントは、受信後および送信前に、必要な NVGRE カプセル化またはカプセル化解除を実行します。これにより、転送拡張機能は、カプセル化されたパケットとカプセル化解除フォームを参照できます。 たとえば、外部ネットワークアダプターから送信されたパケットが内部 VM 用である場合、転送拡張機能は、受信時とカプセル化解除パケットの送信時に、カプセル化されたパケットを取得します。

    **メモ** カプセル化されたパケットでは、パケットヘッダーのアドレスはプロバイダーアドレス (PA) 空間アドレスです。 カプセル化解除パケットでは、これは顧客のアドレス (CA) 空間アドレスです。



    1.  パケットが外部ネットワークアダプターから到着した NVGRE パケットの場合、拡張可能スイッチの Hyper-v ネットワーク仮想化 (HNV) コンポーネントは、パケット上で NVGRE カプセル化解除を実行します。 Hnv コンポーネントは HNV ポリシーに従ってパケットの送信先を決定し、拡張可能スイッチは送信データパスの上にパケットを転送します。

    2.  パケットが内部 VM から到着した場合、hnv ポリシーがパケットに対して設定されている場合、HNV コンポーネントはパケットで NVGRE カプセル化を実行します。 Hnv コンポーネントは HNV ポリシーに従ってパケットの送信先を決定し、拡張可能スイッチは送信データパスの上にパケットを転送します。

    3.  それ以外の場合、転送拡張機能はパケットを送信データパスの上に転送します。

4.  NDIS 6.30 では、転送拡張機能が有効になっている場合、送信データパスの上にパケットを転送する必要があります。

### <a name="egress-data-path"></a>送信データパス

1.  拡張機能は、 [*FilterReceiveNetBufferLists*](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-filter_receive_net_buffer_lists)関数が呼び出されたときに、送信データパスからパケットを取得します。 拡張機能は、 [**NdisFIndicateReceiveNetBufferLists**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/nf-ndis-ndisfindicatereceivenetbufferlists)を呼び出すことにより、パケットを送信データパスの後続の拡張機能に転送します。 拡張機能のフィルター処理と転送では、 [**NdisFReturnNetBufferLists**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/nf-ndis-ndisfreturnnetbufferlists)を呼び出すことによって、送信データパスからパケットを削除することもできます。

2.  転送拡張機能は、送信データパスのパケットを取得するときに、OOB データ内のパケットの宛先ポート情報を検査できます。

    **メモ** 拡張機能は、 [*GetNetBufferListDestinations*](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-ndis_switch_get_net_buffer_list_destinations)を呼び出すことによって、この情報を OOB データから取得します。




拡張機能は、標準またはカスタムのスイッチまたはポートポリシーに基づいて、OOB データ内に含まれる1つまたは複数の宛先ポートへのパケットの配信を除外できます。


3.  NDIS 6.40 (Windows Server 2012 R2) 以降では、転送拡張機能の後、送信データパスのフィルターおよびキャプチャ拡張機能の前に、拡張可能なスイッチによって、組み込みの送信ポリシーがパケットに適用されます。 これらのポリシーには、トランクモード、監視モード、送信 Acl、サービスの品質 (QoS) プロパティなどがあります。

4.  拡張機能をフィルター処理すると、送信データパスのパケットが取得され、OOB データ内のパケットの宛先ポート情報を調べることができます。 拡張機能は、カスタムスイッチまたはポートポリシーに基づいて、OOB データ内に含まれる1つまたは複数の宛先ポートへのパケットの配信を除外できます。

    フィルター拡張機能でパケット内のデータを変更する必要がある場合は、まずポートの宛先を保持せずにパケットを複製する必要があります。 次に、拡張機能は、変更されたパケットを受信データパスに挿入する必要があります。 これにより、基になる拡張機能で、変更されたパケットにポリシーを適用し、転送拡張機能がポートの宛先を追加できるようになります。

    詳細については、「[複製またはパケットトラフィック](cloning-or-duplicating-packet-traffic.md)」を参照してください。

5.  拡張機能をキャプチャするときは、パケットデータを検査できます。 ただし、トラフィックの状態をリモート監視アプリケーションに報告するためにキャプチャ拡張機能がパケットを発信する必要がある場合、 [**NdisFSendNetBufferLists**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/nf-ndis-ndisfsendnetbufferlists)を呼び出してこのパケットトラフィックを送信する必要があります。受信データパス。

6.  拡張可能スイッチのプロトコルエッジでパケットが到着すると、拡張可能なスイッチインターフェイスは、指定されたすべての宛先ポートにパケットを転送します。

7.  パケットが転送されると、インターフェイスは同じパスを逆方向に通過してパケットを完了します。 まず、インターフェイスは、出力データパスで転送されたパケットを完了するために、拡張機能の[*Filterreturnnetbufferlists*](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-filter_return_net_buffer_lists)関数を呼び出します。 次に、インターフェイスは、受信データパスで転送されたパケットを完了するために、拡張機能の[*FilterSendNetBufferListsComplete*](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-filter_send_net_buffer_lists_complete)関数を呼び出します。

    送信と受信の両方のデータパスでパケットが完了すると、必要になる可能性のあるパケットのクリーンアップと後処理が拡張機能によって実行されます。
