---
title: 拡張可能スイッチのデータ パスを通じてパケットのフロー
description: 拡張可能スイッチのデータ パスを通じてパケットのフロー
ms.assetid: 9236CE95-F959-445F-849F-14377EE91D19
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: e74665598e19624152a1cc72075e5c5a6c57dd53
ms.sourcegitcommit: a33b7978e22d5bb9f65ca7056f955319049a2e4c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/31/2019
ms.locfileid: "56551330"
---
# <a name="packet-flow-through-the-extensible-switch-data-path"></a>拡張可能スイッチのデータ パスを通じてパケットのフロー


このトピックでは、パケットが HYPER-V 拡張可能スイッチのデータ パスで拡張可能スイッチ ポートとの間を移動する方法について説明します。

**注**、拡張可能スイッチのインターフェイスで NDIS フィルター ドライバーと呼ばれる*拡張可能スイッチの拡張機能*と呼ばれるドライバー スタック、*ドライバー スタックの拡張可能スイッチ*します。 拡張機能に関する詳細については、次を参照してください。 [Hyper-v 拡張可能スイッチ拡張機能](hyper-v-extensible-switch-extensions.md)します。



**注**このページは、内の情報に精通していることを前提としています。 [Hyper-v 拡張可能スイッチの概要](overview-of-the-hyper-v-extensible-switch.md)と[ハイブリッド転送](hybrid-forwarding.md)します。



そのポートからの拡張可能スイッチに到達したすべてのパケット トラフィックでは、拡張可能スイッチのドライバー スタックを通じて同じパスに従います。 など、仮想マシン (VM) ネットワーク アダプターの接続から送信された、または外部ネットワーク アダプターの接続から受信したパケット トラフィックは、同じのデータ パスを移動します。

次の図には、NDIS 6.40 (Windows Server 2012 R2) と後で拡張可能スイッチ データ パスが表示されます。

![説明する図ハイパー\-ndis 6.40 およびそれ以降の v 拡張可能スイッチのアーキテクチャ](images/vswitcharchitecture-ndis640.png)

次の図では、NDIS 6.30 (Windows Server 2012) の拡張可能スイッチ データ パスが表示されます。

![sr-iov 対応の合成デバイスのデータ パスを示す図](images/vswitcharchitecture.png)

拡張可能スイッチのインターフェイスのコンポーネントの詳細については、次を参照してください。 [Hyper-v 拡張可能スイッチのアーキテクチャ](hyper-v-extensible-switch-architecture.md)します。

拡張可能スイッチのデータ パスには、それらのパケットがフローする順序で一覧表示、次の部分があります。

-   [上位のプロトコル エッジ](#overlying-protocol-edge)
-   [イングレス データのパス](#ingress-data-path)
-   [基になるミニポート エッジ](#underlying-miniport-edge)
-   [出口データ パス](#egress-data-path)

### <a name="overlying-protocol-edge"></a>上位のプロトコル エッジ

1.  パケットは、スイッチ ポートに接続されているネットワーク アダプターからの拡張可能スイッチに到達します。 これらのパケットは、まず、拡張可能スイッチのイングレス データ パスを拡張可能スイッチのプロトコルのエッジからの要求を送信するために発行されます。

    拡張可能スイッチのプロトコルのエッジは、イングレス データ パスのパケットを準備します。 コンテキストの領域は、プロトコル edge は、アウト オブ バンド (OOB) の拡張可能スイッチ転送コンテキストを含むこれらのパケットを割り当てます。 元のパケットは拡張可能スイッチに配信されたソース ポートおよびネットワーク アダプター接続に関する情報を OOB データを設定します。

    転送コンテキストに関する詳細については、次を参照してください。 [Hyper-v 拡張可能スイッチの転送コンテキスト](hyper-v-extensible-switch-forwarding-context.md)します。

2.  パケットが外部ネットワーク アダプターから、NVGRE パケットの場合は、拡張可能スイッチ NDIS 6.40 (Windows Server 2012 R2) 以降では、設定、 **NativeForwardingRequired**パケットのアウト オブ バンド (OOB) の情報のフラグ。 詳細については、次を参照してください。[ハイブリッド転送](hybrid-forwarding.md)します。

3.  場合は、パケットが、トラフィックが仮想サブネットを持つポートに到着した、拡張可能スイッチの設定、 **VirtualSubnetId**のメンバー、 [ **NDIS\_NET\_バッファー\_一覧\_仮想\_サブネット\_情報**](https://msdn.microsoft.com/library/windows/hardware/jj614359)パケットの構造体。

    **注**仮想サブネットは、HNV のサブネットまたはサード パーティ製の仮想サブネットになります。



### <a name="ingress-data-path"></a>イングレス データのパス

1.  イングレス データのパスからパケットを取得する拡張機能とその[ *FilterSendNetBufferLists* ](https://msdn.microsoft.com/library/windows/hardware/ff549966)関数が呼び出されます。 拡張機能は、呼び出すことによって拡張機能を基になる、イングレス データ パスにパケットを転送[ **NdisFSendNetBufferLists**](https://msdn.microsoft.com/library/windows/hardware/ff562616)します。 フィルター処理および転送拡張機能も削除できますパケット イングレス データのパスから呼び出すことによって[ **NdisFSendNetBufferListsComplete**](https://msdn.microsoft.com/library/windows/hardware/ff562618)します。

2.  キャプチャ拡張機能は、パケットの受信データ パスを取得、ときに、パケット データを調べる。 ただし、拡張機能をキャプチャする必要がありますを完了できません、イングレス データ パス上のパケットの送信要求。 これらの拡張機能では、基になる拡張機能は拡張可能スイッチ ドライバー スタックのパケットを常に転送する必要があります。

    キャプチャ拡張機能は、イングレス データ パス上のパケットも取得できます。 たとえば、拡張機能は、リモート監視アプリケーションにトラフィックの状態を報告する順序でパケットを発生させてよい場合します。

    拡張機能により、パケットを送信元の詳細については、次を参照してください。[パケットの発信トラフィック](originating-packet-traffic.md)します。

3.  フィルター拡張機能は、パケットの受信データ パスを取得、ときに、次を実行します。

    -   カスタムの拡張可能スイッチまたはポート ポリシーに基づいて、パケットを削除します。

        これらのポリシーの詳細については、次を参照してください。 [Hyper-v 拡張可能なスイッチ ポリシー](hyper-v-extensible-switch-policies.md)します。

        **注**イングレス データ パス取得したパケットはパケットの OOB データに定義されている変換先のポートはありません。 その結果、拡張機能をフィルター処理する必要がありますのみカスタム ポリシーを適用パケット データ パケットの発信元ポートまたはネットワーク アダプターの接続に基づきます。




-   複製するか、イングレス データ パスから取得したパケットを変更します。

-   イングレス データのパスには、新しいパケットを挿入します。


4.  NDIS 6.40 以降では、キャプチャし、フィルター拡張機能が、イングレス データ パス上の転送拡張機能の前に、拡張可能スイッチは、次の。
    -   パケットが外部ネットワーク アダプターから、NVGRE パケットの場合は、パケット ヘッダーのアドレス、プロバイダー アドレス (PA) 空間アドレスです。 拡張可能スイッチでは、これを示す設定して、 **NativeForwardingRequired**パケットのアウト オブ バンド (OOB) の情報のフラグ。 詳細については、次を参照してください。[ハイブリッド転送](hybrid-forwarding.md)します。

    -   拡張可能スイッチには、パケットに組み込みのイングレス ポリシーが適用されます。 これらのポリシーは、受信アクセス制御リスト (Acl)、DHCP ガードとルーター ガードを含めることができます。

5.  転送拡張機能が拡張可能スイッチのドライバー スタックで有効でない場合、パケットの宛先ポート配列は拡張可能スイッチによって決定されます。

6.  転送拡張機能が有効になっている場合、パケットの受信データ パスを取得する場合、次を行う必要があります。

    -   NDIS 6.40 以降の場合、パケットは、NVGRE パケット (を参照してください[ハイブリッド転送](hybrid-forwarding.md))、転送拡張機能は、イングレス データ パス内のパケットの OOB データのコピー先のポート配列を変更できません。 ただし、パケットを削除することができます。

    -   パケットが、NVGRE パケットでない場合、転送拡張機能は、OOB データ パケットの宛先ポート配列に変換先のポートを追加する必要があります。

    -   転送拡張機能は、標準またはカスタムの拡張可能スイッチまたはポート ポリシーに基づいて、パケットを削除する必要があります。 標準スイッチまたはポートのポリシーには、セキュリティおよび仮想 LAN (VLAN) のプロパティが含まれます。 転送拡張機能が拡張可能スイッチのドライバー スタックで有効でない場合、これらのポリシーは、拡張可能スイッチによって適用されます。

        **注**転送拡張機能では、イングレス データ パス内のパケット フィルター処理、フィルタ リング規則の宛先ポート、パケットに、拡張機能を代入すると、ソース ポートに基づいて適用されます。




さらに、転送拡張機能は、次の操作にできます。

-   複製するか、イングレス データ パスから取得したパケットを変更します。

-   イングレス データのパスには、新しいパケットを挿入します。


### <a name="underlying-miniport-edge"></a>基になるミニポート エッジ

1.  拡張可能スイッチの基になるミニポート エッジで、パケットが到着すると、拡張可能スイッチには、パケットに組み込みのポリシーが適用されます。 品質 (QoS) のプロパティのサービスおよびこれらのポリシーにはアクセス制御リスト (Acl) が含まれます。 これらのポリシーのために、パケットが削除されない場合、拡張可能スイッチは、パケットの受信方向の発生元し、エグレス データのパスをパケットを転送します。

    **注**ミニポート エッジが、ミラー ポートのパケットの OOB データに宛先ポートを追加しますへの配信にパケットがあるポートのポート ミラーリングが有効になっている場合。 ミニポート エッジ転送拡張機能がインストールされているし、拡張可能スイッチ ドライバー スタックで有効になっているかどうかに関係なく行われます。 ミニポート edge は、パケットの宛先ポートの配列で指定されていない場合にのみ、ミラー ポートを追加します。



2.  転送拡張機能が有効でない場合、拡張可能スイッチは、パケットの宛先ポートを決定し、エグレス データのパスをパケットを転送する前に、パケットの OOB データにこれらの宛先ポートを追加します。

3.  NDIS 6.40 以降では、HNV コンポーネントによって実行される任意の必要な NVGRE カプセル化またはカプセル化解除のイングレスとエグレス、転送拡張機能は、パケットを確認できるようにカプセル化およびカプセル化解除されたフォーム。 たとえば、パケットが外部ネットワーク アダプターから、内部の VM の送信先が場合、転送拡張機能には受信時のカプセル化されたパケットと送信時のカプセル化解除されたパケットが取得します。

    **注**カプセル化されたパケットの場合、パケット ヘッダーに指定されたアドレスは、プロバイダー アドレス (PA) 空間のアドレス。 カプセル化解除されたパケットのカスタマー アドレス (CA) 空間アドレスになります。



    1.  パケットが外部ネットワーク アダプターから受信した、NVGRE パケットの場合は、拡張可能スイッチの HYPER-V ネットワーク仮想化 (HNV) のコンポーネントは、パケットに NVGRE カプセル化解除を実行します。 HNV コンポーネントは、HNV のポリシーに従って、パケットの送信先を決定します。 し、拡張可能スイッチが出口データ パスをパケットを転送します。

    2.  内部の VM からはパケットの到着された場合のパケットのパケットの HNV ポリシーが設定されている場合、HNV のコンポーネントに NVGRE カプセル化が実行されます。 HNV コンポーネントは、HNV のポリシーに従って、パケットの送信先を決定します。 し、拡張可能スイッチが出口データ パスをパケットを転送します。

    3.  それ以外の場合、転送拡張機能は、エグレス データのパスをパケットを転送します。

4.  NDIS 6.30、転送拡張機能が有効になっている場合にする必要がありますパケットの転送、egress データ パスを。

### <a name="egress-data-path"></a>出口データ パス

1.  出口データ パスからパケットを取得する拡張機能とその[ *FilterReceiveNetBufferLists* ](https://msdn.microsoft.com/library/windows/hardware/ff549960)関数が呼び出されます。 拡張機能が出口のデータ パスでの拡張機能を呼び出すことによって関連するパケットを転送[ **NdisFIndicateReceiveNetBufferLists**](https://msdn.microsoft.com/library/windows/hardware/ff561820)します。 フィルター処理および転送拡張機能も削除できますパケット エグレス データのパスから呼び出すことによって[ **NdisFReturnNetBufferLists**](https://msdn.microsoft.com/library/windows/hardware/ff562613)します。

2.  転送拡張機能は、送信データ パス上のパケットを取得するときに、OOB データ パケットの宛先ポート情報を検査できます。

    **注**、拡張機能は、呼び出すことによって OOB データからこの情報を取得[ *GetNetBufferListDestinations*](https://msdn.microsoft.com/library/windows/hardware/hh598157)します。




拡張機能は、標準またはカスタムのスイッチまたはポートのポリシーに基づき、パケットの OOB データ内に含まれる 1 つまたは複数の宛先ポートへの配信を除外できます。


3.  NDIS 6.40 (Windows Server 2012 R2) 以降では、転送拡張機能の後が、フィルター処理して、エグレス データ パスでの拡張機能をキャプチャする前に、拡張可能スイッチ、組み込みのエグレスにポリシーを適用、パケット。 これらのポリシーは、モード、エグレス Acl、およびサービス (QoS) のプロパティの品質を監視、トランク モードを含めることができます。

4.  フィルター拡張機能は、送信データ パス上のパケットを取得と、OOB データ パケットの宛先ポート情報を調べる。 拡張機能は、カスタム スイッチまたはポートのポリシーに基づき、パケットの OOB データ内に含まれる 1 つまたは複数の宛先ポートへの配信を除外できます。

    フィルター処理の拡張機能は、データ パケットを変更する必要があります、ポートの送信先を維持せず、パケットを最初に複製にする必要があります。 次に、拡張機能では、イングレス データのパスに変更されたパケットを挿入する必要があります。 これにより、変更されたパケットのポリシーを適用する基になる拡張機能と、転送拡張機能は、ポートの送信先を追加できます。

    詳細については、次を参照してください。[複製またはパケット トラフィック](cloning-or-duplicating-packet-traffic.md)します。

5.  出口データ パス上のパケットをキャプチャ拡張機能を取得時に、パケット データを調べる。 ただし、キャプチャ拡張機能をリモート監視アプリケーション トラフィックの状態を報告する順序でパケットを送信する場合、その送信される必要がこのパケット トラフィックを呼び出して[ **NdisFSendNetBufferLists**](https://msdn.microsoft.com/library/windows/hardware/ff562616)イングレス データ パス上の送信操作を開始します。

6.  拡張可能スイッチの上にあるプロトコル エッジで、パケットが到着すると、拡張可能スイッチのインターフェイスは、すべての指定された宛先ポートにパケットを転送します。

7.  パケットを転送すると後のインターフェイスは、逆の順序で同じパスを介してパケットを完了します。 インターフェイスが、拡張機能を呼び出す最初に、 [ *FilterReturnNetBufferLists* ](https://msdn.microsoft.com/library/windows/hardware/ff549964)エグレス データのパスに転送されたパケットを完了する関数。 インターフェイスの拡張機能の呼び出し、 [ *FilterSendNetBufferListsComplete* ](https://msdn.microsoft.com/library/windows/hardware/ff549967)イングレス データ パスに転送されたパケットを完了する関数。

    イングレスとエグレスの両方のデータ パスは、パケットが完了したら、拡張機能は、パケットが必要なクリーンアップを実行し、必要な後処理にあります。
