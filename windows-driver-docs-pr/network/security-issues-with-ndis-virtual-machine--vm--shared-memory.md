---
title: NDIS 仮想マシン (VM) 共有メモリのセキュリティ上の問題
description: NDIS 仮想マシン (VM) 共有メモリのセキュリティ上の問題
ms.assetid: 42b903b0-6729-4314-9305-9345fff9b2ba
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 506040eca4172570cfa0013383f4218118f27c6b
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72841988"
---
# <a name="security-issues-with-ndis-virtual-machine-vm-shared-memory"></a>NDIS 仮想マシン (VM) 共有メモリのセキュリティ上の問題





このトピックでは、仮想マシン (VM) からの共有メモリの割り当てに関連する潜在的なセキュリティの問題について説明します。 このトピックには、次のセクションが含まれています。

-   [VM 共有メモリに関するセキュリティの問題の概要](#overview)

-   [Windows Server 2008 R2 でのセキュリティの問題への対処方法](#ndis620)

-   [Windows Server 2012 以降のバージョンでのセキュリティの問題への対処方法](#ndis630)

**注**  hyper-v では、子パーティションは VM とも呼ばれます。

 

### <a href="" id="overview"></a>VM 共有メモリに関するセキュリティの問題の概要

Vm は信頼されたソフトウェアエンティティではありません。 つまり、悪意のある VM は、Hyper-v の親パーティションで実行されている他の Vm または管理オペレーティングシステムと干渉することはできません。 ここでは、ドライバーの作成者が VMQ のセキュリティの問題と共有メモリの要件を理解できるように、背景情報と要件について説明します。 共有メモリの詳細については、「 [VMQ ドライバーの作成](writing-vmq-drivers.md)」セクションの「[共有メモリリソースの割り当て](shared-memory-resource-allocation.md)」を参照してください。

仮想化環境では、vm で VM 共有メモリを表示または変更できます。 ただし、他の Vm に関連付けられているデータを表示または変更することはできません。 Vm は、管理操作アドレス空間にアクセスすることもできません。

受信したパケットのヘッダー部分は、保護されている必要があります。 VM は、ネットワーク仮想サービスプロバイダー (VSP) での Hyper-v 拡張可能スイッチの動作に影響を与えることはできません。 そのため、ネットワークアダプターが DMA を使用して VM 共有メモリにデータを転送する前に、VLAN (仮想 LAN) フィルター処理が行われる必要があります。 また、スイッチのメディアアクセス制御 (MAC) アドレスの学習は影響を受けません。

VM に接続されている Hyper-v 拡張可能スイッチポートに関連付けられている VLAN 識別子がある場合、ホストコンピューターは、宛先 MAC アドレスと受信フレームの VLAN 識別子がホストの前にあるポートの属性と一致していることを確認する必要があります。パケットを VM の仮想ネットワークアダプターに転送します。 フレームの VLAN 識別子がポートの VLAN 識別子と一致しない場合、パケットは破棄されます。 仮想ネットワークアダプターの受信バッファーがホストメモリから割り当てられると、ホストは、フレームの内容をターゲット VM に表示する前に、VLAN 識別子を確認し、必要に応じてフレームをドロップすることができます。 フレームが VM のアドレス空間にコピーされていない場合、その VM からはアクセスできません。

ただし、VMQ が共有メモリを使用するように構成されている場合、ネットワークアダプターは DMA を使用して受信フレームを VM アドレス空間に直接転送します。 この転送では、拡張可能スイッチによって必要な VLAN フィルターが適用されるのを待たずに、受信したフレームの内容を VM が調べることができるセキュリティの問題が発生します。

### <a href="" id="ndis620"></a>Windows Server 2008 R2 でのセキュリティの問題への対処方法

Windows Server 2008 R2 では、VSP が vm アドレス空間から割り当てられた共有メモリを使用するように VM キューを構成する前に、キューに対して次のフィルターテストを使用します。

```syntax
(MAC address == x) && (VLAN identifier == n)
```

ネットワークアダプターのハードウェアが、受信バッファーへの DMA 転送前にこのテストをサポートできる場合、ネットワークアダプターは、無効な VLAN 識別子を持つフレームを削除するか、または拡張可能スイッチによってフィルターで除外されるように既定のキューに送信することができます。 このテストをキューで設定するためにミニポートドライバーが要求で成功した場合、拡張可能なスイッチはそのキューに対して VM 共有メモリを使用できます。 ただし、ネットワークアダプターのハードウェアが宛先の MAC アドレスと VLAN 識別子の両方に基づいてフレームをフィルター処理できない場合、拡張可能なスイッチはそのキューのホスト共有メモリを使用します。

拡張可能スイッチは、受信フレームのソース MAC アドレスを調べて、送信フレームのルーティング情報を構成します。つまり、物理的な学習スイッチに似ています。 ファイアウォールフィルタードライバーをホストスタックにインストールすることができます。たとえば、ネットワークアダプターハードウェアのミニポートドライバーの上、および拡張可能なスイッチドライバーの下にあります。 ファイアウォールフィルタードライバーは、拡張可能なスイッチの前に、受信したフレームのデータにアクセスできます。 各フレームの受信バッファー全体が VM アドレス空間から割り当てられている場合、悪意のある VM は、フィルタードライバーまたはホストで実行されている拡張可能スイッチのいずれかによって検査されるフレームの一部にアクセスする可能性があります。

このセキュリティの問題に対処するために、vm キューに VM 共有メモリを使用する場合、ネットワークアダプターは、少なくとも事前に定義された固定値である、少なくとも先読みサイズのバイトオフセットでパケットを分割する必要があります。 先読みデータ (先読みサイズのバイトオフセットより前のデータ) は、先読みデータ用に割り当てられた共有メモリに DMA で転送する必要があります。 先読み後のデータ (フレームペイロードの残りの部分) は、先読みデータ用に割り当てられた共有メモリに DMA で転送する必要があります。

次の図は、受信データが先読みと先読み後の共有メモリバッファーに分割される場合の、ネットワークデータ構造の関係を示しています。

![先読みと先読みデータを使用した vmq パケット構造を示す図](images/vmqpacket.png)

VMQ 共有メモリの概要要件は次のとおりです。

-   ネットワークアダプターは、受信したフレームを、先読みサイズを超えるネットワークヘッダー境界で分割できます。 ただし、NDIS によって要求され、例外が発生しない場合は、すべてのフレームを受信し、VMQ に割り当てられているすべてのフレームを、NDIS が要求する先読みサイズの境界を超えて分割する必要があります。

-   先読みデータは、ミニポートドライバーによって割り当てられる共有メモリに DMA を使用して転送する必要があります。 ミニポートドライバーでは、メモリが先読みデータに使用されるように、割り当て呼び出しでを指定する必要があります。

-   先読み後のデータは、ミニポートドライバーによって割り当てられる共有メモリに DMA を使用して転送する必要があります。 ミニポートドライバーは、メモリが先読み後のデータに使用されるように、割り当て呼び出しでを指定する必要があります。

-   ミニポートドライバーは、NDIS が共有メモリ割り当て要求を完了するために使用するアドレス空間に依存しないようにする必要があります。 つまり、先読みまたは事後先読みデータ用の共有メモリアドレス空間は実装固有です。 多くの場合、NDIS または拡張可能なスイッチは、ホストメモリアドレス空間からの事後先読みのための要求を含むすべての要求を満たすことができます。

-   VMQ 受信キューでフレームが受信される順序は、そのキュー内のフレームがドライバースタックで示されるときに保持される必要があります。

-   ネットワークアダプターは、先読み後の各バッファーに十分なバックフィルメモリ領域を割り当てる必要があります。 この割り当てにより、先読みデータを先読みバッファーのバックフィル部分にコピーできるようになり、フレームを連続したバッファー内の VM に配信できるようになります。

VMQ 共有メモリのこれらの要件を満たすためのメカニズムがハードウェアにない場合、受信側でスキャッター/ギャザー DMA をサポートするハードウェアでは、受信した各フレームに2つの受信バッファーを割り当てることで同じ結果が得られる可能性があります。 この場合、最初のバッファーのサイズは、要求された先読みサイズに制限されます。

ネットワークアダプターがいずれかの方法で VMQ 共有メモリの要件を満たしていない場合、VSP は、ホストアドレス空間から VMQ 受信バッファーにメモリを割り当て、ネットワークアダプターの受信バッファーから VM アドレスに受信したパケットをコピーします。行間.

### <a href="" id="ndis630"></a>Windows Server 2012 以降のバージョンでのセキュリティの問題への対処方法

Windows Server 2012 以降、VSP は、VMQ 受信バッファー用に VM から共有メモリを割り当てません。 代わりに、VSP は、ホストアドレス空間から VMQ 受信バッファーにメモリを割り当て、受信したパケットをネットワークアダプターの受信バッファーから VM アドレス空間にコピーします。

Windows Server 2012 以降のバージョンの Windows で実行される VMQ ミニポートドライバーには、次の点が適用されます。

-   NDIS 6.20 VMQ ミニポートドライバーの場合、変更は必要ありません。 ただし、VSP が oid (オブジェクト識別子) メソッドの\_Oid 要求を発行することによって VM キューを割り当てたときに、 [\_キューを割り当てる\_\_フィルターを受け取る](https://docs.microsoft.com/windows-hardware/drivers/network/oid-receive-filter-allocate-queue)と、 [**NDIS\_receive\_queue\_PARAMETERS**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ntddndis/ns-ntddndis-_ndis_receive_queue_parameters)構造体の**look aヘッドのサイズ**メンバーが0に設定されます。 これにより、ミニポートドライバーはパケットを事前先読みバッファーと先読みバッファーに分割しません。

-   NDIS 6.30 以降では、VMQ ミニポートドライバーは、パケットデータを事前先読みバッファーと先読みバッファーに分割するためのサポートをアドバタイズしないようにする必要があります。 ミニポートドライバーは VMQ 機能を登録するときに、次の規則に従って、 [ **\_フィルター\_機能**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ntddndis/ns-ntddndis-_ndis_receive_filter_capabilities)の構造を受け取るように NDIS\_受信します。

    -   ミニポートドライバーでは、**フラグ**メンバーで **\_フィルター\_先読み\_分割\_サポートされている**フラグを受け取るように、NDIS\_受信するように設定することはできません。

    -   ミニポートドライバーでは、 **Minlook Aヘッドの splitsize**メンバーと**Minlook Aヘッドの splitsize**メンバーを0に設定する必要があります。

    VMQ 機能を登録する方法の詳細については、「[ネットワークアダプターの Vmq 機能の決定](determining-the-vmq-capabilities-of-a-network-adapter.md)」を参照してください。

 

 





