---
title: 拡張可能スイッチ データ パスのパケット管理ガイドライン
description: 拡張可能スイッチ データ パスのパケット管理ガイドライン
ms.assetid: 18B2BCBA-8428-45CF-93A0-8F7182DBCAA2
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 34c679f45576d15d2e2e838011ceb82d6512ed45
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72843710"
---
# <a name="packet-management-guidelines-for-the-extensible-switch-data-path"></a>拡張可能スイッチ データ パスのパケット管理ガイドライン


このトピックでは、拡張可能なスイッチのデータパスで取得したパケットを管理するために、Hyper-v 拡張スイッチ拡張機能が従う必要があるガイドラインについて説明します。

**注**  拡張可能なスイッチインターフェイスでは、NDIS フィルタードライバーは拡張*可能なスイッチ拡張機能*と呼ばれ、ドライバースタックは*拡張可能なスイッチドライバースタック*と呼ばれます。 拡張機能の詳細については、「 [Hyper-v 拡張可能スイッチ拡張機能](hyper-v-extensible-switch-extensions.md)」を参照してください。

 

**注**  このページでは、 [Hyper-v の拡張可能スイッチ](overview-of-the-hyper-v-extensible-switch.md)と[ハイブリッド転送](hybrid-forwarding.md)の概要に関する情報と図について理解していることを前提としています。

 

拡張機能は、拡張可能なスイッチのデータパスでのパケット管理に関する次のガイドラインに従う必要があります。

-   パケットを発信する拡張機能は、受信データパスで送信要求を開始するために[**NdisFSendNetBufferLists**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/nf-ndis-ndisfsendnetbufferlists)を呼び出す必要があります。 これは、拡張可能なスイッチを介してパケットを適切に転送できるようにするために、この方法で実行する必要があります。

-   キャプチャ拡張機能は、拡張可能スイッチの受信と送信のデータパスのパケットを監視できます。 ただし、この種類の拡張機能では常にパケットを転送する必要があり、パケットを削除することはできません。 また、パケットを転送する前に、キャプチャ拡張機能がパケットデータを変更しないようにする必要があります。

-   拡張可能スイッチの受信データパスでは、フィルター処理と転送拡張機能で次の操作を実行できます。

    -   フィルター拡張機能は、パケットトラフィックをフィルター処理し、拡張可能スイッチを介したパケット配信に対してカスタムポートまたはスイッチポリシーのみを適用できます。 拡張機能が受信データパスのパケットをフィルター処理するときは、パケットの送信元ポートおよびネットワークアダプター接続のみに基づいてフィルター規則を適用できます。 この情報は、パケットの[**net\_buffer\_list**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/ns-ndis-_net_buffer_list)構造の OOB データに格納されており、 [**net\_buffer\_list**](https://docs.microsoft.com/windows-hardware/drivers/network/net-buffer-list-switch-forwarding-detail)\_\_の転送\_詳細マクロを使用して取得できます。

        受信データパスで取得したパケットに宛先ポートが含まれていない**ことに注意**してください  。 宛先ポートに基づくパケットのフィルター処理は、送信データパスで取得したパケットに対してのみ実行できます。

         

    -   拡張機能の転送では、パケットトラフィックをフィルター処理し、拡張可能スイッチを介してパケットを送信するためのカスタムおよび標準ポートまたはスイッチポリシーを適用できます。 転送拡張機能は、受信データパス内のパケットをフィルター処理するときに、転送拡張機能によってパケットに割り当てられる宛先ポートに加えて、送信元ポートに基づいてフィルタリング規則を適用します。

-   拡張可能なスイッチの送信データパスでは、フィルター処理と転送拡張機能で次の操作を実行できます。

    -   フィルター拡張機能は、パケットトラフィックをフィルター処理し、拡張可能スイッチを介したパケット配信に対してカスタムポートまたはスイッチポリシーのみを適用できます。 フィルター拡張機能によって、送信データパス内のパケットがフィルター処理される場合、パケットの宛先ポートのみに基づいてフィルタリング規則を適用できます。

        宛先ポートデータは、パケットの[**NET\_BUFFER\_LIST**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/ns-ndis-_net_buffer_list)構造の OOB データに格納されます。 拡張機能は、 [*GetNetBufferListDestinations*](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-ndis_switch_get_net_buffer_list_destinations)関数を呼び出すことによってこの情報を取得します。

    -   拡張機能の転送では、パケットトラフィックをフィルター処理し、拡張可能スイッチを介してパケットを送信するためのカスタムおよび標準ポートまたはスイッチポリシーを適用できます。 転送拡張機能によって、送信データパス内のパケットがフィルター処理されるときに、パケットの送信元または送信先ポートに基づいてフィルタリング規則が適用されることがあります。

    -   パケットに適用されるポリシーに基づいて、フィルター処理または転送拡張機能は、1つまたは複数の送信先へのパケットの配信を除外できます。 この手順の詳細については、「[拡張可能スイッチの接続先ポートへのパケット配信の除外](excluding-packet-delivery-to-extensible-switch-destination-ports.md)」を参照してください。

        転送拡張機能は、パケットに適用されたポリシーに基づいて、1つまたは複数の宛先へのパケットの配信を除外できます。 詳細については、「[ハイブリッド転送](hybrid-forwarding.md)」を参照してください。

-   拡張可能なスイッチの送信データパスでは、フィルター処理と転送拡張機能で次の操作を行うことはできません。

    -   送信データパスにパケットを転送する前に、パケットデータを変更します。

        フィルター拡張機能でパケット内のデータを変更する必要がある場合は、まずポートの宛先を保持せずにパケットを複製する必要があります。 次に、拡張機能は、変更されたパケットを受信データパスに挿入する必要があります。 これにより、基になる拡張機能で、変更されたパケットにポリシーを適用し、転送拡張機能がポートの宛先を追加できるようになります。

        転送拡張機能がパケット内のデータを変更する必要がある場合、ポートの宛先を割り当てる前に、まずパケットを複製する必要があります。 パケットが変更され、ポートの宛先が割り当てられると、拡張機能は変更されたパケットを受信データパスに挿入する必要があります。

        詳細については、「[パケットトラフィックの複製](cloning-or-duplicating-packet-traffic.md)」を参照してください。

        **注**  出力データパスで取得されたパケットが拡張機能によって複製される場合、パケットデータを変更しておらず、元の宛先ポートデータを保持している場合にのみ、新しいパケットを送信データパスに挿入できます。

         

    -   パケットを転送する前に、パケットに宛先ポートを追加します。

        **注**  転送拡張機能では、受信データパスで取得したパケットに宛先ポートを追加できます。

         

    -   新規または複製されたデータパケットを送信データパスに挿入します。

-   標準の NDIS データパスでは、非拡張可能スイッチ OOB データは、パケットが送信または受信のどちらとして示されているかによって形式が異なることがよくあります。 たとえば、 [**NDIS\_IPSEC\_オフロード\_V2\_ヘッダー\_NET\_BUFFER\_LIST\_INFO**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/ns-ndis-_ndis_ipsec_offload_v2_header_net_buffer_list_info) OOB data は、送信と受信に固有の構造を結合したものです。

    拡張可能なスイッチのデータパスでは、すべてのパケットが、送信と受信の両方として拡張機能のドライバースタックを経由して移動されます。 このため、パケットの[**NET\_バッファー\_リスト**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/ns-ndis-_net_buffer_list)構造内の非拡張スイッチの OOB データは、ドライバースタックを介してフローが実行されている間、送信形式または受信形式のいずれかになります。

    この OOB データの形式は、拡張可能スイッチでパケットが到着したソース拡張可能なスイッチポートによって異なります。 ソースポートが外部ネットワークアダプターに接続されている場合、非拡張スイッチ OOB データは受信形式になります。 その他のポートの場合、この OOB データは送信形式になります。

    **注**  拡張機能によってパケットの[**NET\_BUFFER\_LIST**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/ns-ndis-_net_buffer_list)構造が複製される場合、oob データを追加または変更する場合は、非拡張スイッチ oob データを考慮に入れる必要があります。 拡張機能は、 [*CopyNetBufferListInfo*](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-ndis_switch_copy_net_buffer_list_info)を呼び出して、拡張可能スイッチのデータパスに関連付けられている OOB データをソースパケットから複製されたパケットにコピーする必要があります。 この関数は、データが複製されたパケットにコピーされるときに、OOB の送信または受信形式を維持します。

     

-   拡張機能が送信データパスの受信からパケットを削除する場合は、 [*ReportFilteredNetBufferLists*](https://docs.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-ndis_switch_report_filtered_net_buffer_lists)を呼び出す必要があります。 この関数が呼び出されると、拡張可能なスイッチインターフェイスによってカウンターがインクリメントされ、削除または除外されたパケットのイベントがログに記録されます。

 

 





