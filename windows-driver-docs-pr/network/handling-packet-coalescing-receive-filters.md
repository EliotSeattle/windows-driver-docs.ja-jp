---
title: パケット結合受信フィルターの処理
description: パケット結合受信フィルターの処理
ms.assetid: 83FF780F-6B8F-4222-90F0-42037FFF7653
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 1d5582964feafa9bd734dd2b85b94b5a6e37b7a9
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72842572"
---
# <a name="handling-packet-coalescing-receive-filters"></a>パケット結合受信フィルターの処理


Oid の OID メソッド要求を通じて、複数の受信フィルターがミニポートドライバーにダウンロードされます。 [\_受信\_フィルター\_設定\_フィルター](https://docs.microsoft.com/windows-hardware/drivers/network/oid-receive-filter-set-filter)です。 各フィルターでは、受信したパケットをアダプターのハードウェア合体バッファーに結合する必要があるかどうかを判断するために、ネットワークアダプターが使用する1つ以上のテスト (*ヘッダーフィールドテスト*) を指定できます。

ミニポートドライバーが受信フィルターを使用してネットワークアダプターを構成する前に、ドライバーはアダプターのハードウェア機能に基づいて受信フィルターを最適化する必要があります。 たとえば、すべての受信フィルターには、MAC ヘッダーに対してヘッダーフィールドのテストが必要です。 このため、ドライバーは、このテストの結果に基づいてフィルター規則を最適化できます。 これにより、アダプターは、次に実行するオープンシステム相互接続 (OSI) レイヤー 3 (L3) とレイヤー 4 (L4) ヘッダーフィールドテストを決定できます。

受信フィルターを使用してネットワークアダプターを構成するとすぐに、次の操作を行う必要があります。

-   結合バッファー内のパケットを結合するために、特定のフィルターのすべてのヘッダーフィールドテストパラメーターが、受信パケットで一致している必要があります。

    ネットワークアダプターは、受信フィルターのすべてのヘッダーフィールドテストの結果を論理 AND 演算で結合します。 つまり、\_NDIS の配列に含まれているいずれかのヘッダーフィールドテストが[ **\_フィルター\_\_フィールドを受信**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ntddndis/ns-ntddndis-_ndis_receive_filter_field_parameters)した場合、受信フィルターのパラメーター構造が失敗した場合、受信パケットは指定されたフィルター条件を満たしていないため、結合することはできません。

-   ネットワークアダプターは、指定されたヘッダーフィールドのテストパラメーターに基づいて、パケットデータだけを検査します。 ヘッダーフィールドのテストが指定されていないパケット内のすべてのヘッダーフィールドは、アダプターによって無視される必要があります。

-   受信パケットが受信フィルターのすべてのヘッダーフィールドテストに一致する場合、ネットワークアダプターは、ハードウェア合体バッファー内のパケットを結合する必要があります。 最初のパケットが結合されると、ネットワークアダプターは、ハードウェアタイマーを開始する必要があります。また、有効期限は、対応する受信フィルターの[ **\_受信\_フィルター\_パラメーター**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ntddndis/ns-ntddndis-_ndis_receive_filter_parameters)構造の NDIS の**MaxCoalescingDelay**メンバーの値に設定する必要があります。

-   パケット合体受信フィルターに一致するパケットをさらに受信すると、ネットワークアダプターによってそれらが合体バッファーに格納されます。

    ハードウェアタイマーが既に実行されている場合、アダプターは、一致する受信フィルターのタイマーを停止または再起動することはできません。 ただし、アダプターは、一致する受信フィルターから最小の有効期限の値を使用してハードウェアタイマーを構成できます。 たとえば、受信フィルター *X*に一致するパケットがドライバーによって受信されると、アダプターはその受信フィルターに対して指定された有効期限の値を使用してタイマーを開始します。 アダプターが受信フィルター *Y*に一致するパケットを受信すると、アダプターは、その受信フィルターに指定された有効期限の値を使用してハードウェアタイマーを再構成できます。

    タイマーに残っている時間が受信フィルターの有効期限よりも短い場合は、ネットワークアダプターがハードウェアタイマーを再構成する必要**が  ます**。

     

-   受信したパケットが結合されるとすぐに、次のいずれかのイベントが発生すると、ネットワークアダプターは割り込みを生成します。

    -   ハードウェア合体バッファー内の使用可能な領域がハードウェア固有の下位マークに到達した場合、ネットワークアダプターは受信割り込みを生成して、ミニポートドライバーが、結合された受信パケットを処理できるようにする必要があります。

    -   ハードウェア合体バッファーに使用されるハードウェアタイマーの有効期限が切れた場合、ネットワークアダプターは受信割り込みを生成して、ミニポートドライバーが、結合された受信パケットを処理できるようにする必要があります。

    -   受信フィルターがオフになっていて、そのフィルターに一致するパケットが結合されている場合、ネットワークアダプターは受信割り込みを生成して、ミニポートドライバーが、結合された受信パケットを処理できるようにする必要があります。

    -   受信パケットが受信フィルターのいずれとも一致しない場合、ネットワークアダプターで受信割り込みを生成して、ミニポートドライバーが受信パケットを処理できるようにする必要があります。 パケットが結合されている場合は、ミニポートドライバーもそれらのパケットを処理する必要があります。

    -   ネットワークアダプターが受信割り込み以外の他の割り込み状態の割り込みを生成した場合、ネットワークアダプターも受信割り込みの状態を通知する必要があります。これにより、ミニポートドライバーが、結合された受信パケットを処理できるようになります。

    割り込みが生成されるとすぐに、ネットワークアダプターは、有効期限が切れていないハードウェアタイマーを停止し、ハードウェア合体バッファーをクリアする必要があります。

ミニポートドライバーは、パケット合体フィルターに一致した受信パケットの数の値を含む、結合されたパケットカウンターを保持する必要があります。 NDIS は、oid [\_パケット\_結合\_フィルター](https://docs.microsoft.com/windows-hardware/drivers/network/oid-packet-coalescing-filter-match-count)を使用してこのカウンターを照会し、\_COUNT に一致\_します。

ネットワークアダプターは、ハードウェアがフルパワー状態で動作している間、パケット合体のみを実行します。 ハードウェアが低電力状態にある間は、アダプターは、oid [\_\_\_\_PNP](https://docs.microsoft.com/windows-hardware/drivers/network/oid-pnp-enable-wake-up)の oid セット要求を通じてアダプターにオフロードされたウェイクアップパターンに基づいて、受信したパケットだけをフィルター処理する必要があります。

ネットワークアダプターがフルパワー状態に移行する場合、ミニポートドライバーは次の手順に従う必要があります。

-   ミニポートドライバーは、ハードウェア合体バッファー内の結合されたパケットを破棄するようにネットワークアダプターを構成する必要があります。 ネットワークアダプターは、低電力状態に移行されたときにこれらのパケットを結合している可能性があります。

-   ミニポートドライバーは、低電力移行の前にドライバーにダウンロードされたパケット合体受信フィルターのセットを使用して、ネットワークアダプターを構成する必要があります。

-   ミニポートドライバーは、結合されたパケットカウンターをクリアする必要があります。

 

 





