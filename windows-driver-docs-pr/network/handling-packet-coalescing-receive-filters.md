---
title: パケット結合受信フィルターの処理
description: パケット結合受信フィルターの処理
ms.assetid: 83FF780F-6B8F-4222-90F0-42037FFF7653
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 43742570f7bbbdb95cffa06caa1408952e324998
ms.sourcegitcommit: fb7d95c7a5d47860918cd3602efdd33b69dcf2da
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/25/2019
ms.locfileid: "67379786"
---
# <a name="handling-packet-coalescing-receive-filters"></a>パケット結合受信フィルターの処理


複数の受信のフィルターの OID メソッド要求を通じたミニポート ドライバーにダウンロードされます[OID\_受信\_フィルター\_設定\_フィルター](https://docs.microsoft.com/windows-hardware/drivers/network/oid-receive-filter-set-filter)します。 各フィルターは、1 つまたは複数のテストを指定できます (*ヘッダー フィールド テスト*) アダプターのハードウェア合体バッファーで受信したパケットを結合する必要があるかどうかを判断するネットワーク アダプターを使用します。

ミニポート ドライバーでは、受信フィルターを使用したネットワーク アダプターを構成、前に、ドライバーはアダプターのハードウェア機能に基づく受信フィルターを最適化する必要があります。 たとえば、すべての受信フィルター MAC ヘッダーのヘッダー フィールドのテストが必要です。 そのため、ドライバーは、このテストの結果に基づくフィルター ルールを最適化する可能性があります。 これにより、アダプターはシステムの相互接続 (OSI) レイヤー 3 (L3) を特定し、レイヤー 4 (L4) ヘッダー フィールド テストを次を実行できます。

受信フィルターを使用したネットワーク アダプターが構成されているとすぐには、次の方法する必要があります。

-   ヘッダー フィールド テストのすべてのパラメーター、特定のフィルターは、受信パケットの結合のバッファーでパケットを結合するには一致しなければなりません。

    ネットワーク アダプターでは、論理 AND 演算と受信のフィルターのすべてのヘッダー フィールドのテストの結果を結合します。 任意のヘッダー フィールドをテストする場合は、配列に含まれる、 [ **NDIS\_受信\_フィルター\_フィールド\_パラメーター** ](https://docs.microsoft.com/windows-hardware/drivers/ddi/content/ntddndis/ns-ntddndis-_ndis_receive_filter_field_parameters)の構造体、フィルターの失敗を受信、受信パケットの指定したフィルター条件を満たしていないと、結合されたいない必要があります。

-   ネットワーク アダプターは、指定したヘッダー フィールドのテスト パラメーターに基づくパケット データのみを検査します。 アダプターは、ヘッダー フィールド テストを指定されていないパケット内のすべてのヘッダー フィールドを無視する必要があります。

-   受信したパケットには、受信フィルターのいずれかのすべてのヘッダー フィールドのテストが一致すると、ネットワーク アダプターはハードウェア合体バッファー内のパケットを結合する必要があります。 最初のパケットをひとまとめにすると、すぐ、ネットワーク アダプターはハードウェア タイマーを開始する必要がありの値には、有効期限を設定する必要があります、 **MaxCoalescingDelay**のメンバー、 [ **NDIS\_受信\_フィルター\_パラメーター** ](https://docs.microsoft.com/windows-hardware/drivers/ddi/content/ntddndis/ns-ntddndis-_ndis_receive_filter_parameters)構造が一致するフィルターを受信します。

-   多くのパケットが受信したパケットの結合に一致する受信のフィルター、合体のバッファーに入れますネットワーク アダプター。

    ハードウェア タイマーが既に実行されている場合、アダプターする必要がありますいないを停止または、一致する受信のフィルターのタイマーを再起動します。 ただし、アダプターはハードウェアのタイマーを構成できる最小の有効期限から一致する値がフィルターを受信します。 たとえば、ドライバーが受信のフィルターを一致するパケットを受信すると*X*アダプターは、フィルターを受信する指定された有効期限の値を持つタイマーを開始します。 受信のフィルターに一致するパケットを受信し、場合*Y*フィルターを受信するのにアダプターが指定された有効期限の値を持つハードウェア タイマーを再構成できます。

    **注**  タイマーに残っている時間は、受信フィルターの有効期限よりも小さい場合、ネットワーク アダプターが、ハードウェアのタイマーを再構成する必要があります。

     

-   受信したパケットをひとまとめにするとすぐに、次のイベントのいずれかが発生した場合、ネットワーク アダプター、割り込み生成されます。

    -   ハードウェア合体バッファー内で使用可能な領域には、ハードウェア固有の低水位マークに達すると、ミニポート ドライバーは、結合された受信パケットを処理できるように、ネットワーク アダプターは受信割り込みを生成する必要があります。

    -   ハードウェア合体バッファーで使用されるハードウェアのタイマーの期限が切れると、ネットワーク アダプターは、ミニポート ドライバーは、結合された受信パケットを処理できるように受信割り込みを生成する必要があります。

    -   受信フィルターをクリアし、フィルターに一致するパケットが結合された場合、ネットワーク アダプターでは、ミニポート ドライバーは、結合された受信パケットを処理できるように受信割り込みに生成します。

    -   受信したパケットには、受信フィルターと一致しません、ミニポート ドライバーは、受信したパケットを処理できるように、ネットワーク アダプターは受信割り込みを生成する必要があります。 すべてのパケットが結合された、ミニポート ドライバーにこれらのパケットが処理も必要があります。

    -   ネットワーク アダプターは、割り込みの受信割り込み以外の割り込みの状態を生成する場合は、ミニポート ドライバーは、結合された受信パケットを処理できるように、ネットワーク アダプターも受信割り込み状態を通知する必要があります。

    割り込みが生成されるとすぐにネットワーク アダプターは、ハードウェア合体バッファーをクリアする必要があり、有効期限が切れていない場合はハードウェア タイマーを停止する必要があります。

ミニポート ドライバーでは、パケットの結合フィルターに一致した受信パケットの数の値を含む結合されたパケット カウンターを維持する必要があります。 このカウンターの OID クエリ要求から、NDIS を照会[OID\_パケット\_COALESCING\_フィルター\_一致\_カウント](https://docs.microsoft.com/windows-hardware/drivers/network/oid-packet-coalescing-filter-match-count)します。

ネットワーク アダプターのみを実行しますパケットの結合、ハードウェアが電力状態で動作中にします。 アダプターの OID のセット要求を通じてアダプターにオフロードされがウェイク アップ パターンに基づいてのみパケットを受信したフィルター処理する必要があります、ハードウェアは、低電力状態では、 [OID\_PNP\_を有効にする\_WAKE\_を](https://docs.microsoft.com/windows-hardware/drivers/network/oid-pnp-enable-wake-up)します。

ネットワーク アダプターは、電力状態に遷移、ときに、ミニポート ドライバーは次の手順に従います。

-   ミニポート ドライバーでは、ハードウェア合体バッファー内のすべての結合されたパケットを破棄するネットワーク アダプターを構成する必要があります。 低電力状態に移行していたときに、ネットワーク アダプターをこれらのパケット結合がある可能性があります。

-   ミニポート ドライバーは、ネットワーク アダプターを構成する必要がありますパケットのセットを結合低電力の遷移の前に、ドライバーにダウンロードされたフィルターを受信します。

-   ミニポート ドライバーでは、まとめられたパケット カウンターをクリアする必要があります。

 

 





