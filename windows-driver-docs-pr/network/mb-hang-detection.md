---
title: MB ハング検出
description: MB ハング検出
ms.assetid: D3D222F7-96BE-48F7-8074-8820E43E3C7B
keywords:
- MB ハング検出、モバイル ブロード バンドのハング検出、モバイル ブロード バンドのミニポート ドライバー ハング検出
ms.date: 08/09/2018
ms.localizationpriority: medium
ms.openlocfilehash: 0a3d735b1c176b9f8d07e94c481bbbb427bd3dc5
ms.sourcegitcommit: a33b7978e22d5bb9f65ca7056f955319049a2e4c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/31/2019
ms.locfileid: "56581308"
---
# <a name="mb-hang-detection"></a>MB ハング検出

モバイル ブロード バンド (MB または MBB) のハング検出は、1809 およびそれ以降のバージョンの Windows 10 でコントロールのパスとそこからの回復でハングの条件を検出するのに MBB クライアント ドライバーを支援するテクノロジです。 一部では、[デバイス ベースのリセットとリカバリ](mb-device-based-reset-and-recovery.md)はさまざまな MBB デバイスとドライバーの可能性のあるエラー条件から回復する対象として機能します。 

このトピックのフロー図は、リセット メカニズムがバスに依存しない場合、このページで説明されているインターフェイスを定義して、ACPI とバスのスタックが、基になるバスとして USB を使用します。 

次のフロー図は、すべての NDIS オブジェクト識別子 (Oid) とコールバックのミニポート ドライバーに一般的に適用します。 このプロセスの回復の一部が NDIS は完全にリセット回復をサポートしていない場合機能しないという場合がある可能性があります。

![高度なハング検出とリセット フロー](images/mb-self-healing-hang-detection-highlevel.png "大まかなハング検出とフローをリセットします。")

このハング検出とリセット フローのシーケンスは、3 つのフェーズで構成されます。

1. ハング検出 
2. デバッグを行うため、状態を取得する、潜在的なログ記録
3. リセット – 突然の削除の処理

## <a name="hang-detection"></a>ハング検出

サービス層は、何かため問題がユーザーのレイヤーで検出されたときに、回復を開始するドライバーにヒントを提供します。`WWANSvc`が携帯ネットワーク アダプターの接続状態を管理するステート マシン。 これをサポートするには、リセット操作をトリガーするドライバーを使用するプライベート インターフェイスが定義されます。 ドライバーがステート マシンが有効かどうかを確認するまで、デバイス独自のコマンドが発信されるいくつかのケースがあります。 これらのコマンド タイムアウトの存在する場合は、復旧操作を開始するユーザー モードに戻す操作と通信することがなく、ドライバー自体からリセット/復旧がトリガーされます。 

リセット操作をトリガーする UDE クライアント ドライバーが使用できるプライベート インターフェイスの詳細については、次を参照してください。 [MB デバイス ベースのリセットとリカバリ](mb-device-based-reset-and-recovery.md#reset-recovery-for-ude-devices)します。

この例では[OID_WWAN_CONNECT](oid-wwan-connect.md)ハング検出のフローを進めるに例として。 

![リセット フローの OID_WWAN_CONNECT](images/mb-self-healing-hang-detection-wwanconnect-flow.png "OID_WWAN_CONNECT のフローをリセットします。")

1. NDIS (プロトコル ドライバー) を経由して受信、 [OID_WWAN_CONNECT](oid-wwan-connect.md)します。
2. NDIS は、クラス ドライバー OID_WWAN_CONNECT を渡します。
3. クラス ドライバーは、接続要求の MBIM メッセージを作成します。
4. クラスのドライバーでは、USB バスを通じて MBIM 関数を MBIM メッセージを送信します。 
5. ファームウェアのコマンドは、タイムアウトし、ファームウェアがハングまたは MBIM コマンドの完了に時間がかかっていますので、なることがあります。
6. クラスのドライバーでは、NDIS_NOTIFICATION_REQUIRED でファームウェア完了する前に NDIS コマンドを返します。 要請された通知を使用して、ドライバーから OID_WWAN_CONNECT の結果が返される[NDIS_STATUS_WWAN_CONTEXT_STATE](ndis-status-wwan-context-state.md)で**状態**に設定**タイムアウト**、基になるデバイスがコマンドに応答していないことを示すです。 
7. NDIS は、プロトコル ドライバーに OID 要求を完了します。
8. プロトコル ドライバーには、コマンドが失敗したことを認識しているサービスへのコールバックを返します。
9. サービスは、新しい OID インターフェイスを使用してデバイスのリセット操作をトリガーします。 
10. この時点で、後に、FDO は突然削除および再 MBB デバイスを列挙するバスを呼び出します。 USB の場合は、基になるバス、FDO はデバイスをリセットする適切な関数を呼び出します。 
11. UEFI では、適切な ACPI メソッドが定義されている、FLDR または PLDR のいずれかをトリガーするされます。

FLDR と PLDR の詳細については、次を参照してください。 [MB デバイス ベースのリセットとリカバリ](mb-device-based-reset-and-recovery.md#device-based-resets)します。

## <a name="reset-surprise-removal"></a>(突然削除) のリセットします。

リセット回復を続行すると、バスの原因プラグ アンド プレイ (PnP) マネージャーが、サポートされる、突然削除 IRP を生成するには存在 ACPI および UEFI のレベルでします。 NDIS、突然削除 IRP を受信するコールバックに`WMBCLASS`突然削除 PnP イベントのコールバック。 `WMBCLASS` 突然削除操作を処理します。 この時点では、すべてのコマンドなどを完了する必要があり、データ パケットは、NDIS に正常に返される必要があります。 それ以外の場合、突然削除操作は完了しません。 フローの残りの部分は、バス、USB などに、実際のデバイス突然削除と同じです。 

1. NDIS は、突然削除の PnP イベントを呼び出します。
2. `WMBCLASS` ハングした MBIM コマンドの戻り値を無視し、元の NDIS コマンドを返します。 
3. `WMBCLASS` 突然削除 NDIS PnP コールバックを返します。

## <a name="recovery"></a>回復

突然削除、スタックなどのすべてのドライバー後`WMBCLASS`デバイス オブジェクトを削除して再バスによって列挙できるように、すべてのリソースを解放する必要があります。 失敗すると、そのためには、デバイスは再は列挙されませんし、回復できません。

## <a name="related-links"></a>関連リンク

[MB デバイス ベースのリセットと回復](mb-device-based-reset-and-recovery.md)
