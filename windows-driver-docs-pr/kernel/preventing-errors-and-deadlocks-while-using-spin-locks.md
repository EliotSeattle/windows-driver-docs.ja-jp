---
title: スピン ロック使用中のエラーおよびデッドロックの防止
description: スピン ロック使用中のエラーおよびデッドロックの防止
ms.assetid: 1df563e6-7ad2-4684-9778-ffa1b845ac31
keywords:
- デッドロック WDK カーネル
- 再帰 WDK カーネル
- 入れ子になったスピンロックの取得 WDK カーネル
- ページング可能データロック WDK カーネル
- スピンロック WDK カーネル
ms.date: 06/16/2017
ms.localizationpriority: medium
ms.openlocfilehash: 3b6bf678bf8c2ccd05b50ef8e29b847bb819c634
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72838498"
---
# <a name="preventing-errors-and-deadlocks-while-using-spin-locks"></a>スピン ロック使用中のエラーおよびデッドロックの防止





ドライバールーチンはスピンロックを保持しますが、ハードウェア例外を発生させたり、システムを停止することなくソフトウェア例外を発生させたりすることはできません。 つまり、ドライバーの ISR と、ドライバーが[**KeSynchronizeExecution**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kesynchronizeexecution)への呼び出しで提供する*SynchCritSection*ルーチンは、ページフォールトや算術例外などのエラーやトラップを発生させないようにする必要があり、ソフトウェア例外を生成することはできません。 [**KeAcquireSpinLock**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-keacquirespinlock)または[**KeAcquireInStackQueuedSpinLock**](https://docs.microsoft.com/previous-versions/windows/hardware/drivers/ff551899(v=vs.85))を呼び出すルーチンは、executive スピンロックを解除し、IRQL = DISPATCH で実行されなくなるまで、ハードウェア例外を発生させたり、ソフトウェア例外を発生させたりすることもできません\_平準.

### <a name="pageable-data-and-support-routines"></a>ページング可能なデータとサポートルーチン

スピンロックを保持している間、ドライバーは、ページング可能なデータにアクセスするルーチンを呼び出すことはできません。 ドライバーは、ディスパッチ\_レベルより厳密に小さい IRQL で実行中に呼び出しが発生した場合にのみ、ページング可能なデータにアクセスする特定のサポートルーチンを呼び出すことができることに注意してください。 この IRQL 制限は、スピンロックを保持しながら、これらのサポートルーチンを呼び出すことができません。 特定のサポートルーチンの IRQL 要件については、ルーチンのリファレンスページを参照してください。

### <a name="recursion"></a>回数

スピンロックを再帰的に取得しようとすると、デッドロックが発生することが保証されます。再帰ルーチンの保持インスタンス化では、2番目のインスタンス化がスピンしている間にスピンロックを解放できず、同じスピンロックを取得しようとしています。

次のガイドラインでは、再帰ルーチンでのスピンロックの使用方法について説明します。

-   再帰ルーチンは、スピンロックを保持した状態でそれ自体を呼び出すことはできません。また、後続の呼び出しで同じスピンロックを取得しようとすることもありません。

-   再帰ルーチンはスピンロックを保持していますが、再帰によってデッドロックが発生する可能性がある場合、または呼び出し元が25マイクロ秒を超えるスピンロックを保持する場合は、別のドライバールーチンが再帰ルーチンを呼び出すことはできません。

再帰的なドライバールーチンの詳細については、「[カーネルスタックの使用](using-the-kernel-stack.md)」を参照してください。

### <a name="nested-spin-lock-acquisitions"></a>入れ子になったスピンロックの取得

別のスピンロックを保持しながら2番目のスピンロックを取得しようとすると、デッドロックが発生したり、ドライバーのパフォーマンスが低下することがあります。

次のガイドラインでは、ドライバーがスピンロックを保持する方法について説明します。

-   ドライバーは、デッドロックが発生しない限り、スピンロックを使用するサポートルーチンを呼び出すことはできません。

-   デッドロックが発生していない場合でも、代替コーディング手法が同等のドライバーのパフォーマンスと機能を提供できない場合を除き、ドライバーは、スピンロックを使用するサポートルーチンを呼び出すことはできません。

-   ドライバーが入れ子になった呼び出しを行ってスピンロックを取得する場合、スピンロックを取得するたびに常に同じ順序でスピンロックを取得する必要があります。 この順序は、デッドロックを回避するのに役立ちます。

一般に、入れ子になったスピンロックを使用して、重複するサブセットや、共有データとリソースの個別セットを保護することは避けてください。 ドライバーが2つの executive スピンロックを使用して個別のリソース (個別に設定される可能性があるタイマーオブジェクトと、さまざまなドライバールーチンによってまとめられたものなど) を保護する場合に発生する可能性があることを検討します。 このドライバーは、それぞれが1つのスピンロックを保持している2つのルーチンのいずれかが、他のスピンロックを取得しようとしたときに、SMP コンピューターで断続的にデッドロックします。

入れ子になったスピンロックの取得の詳細については、「[ロック、デッドロック、および同期](https://go.microsoft.com/fwlink/p/?linkid=57456 )」を参照してください。

 

 




