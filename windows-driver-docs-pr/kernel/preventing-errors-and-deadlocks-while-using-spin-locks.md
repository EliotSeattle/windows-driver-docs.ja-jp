---
title: スピン ロック使用中のエラーおよびデッドロックの防止
description: スピン ロック使用中のエラーおよびデッドロックの防止
ms.assetid: 1df563e6-7ad2-4684-9778-ffa1b845ac31
keywords:
- デッドロック WDK カーネル
- 再帰 WDK カーネル
- 入れ子になったスピン ロック買収 WDK カーネル
- データのページング可能なロックの WDK カーネル
- スピン ロック WDK カーネル
ms.date: 06/16/2017
ms.localizationpriority: medium
ms.openlocfilehash: 04d96f822e7beb96a753bb0d4136646eae222dc9
ms.sourcegitcommit: fb7d95c7a5d47860918cd3602efdd33b69dcf2da
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/25/2019
ms.locfileid: "67381679"
---
# <a name="preventing-errors-and-deadlocks-while-using-spin-locks"></a>スピン ロック使用中のエラーおよびデッドロックの防止





ドライバーのルーチンは、スピン ロックを保持しているときに、ハードウェア例外またはシステム停止することがなくソフトウェア例外を発生させることができません。 ドライバーの ISR と言い換える*SynchCritSection*ルーチンへの呼び出しで、ドライバーを提供する[ **KeSynchronizeExecution** ](https://docs.microsoft.com/windows-hardware/drivers/ddi/content/wdm/nf-wdm-kesynchronizeexecution)必要があります、障害ドメインまたはトラップなどをページで、エラーまたは算術例外、およびソフトウェア例外を発生させることはできません。 呼び出すルーチン[ **KeAcquireSpinLock** ](https://docs.microsoft.com/windows-hardware/drivers/ddi/content/wdm/nf-wdm-keacquirespinlock)または[ **KeAcquireInStackQueuedSpinLock** ](https://docs.microsoft.com/previous-versions/windows/hardware/drivers/ff551899(v=vs.85))もハードウェア例外が発生することはできませんまたはソフトウェア例外を発生させる、executive スピン ロックが解放され、IRQL で現在実行されていないまで = ディスパッチ\_レベル。

### <a name="pageable-data-and-support-routines"></a>ページング可能なデータとサポート ルーチン

スピン ロックを保持しているときにドライバーする必要がありますページング可能なデータにアクセスするルーチンを呼び出しません。 ドライバーがその呼び出しがディスパッチより厳密に小さい IRQL で実行中に発生する場合にのみページング可能なデータにアクセスする特定のサポート ルーチンを呼び出すことができますに注意してください。\_レベル。 この IRQL 制限のため、これらを呼び出すスピン ロックを保持しながらルーチンをサポートします。 任意の特定のサポート ルーチンの IRQL 要件、ルーチンのリファレンス ページを参照してください。

### <a name="recursion"></a>再帰

デッドロックが発生するスピン ロックの再帰的の取得を試みることが保証されます。 同じスピン ロックを取得しようとして、2 つ目のインスタンス化をスピン中に、再帰ルーチンを保持しているインスタンス化は、スピン ロックを解放できません。

次のガイドラインでは、再帰ルーチンでスピン ロックを使用する方法について説明します。

-   再帰ルーチンでは、する必要がありますそれ自体を呼び出すスピン ロックを保持しているときにないまたは後続の呼び出しで同じスピン ロックの取得を読み取ろうとしないで。

-   再帰ルーチンは、スピン ロックを保持しているときに別のドライバーのルーチンは再帰がデッドロックが発生する場合、再帰的なルーチンを呼び出しませんする必要があります。 または 25 (マイクロ秒) よりも長く、スピン ロックを保持するために、呼び出し元が発生する可能性があります。

ドライバーの再帰ルーチンの詳細については、次を参照してください。[カーネル スタックを使用して](using-the-kernel-stack.md)します。

### <a name="nested-spin-lock-acquisitions"></a>入れ子になったスピン ロックの取得

デッドロックまたは不適切なドライバーのパフォーマンスできますも原因別のスピン ロックを押しながら 2 番目のスピン ロックを取得しようとしています。

次のガイドラインでは、ドライバーがスピン ロックを保持する方法について説明します。

-   ドライバーは、デッドロックが発生することはできませんが、スピン ロックを使用するサポート ルーチンを呼び出しませんする必要があります。

-   場合でも、デッドロックが発生することはできません、ドライバーはない代替コーディング技法は、比較可能なドライバーのパフォーマンスと機能を提供できない場合を除き、スピン ロックを使用するサポート ルーチンを呼び出す必要があります。

-   ドライバーをスピン ロックを取得する呼び出しを入れ子になった場合は、する必要があります常に取得する必要が同じ順序でスピン ロック取得されるたびにします。 この順序により、デッドロックを回避できます。

一般に、重複するサブセットまたは共有データとリソースの個別のセットを保護する入れ子になったスピン ロックを使用しないでください。 何が起こることを検討してください。 ドライバーは、個別のリソースを保護する 2 つの executive スピン ロックを使用している場合タイマー オブジェクトのペアなどが設定される可能性総称して個別にさまざまなドライバーのルーチンでします。 SMP マシン、ドライバーのデッドロックが断続的にたびに、その他のスピン ロックを取得しようとしたそれぞれ 1 つのスピン ロックを保持している 2 つのルーチンのいずれかになります。

入れ子になったスピン ロックの取得の詳細については、次を参照してください。[ロック、デッドロック、その同期](https://go.microsoft.com/fwlink/p/?linkid=57456 )します。

 

 




