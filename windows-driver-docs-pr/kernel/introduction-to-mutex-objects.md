---
title: ミューテックス オブジェクトの概要
description: ミューテックス オブジェクトの概要
ms.assetid: c35b4341-09dd-411d-b933-6c762fecd23c
keywords:
- カーネルのディスパッチャー オブジェクト WDK、ミュー テックス オブジェクト
- ディスパッチャー オブジェクト WDK カーネル、ミュー テックス オブジェクト
- ミュー テックス オブジェクトの WDK カーネル
- WDK のカーネルを相互に排他的なアクセス
- ミュー テックス オブジェクトで待機しています。
ms.date: 06/16/2017
ms.localizationpriority: medium
ms.openlocfilehash: ff495e947018a6689b4e85e75f8518e5d3710d5d
ms.sourcegitcommit: a33b7978e22d5bb9f65ca7056f955319049a2e4c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/31/2019
ms.locfileid: "56581388"
---
# <a name="introduction-to-mutex-objects"></a>ミューテックス オブジェクトの概要


その名前からわかるように、ミュー テックス オブジェクト、カーネル モードのスレッドのセット間で共有される単一のリソースを相互に排他的にアクセスできるように設計されています。 同期メカニズムです。 のみ実行ワーカー スレッドを使用したファイル システム ドライバー (fsd に対して表示される) などの最上位レベルのドライバーがミュー テックス オブジェクトを使用する可能性があります。

場合によっては、ドライバーで作成されたスレッドまたはワーカー スレッド コールバック ルーチンで最上位レベルのドライバーは、ミュー テックス オブジェクトを使用する場合があります。 ただし、ページング可能なスレッドまたはワーカー スレッド コールバック ルーチンで任意のドライバーする必要がありますで発生する待機の買収とそのミュー テックス オブジェクトのリリース非常に慎重に管理します。

ミュー テックス オブジェクトには、システム (カーネル モードのみ) のスレッドを SMP マシン内の共有リソースを相互に排他的なデッドロックのないアクセスを提供する組み込みの機能があります。 カーネルは、一度に 1 つのスレッドにミュー テックスの所有権を割り当てます。

ミュー テックスの所有権を取得するには、カーネル モードの通常非同期プロシージャ コール (Apc) の配信ができないようにします。 スレッドが割り込むことはできません、APC カーネル APC を発行する場合を除き、\_レベルのソフトウェアの割り込みが I/O 操作の元の要求元に結果を返す I/O マネージャーの IRP の完了ルーチンなどの特別なカーネル APC を実行するには

スレッドは、(再帰的な所有権)、既に所有しているが、再帰的に取得したミュー テックス オブジェクトに設定されていないシグナルされた状態のスレッドが所有権を完全に解放されるまで、ミュー テックス オブジェクトの所有権を取得できます。 このようなスレッドでは、別のスレッドがミュー テックスを取得する前に、所有権を取得した回数だけ、ミュー テックスを明示的に解放する必要があります。

カーネルには、最初、ミュー テックスを解放してシグナルされた状態に設定することがなくユーザー モードへの遷移が発生するためのミュー テックスを所有するスレッドは決してが許可されます。 場合は、ミュー テックスを所有する FSD 作成またはドライバーが作成したスレッドがミュー テックスの所有権を解放する前に、I/O マネージャーに制御を返すしようとすると、カーネル、システムがダウンします。

ミュー テックス オブジェクトを使用する任意のドライバーを呼び出す必要があります[ **KeInitializeMutex** ](https://msdn.microsoft.com/library/windows/hardware/ff552147)上で待機またはそのミュー テックス オブジェクトの解放前に 1 回です。 次の図は、2 つのシステム スレッドがミュー テックス オブジェクトを使用して可能性があります。

![ミュー テックス オブジェクトの待機を示す図](images/3mutxobj.png)

前の図に示すように、ミュー テックス オブジェクトを使用するドライバーは、常駐である必要があります、ミュー テックス オブジェクトのストレージを提供する必要があります。 ドライバーを使用して、[デバイス拡張機能](device-extensions.md)コント ローラーの拡張機能を使用する場合、デバイスのドライバーが作成したオブジェクトの[コント ローラー オブジェクト](using-controller-objects.md)、またはドライバーが割り当てられる非ページ プール。

ドライバーを呼び出すと**KeInitializeMutex** (通常からその[ *AddDevice* ](https://msdn.microsoft.com/library/windows/hardware/ff540521)ルーチン)、ミュー テックス オブジェクトのドライバーのストレージへのポインターを渡す必要がありますカーネルシグナルされた状態を初期化します。

このような最上位レベルのドライバーが初期化されると後は、前の図に示すように、共有リソースに排他アクセスを管理できます。 たとえば、本質的に同期操作とスレッドのドライバーのディスパッチ ルーチンでは、Irp のドライバーが作成したキューを保護するのに、ミュー テックスを使用する可能性があります。

**KeInitializeMutex**(として、前の図に示す)、ミュー テックス オブジェクトの初期状態をシグナルされた常に設定します。

1.  ディスパッチ ルーチンの最初の呼び出し[ **kewaitforsingleobject の 1** ](https://msdn.microsoft.com/library/windows/hardware/ff553350)で、*ミュー テックス*ポインターは、現在のスレッドでは、準備完了状態をすぐに、スレッドは、ミュー テックスの所有権を非シグナル状態にミュー テックスの状態をリセットします。 ディスパッチ ルーチンとしてすぐに実行を再開するには、そのことができます安全に IRP をキューに挿入ミュー テックスで保護されています。

2.  2 番目のスレッドのときに (別のディスパッチ、ドライバーが提供する日常的なワーカー スレッド コールバック ルーチン、またはドライバーが作成したスレッド) の呼び出し**kewaitforsingleobject の 1**で、*ミュー テックス*ポインター、2 番目のスレッド待機状態に配置されます。

3.  呼び出すディスパッチ ルーチンは、「ステップ 1 として IRP キューが完了したら、 [ **KeReleaseMutex** ](https://msdn.microsoft.com/library/windows/hardware/ff553140)で、*ミュー テックス*ポインターとブール値*待機*を呼び出す予定かどうかを示す値、 **kewaitforsingleobject の 1** (または[ **KeWaitForMutexObject**](https://msdn.microsoft.com/library/windows/hardware/ff553344)) で、 *ミュー テックス*すぐ**KeReleaseMutex**コントロールを返します。

4.  手順 3. でミュー テックスの所有権がリリースされたと仮定すると、ディスパッチ ルーチン (*待機*に設定**FALSE**)、によってシグナルされた状態に設定されている、ミュー テックス**KeReleaseMutex**します。 ミュー テックス現在が所有者は、カーネルが別のスレッドがそのミュー テックスを待機しているかどうかを判断します。 そのため、カーネルが 2 番目のスレッドを行った場合 (手順 2 参照)、ミュー テックスの所有者では、可能性があります最小のリアルタイムの優先度の値をスレッドの優先順位を推し進め準備完了状態が変化します。

5.  プロセッサが使用可能なすぐに、カーネルが 2 番目のスレッドの実行をディスパッチします。 つまり、優先度が高いその他のスレッドは現在準備完了状態と高い IRQL で実行されるルーチンをカーネル モードではありません。 2 番目のスレッド (キュー IRP ディスパッチ ルーチンまたはドライバーのワーカー スレッド コールバック ルーチンまたはドライバーが作成したスレッドの IRP のデキュー) ようになりました安全にアクセスできる Irp のミュー テックスで保護されているキューを呼び出すまで**KeReleaseMutex**します。

そのスレッドを明示的に呼び出す必要がある場合、スレッドがミュー テックス オブジェクトの再帰的の所有権を取得、 **KeReleaseMutex**シグナルされた状態にミュー テックス オブジェクトを設定するためにミュー テックスを待機した回数。 たとえば、スレッドが**kewaitforsingleobject の 1**し**KeWaitForMutexObject**を同じ*ミュー テックス*呼び出す必要がありますのポインター、 **KeReleaseMutex**シグナルされた状態にそのミュー テックス オブジェクトを設定するためにミュー テックスを獲得、ときに 2 回です。

呼び出す**KeReleaseMutex**で、*待機*パラメーターに設定**TRUE**を直ちに呼び出す呼び出し元の意図を示す、 **KeWait * Xxx*** から返された場合、ルーチンをサポート**KeReleaseMutex**します。

**KeReleaseMutex を Wait パラメーターを設定するために、次のガイドラインを考慮してください。**

ページング可能なスレッドまたはパッシブ IRQL で実行されているページング可能なドライバー ルーチン\_レベルは呼び出さないで**KeReleaseMutex**で、*待機*パラメーターに設定**TRUE**. 呼び出し元がページ アウト呼び出しの間に発生した場合、このような呼び出しにより、致命的なページ フォールト**KeReleaseMutex**と**KeWait*Xxx*オブジェクト**(秒)。

パッシブより大きい IRQL で実行している任意の標準のドライバー ルーチン\_システム停止することがなくすべてのディスパッチャー オブジェクトに対するレベルを 0 以外の値の間隔を待機できません。 ただし、このようなルーチンを呼び出すことができます**KeReleaseMutex**ディスパッチに少ないの IRQL で実行中にミュー テックスが所有している場合\_レベル。

実行する標準のドライバー ルーチンで Irql の概要については、次を参照してください。[を管理するハードウェアの優先順位](managing-hardware-priorities.md)します。

 

 




