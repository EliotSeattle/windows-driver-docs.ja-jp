---
title: デバイス キューの管理
description: デバイス キューの管理
ms.assetid: 8b7d39f8-0449-4e9b-a54c-fe60ee60842c
keywords:
- WDK の Irp で管理するデバイスのキュー
- 補足の IRP キュー WDK カーネル
- StartIo ルーチン、補足的なデバイスのキュー
ms.date: 06/16/2017
ms.localizationpriority: medium
ms.openlocfilehash: b42f9735f08de48925380515fb21761f0679c1e6
ms.sourcegitcommit: fb7d95c7a5d47860918cd3602efdd33b69dcf2da
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/25/2019
ms.locfileid: "67386019"
---
# <a name="managing-device-queues"></a>デバイス キューの管理





通常 (fsd に対して表示される) を除き、I/O マネージャー ドライバーを呼び出すときに関連付けられているデバイスのキュー オブジェクトを作成します[ **IoCreateDevice**](https://docs.microsoft.com/windows-hardware/drivers/ddi/content/wdm/nf-wdm-iocreatedevice)します。 また、 [ **IoStartPacket** ](https://docs.microsoft.com/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-iostartpacket)と[**います**](https://docs.microsoft.com/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-iostartnextpacket)、どのドライバーが I/O マネージャーに Irp の挿入を呼び出すことができます、デバイスのキューまたは呼び出しに関連付けられた、 [ *StartIo* ](https://docs.microsoft.com/windows-hardware/drivers/ddi/content/wdm/nc-wdm-driver_startio)ルーチン。

゚は必要ありません (または特に便利です) は、その結果、ドライバーが Irp の独自デバイスのキュー オブジェクトを設定します。 可能性の高い候補は、いくつかの単一のコント ローラーまたはバス アダプター経由でサービスが提供される異種のデバイスのドライバーを密接に結合されたクラスからの受信の Irp を調整する必要がある、SCSI ポート ドライバーなどのドライバーです。

つまり、ディスク アレイ コント ローラーのドライバーに設定する補足的なデバイスのキュー オブジェクト、アドオン バス アダプターと、一連のクラス ドライバーのドライバーが使用する可能性が若干高くなりますよりもコント ローラーのドライバーが作成したオブジェクトを使用する可能性が高くなります補足的なデバイスのキュー。

### <a name="using-supplemental-device-queues-with-a-startio-routine"></a>StartIo ルーチンに補足的なデバイスのキューを使用します。

呼び出して**IoStartPacket**と**います**、ドライバーのディスパッチと[ *DpcForIsr* ](https://docs.microsoft.com/windows-hardware/drivers/ddi/content/wdm/nc-wdm-io_dpc_routine) (または[ *CustomDpc*](https://docs.microsoft.com/windows-hardware/drivers/ddi/content/wdm/nc-wdm-kdeferred_routine)) ルーチンの呼び出しの同期、 *StartIo*ドライバーには、デバイス オブジェクトが作成されたときに、I/O マネージャーが作成されたデバイスのキューを使用してルーチン。 ポート ドライバー、 *StartIo*ルーチン、 **IoStartPacket**と**います**を挿入し、ポート ドライバーの共有デバイスのデバイスのキューに Irp の削除コント ローラー/アダプター。 ポート ドライバー密接に結合された上位レベルのクラス ドライバーからの要求を保持するために、補足的なデバイスのキューの設定も場合、「並べ替える必要があります」受信 Irp の補足的なデバイスのキューへは、通常でその*StartIo*ルーチン。

ポート ドライバーでは、適切なキューにその IRP を挿入する前に各 IRP が属している補足デバイス キューを指定する必要があります。 ターゲット デバイスのオブジェクトへのポインターは、ドライバーのディスパッチ ルーチンに IRP に渡されます。 ドライバーには、着信 Irp を「並べ替え」で使用するためのポインターを保存する必要があります。 渡されるデバイス オブジェクトへのポインターに注意してください、 *StartIo*ルーチンは、ドライバーのデバイスを表すオブジェクトをデバイスのコント ローラー/アダプターのため、この目的には使用できません。

キューの任意の Irp 後、は、ドライバーは、その共有コント ローラー/アダプター要求を実行するをプログラムします。 ポート ドライバーがへの呼び出しまで、先着順ですべてのデバイスの受信要求を処理するために、 [ **KeInsertDeviceQueue** ](https://docs.microsoft.com/windows-hardware/drivers/ddi/content/wdm/nf-wdm-keinsertdevicequeue) IRP を特定のクラス ドライバーのデバイスのキューに配置します。

処理する独自 Irp のすべてのデバイスのキューを使用してその*StartIo*日常的な基になるポート ドライバーをシリアル化、共有デバイス (または bus) コント ローラー/アダプターを介して接続されているすべてのデバイスを操作します。 Irp を保持する別のデバイスのキューでサポートされている各デバイスの場合がありますでは、このポート ドライバーは、I/O スループットを向上させるときにビジー状態にあるデバイスの場合は、その共有ハードウェアにより I/O その他のすべてのデバイスに対して Irp の処理を禁止します。

呼び出しに応答**IoStartPacket**ポート ドライバーのディスパッチ ルーチンから I/O マネージャーか呼び出してドライバーの*StartIo*ルーチンをすぐに、または IRP がデバイスのキューに配置されますポート ドライバーの共有のコント ローラー/アダプターのデバイス オブジェクトに関連付けられました。

ポート ドライバーは、サービスの共有デバイスのコント ローラー/アダプターを経由する異種デバイスのそれぞれについて、独自の状態情報を維持する必要があります。

**補足的なデバイスのキューでのクラス/ポート ドライバーを設計するときに、次に留意してください。**

-   ドライバーでは、デバイス スタックの上部にあるデバイス オブジェクトを除く、自体の上に配置されたドライバーによって作成されたデバイス オブジェクトにポインターを簡単に取得することはできません。

    仕様では、I/O マネージャーは、このようなポインターを取得するためのサポート ルーチンを提供されません。 さらに、ドライバーが読み込まれる順序が不可能下位のドライバーがまだ作成されていない任意の下位レベルのドライバーがそのデバイスを追加するときに、上位レベルのドライバーのデバイス オブジェクトのポインターを取得します。

    **IoGetAttachedDeviceReference**ドライバーは、スタックへの I/O 要求のターゲットを指定する場合にのみこのポインターを使用する必要があります、ドライバーのスタックの最上位レベルのデバイスへのポインターがオブジェクトを返します。 ドライバーは、読み取りまたは書き込みデバイス オブジェクトをしないようにします。

-   ドライバーは、独自デバイス スタックの一番上に要求を送信する以外、それ自体の上に配置されたドライバーによって作成されたデバイス オブジェクトへのポインターを使用できません。

    マルチプロセッサ セーフ方式で 2 つのドライバーの間では、1 つのデバイス オブジェクト (およびそのデバイスの拡張機能) へのアクセスを同期する方法はありません。 どちらのドライバーでは、I/O、その他のドライバーの処理が現在何についてどのような想定をことができます。

密接に結合されたクラス/ポートのドライバーの場合でも各クラス ドライバーを使用して Irp に渡すためにのみ、ポート ドライバーのデバイス オブジェクトへのポインターを使用する必要があります**保留**します。 基になるポート ドライバーが、ポート ドライバーのデバイス拡張機能のいずれかに密接に処理する要求に関するでおそらく、独自の状態は、クラス ドライバーを結合を維持する必要があります ' デバイス。

### <a name="managing-supplemental-device-queues-across-driver-routines"></a>ドライバーのルーチンで補足的なデバイスのキューを管理します。

Irp のキューを密接に結合された一連のクラス ドライバーの補足的なデバイスのキューで任意のポート ドライバーもする必要があります次のような状況効率的に処理します。

1.  そのディスパッチ ルーチンには、そのデバイスのデバイスのドライバーが作成したキュー内の特定のデバイスの Irp が挿入されました。

2.  Irp の他のデバイスを続行するには、ドライバーのキューに入れられる*StartIo*ルーチン**IoStartPacket**、共有デバイスのコント ローラーを介して処理するとします。

3.  デバイス コント ローラーがアイドル状態にならないが、デバイスのドライバーが作成したキューに保持されている各 IRP もする必要がありますのキューに登録、ドライバーの*StartIo*ルーチンをできるだけ早くします。

そのため、ポート ドライバーの*DpcForIsr* IRP を特定のデバイスのドライバーのデバイスの内部キューから共有アダプター/コント ローラーのデバイスのキューに転送するルーチンを試行する必要があるたびにポート ドライバー次のように、IRP を実行します。

1.  *DpcForIsr*ルーチンの呼び出し**います**が、 *StartIo*ルーチンは、[次へ] の IRP が共有デバイスのコント ローラーにキューに置かれた処理を開始します。

2.  *DpcForIsr*ルーチンの呼び出し[ **KeRemoveDeviceQueue** ](https://docs.microsoft.com/windows-hardware/drivers/ddi/content/wdm/nf-wdm-keremovedevicequeue)を代行では、デバイスのデバイスの内部キューに保持していることの (あれば) [次へ] の IRP をデキューするにはIRP の完了に約

3.  場合**KeRemoveDeviceQueue** NULL 以外のポインターを返します、 *DpcForIsr*ルーチンの呼び出し**IoStartPacket**がデキューされるだけの IRP では、共有デバイスに、キューコント ローラー/アダプター。 それ以外の場合への呼び出し**KeRemoveDeviceQueue** Not ビジー状態にデバイスのキュー オブジェクトの状態を単にリセットし、 *DpcForIsr*ルーチンへの呼び出しを省略する**IoStartPacket**.

4.  次に、 *DpcForIsr*ルーチンの呼び出し[ **IoCompleteRequest** ](https://docs.microsoft.com/windows-hardware/drivers/ddi/content/wdm/nf-wdm-iocompleterequest)をポート ドライバー完了した I/O の処理、I/O を設定して、入力の IRP にエラー、または I/O 要求を満たすことで、ブロックを状態です。

前のシーケンスことを意味に注意してください、 *DpcForIsr*ルーチンも、デバイスの現在の (入力) 効率的に Irp の内部キューを管理するために IRP が終了を決定する必要があります。

共有のコント ローラー/アダプターが前にアイドル状態になるまで待機するポート ドライバーしようとするとデキューの Irp に保持されているその補足的なデバイスのキュー、ドライバーは、対象の中が大量の I/O 要求をすぐに他のすべてのデバイスをサービスにデバイスが場合があります。現在の I/O 要求が実際には、はるかに軽量です。

 

 




