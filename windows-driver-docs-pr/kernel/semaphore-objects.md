---
title: セマフォ オブジェクト
description: セマフォ オブジェクト
ms.assetid: e6703c39-3b47-4d3b-86e7-bf2bf37af493
keywords:
- カーネルのディスパッチャー オブジェクト WDK、セマフォ オブジェクト
- ディスパッチャー オブジェクト WDK カーネル、セマフォ オブジェクト
- セマフォ オブジェクトの WDK カーネル
- KeInitializeSemaphore
- オブジェクトのセマフォを待機しています。
- KeReleaseSemaphore
- WDK カーネルのセマフォのカウント
- バイナリ セマフォ WDK カーネル
- WDK カーネルの状態を待機します。
ms.date: 06/16/2017
ms.localizationpriority: medium
ms.openlocfilehash: 9d512786419ff1104986e9a8d2fe080a11f6dff6
ms.sourcegitcommit: a33b7978e22d5bb9f65ca7056f955319049a2e4c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/31/2019
ms.locfileid: "56551123"
---
# <a name="semaphore-objects"></a>セマフォ オブジェクト





任意のドライバーでは、セマフォ オブジェクトを使用して、そのドライバーが作成したスレッドとその他のドライバーのルーチンの間の操作を同期します。 たとえば、ドライバー専用のスレッド可能性があります配置自体待機状態に、ドライバー、未処理の I/O 要求がない、ドライバーのディスパッチ ルーチン可能性がありますを設定すると、セマフォ シグナルされた状態にだけ IRP のキューが後にします。

I/O 操作を要求しているスレッドのコンテキストで実行される、最上位レベルのドライバーのディスパッチ ルーチンでは、ディスパッチ ルーチンの間で共有されているリソースを保護するのに、セマフォを使用可能性があります。 同期 I/O 操作の下位レベルのドライバーのディスパッチ ルーチンは、またはドライバーが作成したスレッドにディスパッチ ルーチンのサブセット間で共有されているリソースを保護するのに、セマフォを使用可能性があります。

セマフォ オブジェクトを使用するすべてのドライバーを呼び出す必要があります[ **KeInitializeSemaphore** ](https://msdn.microsoft.com/library/windows/hardware/ff552150)上で待機またはセマフォを解放します。 次の図を使用してドライバーをスレッドがセマフォ オブジェクトを使用する方法を示します。

![セマフォ オブジェクトの待機を示す図](images/3semobj.png)

前の図に示すように、このようなドライバーは、常駐として使用するセマフォ オブジェクトの記憶域を提供する必要があります。 ドライバーを使用して、[デバイス拡張機能](device-extensions.md)コント ローラーの拡張機能を使用する場合、デバイスのドライバーが作成したオブジェクトの[コント ローラー オブジェクト](using-controller-objects.md)、または、ドライバーによって割り当てられた非ページ プール。

ときに、ドライバーの[ *AddDevice* ](https://msdn.microsoft.com/library/windows/hardware/ff540521)ルーチンの呼び出し**KeInitializeSemaphore**、セマフォ オブジェクトのドライバーの常駐ストレージへのポインターを渡す必要があります。 また、呼び出し元を指定する必要があります、*カウント*セマフォ オブジェクトの初期状態 (シグナルされたを 0 以外) を決定する前の図に示すようにします。

また、呼び出し元を指定する必要があります、*制限*セマフォのできる、次のいずれか。

-   **制限 1 を =**

    このセマフォがシグナルされた状態に設定されている場合、Not シグナルされた状態にリセットされるセマフォの待機している 1 つのスレッドは実行の対象になるし、どのようなリソースが、セマフォで保護されているアクセスできます。

    この種類のセマフォとも呼ばれますが、*バイナリ セマフォ*スレッドはまたはセマフォで保護されたリソースに排他アクセスはありません。

-   **制限&gt;1**

    このセマフォは、シグナルされた状態に設定されているいくつかに設定するセマフォ オブジェクトの待機中のスレッドの Not シグナルされた状態実行の対象になります、セマフォでどのようなリソースが保護されているアクセスできます。

    この型のセマフォが呼び出される、*セマフォのカウント*セマフォをシグナルされた状態に設定しているルーチンは待機スレッドの数も指定されているのでがその状態から変更でき待機している準備完了状態にします。 このような待機中のスレッドの数を指定できます、*制限*このプリセットでは未満、セマフォの初期化時に設定またはいくつか*制限*します。

いくつかのデバイスまたは中間ドライバーがある 1 つのドライバーが作成したスレッドです。可能性があります、セマフォを取得または解放するを待っているスレッドのセットを持っても少なくなります。 いくつかのシステムから提供されたドライバーは、セマフォ オブジェクトを使用し、該当するのも少なく、バイナリ セマフォを使用。 バイナリ セマフォは次のように、機能面で類似見えるかもしれませんが、[ミュー テックス オブジェクト](mutex-objects.md)、バイナリ セマフォが SMP マシンで実行されているシステムのスレッドにミュー テックス オブジェクトがあるデッドロックに対する組み込み保護を提供していません。

初期化のセマフォでのドライバーが読み込まれた後は、セマフォ、共有リソースを保護する操作を同期します。 たとえば、前の図に示すように、システム フロッピー コント ローラー ドライバーなどの Irp でキューを管理するデバイス専用のスレッドでのドライバーは IRP のキュー、セマフォを同期可能性があります。

1.  スレッドの呼び出し[ **kewaitforsingleobject の 1** ](https://msdn.microsoft.com/library/windows/hardware/ff553350)自体、待機状態に初期化されたセマフォ オブジェクトのドライバーが指定した記憶域へのポインター。

2.  Irp を開始するにはデバイスの I/O 操作を必要とします。 ドライバーのディスパッチ ルーチンの呼び出し、スピン ロックの管理下のインタロックされたキューにこのような各 IRP を挿入する[ **KeReleaseSemaphore** ](https://msdn.microsoft.com/library/windows/hardware/ff553143)ドライバーにより決定された、セマフォ オブジェクトへのポインタースレッドに対して priority boost (*インクリメント*前の図に示すように、)、*調整*1 各 IRP がキューに置かれた、セマフォのカウントに追加されると、ブール値の*待機*設定**FALSE**します。 0 以外のセマフォのカウントは、セマフォ オブジェクトを待機中のスレッドの状態を準備完了状態に変更され、シグナルされた状態に設定します。

3.  カーネルは、プロセッサが使用可能なすぐにスレッドの実行をディスパッチします。 つまり、優先度が高いその他のスレッドは現在準備完了状態で、より高い IRQL で実行されるルーチンをカーネル モードではありません。

    スレッドは IRP をスピン ロックの管理下にあるインター ロックされたキューから削除します、さらに処理すると、その他のドライバー ルーチンに渡しますおよび呼び出す[ **kewaitforsingleobject の 1** ](https://msdn.microsoft.com/library/windows/hardware/ff553350)もう一度です。 セマフォは、シグナルされた状態 (つまり、その数は 0 以外の場合、複数の Irp がドライバーのインタロックされたキュー内にあることを示す) に設定されても場合、カーネルもう一度、スレッドの状態変更待機から準備完了状態にします。

    この方法でカウント セマフォを使用してドライバー スレッドがこのような"knows"スレッドが実行されるたびに、インタロックされたキューから削除する IRP があります。

呼び出す[ **KeReleaseSemaphore** ](https://msdn.microsoft.com/library/windows/hardware/ff553143)で、*待機*パラメーターに設定**TRUE**を直ちに呼び出す呼び出し元の意図を示す、**KeWait*Xxx*オブジェクト**から返された場合 (s) サポート ルーチン**KeReleaseSemaphore**します。

設定の次のガイドラインを考慮して、*待機*KeReleaseSemaphore パラメーター。

ページング可能なスレッドまたはパッシブ IRQL で実行されているページング可能なドライバー ルーチン\_レベルは呼び出さないで**KeReleaseSemaphore**で、*待機*パラメーターに設定**TRUE**. 呼び出し元がページ アウト呼び出しの間に発生した場合、このような呼び出しにより、致命的なページ フォールト**KeReleaseSemaphore**と**KeWait*Xxx*オブジェクト**(秒)。

パッシブより大きい IRQL で実行している任意の標準のドライバー ルーチン\_システム停止することがなくすべてのディスパッチャー オブジェクトに対するレベルを 0 以外の値の間隔を待機できません; を参照してください[カーネルのディスパッチャー オブジェクト](kernel-dispatcher-objects.md)詳細についてはします。 ただし、このようなルーチンを呼び出すことができます**KeReleaseSemaphore**ディスパッチに少ないの IRQL で実行中に\_レベル。

実行する標準のドライバー ルーチンで Irql の概要については、次を参照してください。[を管理するハードウェアの優先順位](managing-hardware-priorities.md)します。 特定の要件を IRQL ルーチンをサポートするルーチンのリファレンス ページを参照してください。

 

 




