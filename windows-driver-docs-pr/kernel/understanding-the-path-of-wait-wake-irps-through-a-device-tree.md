---
title: デバイスツリーを使用した待機またはウェイク Irp のパスについて
description: デバイスツリーを使用した待機またはウェイク Irp のパスについて
ms.assetid: 35118367-d20b-45c9-a296-656028339c59
keywords:
- 待機/ウェイク Irp WDK 電源管理、デバイスツリーパス
- バスドライバーの WDK 電源管理
- USB WDK 電源管理
- 関数ドライバー WDK の電源管理
- FDOs WDK の電源管理
- DOs WDK 電源管理のフィルター処理
- 物理デバイスオブジェクト WDK 電源管理
- PDOs WDK の電源管理
ms.date: 06/16/2017
ms.localizationpriority: medium
ms.openlocfilehash: fe253da32d4ce48e1c252ba41468ac6da442d43f
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72838377"
---
# <a name="understanding-the-path-of-waitwake-irps-through-a-device-tree"></a>デバイスツリーを使用した待機またはウェイク Irp のパスについて





1つのデバイススタック内では、電源ポリシーの所有者が待機/ウェイク IRP を送信します。また、待機/ウェイク[の操作の概要](overview-of-wait-wake-operation.md)に関するトピックで説明されているように、すべてのドライバーが待機/ウェイク irp を処理し、待機[/ウェイク irp](sending-a-wait-wake-irp.md)を受信し、[待機/ウェイク](receiving-a-wait-wake-irp.md)irp を受信します。4.3.

[デバイスツリー](device-tree.md)の分岐 (リーフ devnode とその親の devnodes で構成されます) の中で、ドライバーは、待機/ウェイク IRP が、ウェイクアップに必要なすべてのハードウェアを有効にできるドライバーに到達するように連携する必要があります。

ACPI は、ACPI コンピューターで、各リーフデバイスからのウェイクアップシグナルに関連付けられているシステム固有の General Purpose イベント (GPE) レジスタを有効にします。 そのため、ドライバーは、(起動時にデバイススタックに挿入される) ACPI フィルタードライバーまたは基になる[WINDOWS acpi ドライバー](acpi-driver.md)(acpi) のいずれかに到達するまで、待機またはスリープ状態の irp を要求し、転送する必要があります。 これに対して、ACPI はレジスタを有効にし、シグナルが到着するまで IRP を保留状態にして、IRP を完了します。 ACPI はウェイクアップシグナルに応答できるため、IRP を下位のドライバーに転送しません。

ACPI フィルタードライバーは、基になる ACPI ドライバー自体と同様に、他のドライバーに対して透過的です。 ハードウェア設計の柔軟性を最大限に高めるために、デバイススタックにおける ACPI フィルタードライバーの正確な位置は、デバイスとシステムに固有のものです。 ドライバーの設計では、デバイススタック内の ACPI フィルターの存在または位置に関する想定を行うことはできません。

子を列挙するドライバーは、子デバイスごとに PDO を作成し、親デバイスの FDO を作成することに注意してください。 このドライバーは、子デバイスのバスドライバーとして機能し、親デバイスの関数ドライバー/ポリシー所有者として機能します。 そのため、バスドライバーが子 PDO に対して wait/wake IRP を受信するたびに、その親 PDO に対して別の待機/ウェイク IRP を要求する必要があります。

### <a href="" id="sample-usb-configuration"></a>

次の図は、このような状況が発生するサンプル構成を示しています。

![サンプルの usb 構成を示す図](images/wwhw.png)

このサンプル構成では、キーボードとモデムは USB ハブの子であり、さらに、PCI バスによって列挙される USB ホストコントローラーの子です。 次の図は、サンプル構成におけるキーボードのデバイススタックを示しています。

![サンプルの usb キーボード構成のデバイススタックを示す図](images/wwdobj.png)

前の図に示すように、下から読み取ります。

1.  [WINDOWS acpi ドライバー](acpi-driver.md)(acpi) によって、PCI 用の PDO が作成されます。

2.  Pci ドライバーは、pci FDO と USB ホストコントローラー PDO を作成し、PCI デバイススタックのポリシーを所有します。

3.  Usb ホストコントローラードライバー (ホストポート/ミニポートドライバーペア) によって、USB ホストコントローラー FDO と USB ハブ PDO が作成されます。 USB ホストコントローラーのデバイススタックのポリシーを所有しています。 このスタックにも、このスタックにフィルターが作成されることに注意してください。

4.  Usb hub ドライバーによって、USB ハブ FDO とキーボード PDO が作成されます。 このドライバは、USB ハブデバイススタックの電源ポリシーを所有しています。

5.  キーボードの関数ドライバーは、USB HID クラスドライバー/ミニドライバーのペアです。 このドライバーは、キーボードの FDO を作成し、その電源ポリシーを所有します。 キーボードには子デバイスがないため、このドライバーは PDOs を作成しません。

各デバイススタックには、表示されない追加のオプションフィルター DOs が含まれる場合があることに注意してください。

キーボード入力によってシステムがウェイクアップされることを許可するために、キーボードのポリシー所有者は、PDO に対して **\_待機\_スリープ解除**するように IRP\_を要求します。 この IRP は、次の図に示すように、他の待機/ウェイク Irp のチェーンを設定します。

![サンプルの usb 構成の待機/ウェイク irp 要求](images/wwcascade.png)

バスドライバーが IRP\_を受信したときに、作成した PDO を対象とする[ **\_待機\_スリープ状態**](https://docs.microsoft.com/windows-hardware/drivers/kernel/irp-mn-wait-wake)にする必要 **\_\_** があります。また、電源ポリシーを所有していて、FDO.\_

前の図に示すように、次のようになります。

1.  キーボードドライバーは、 [**PoRequestPowerIrp**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-porequestpowerirp)を呼び出して、待機/ウェイク IRP (IRP1) を PDO に送信します。

    電源マネージャーによって、IRP が割り当てられ、i/o マネージャーを介して、キーボードのデバイススタックの一番上に送信されます。 ドライバーは、 [*Iocompletion*](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-io_completion_routine)ルーチンを設定し、キーボード PDO に到達するまで IRP をスタックに渡します。 USB ハブドライバーは、キーボードのバスドライバーとして機能し、保留中の IRP1 を保持します。

2.  Usb ハブドライバーはウェイクアップ信号が到着したときにシステムをウェイクアップできないため、usb ハブのドライバーは**PoRequestPowerIrp**を呼び出して、usb ハブデバイススタックの待機/ウェイク IRP (IRP2) を要求する必要があります。

    電源マネージャーは、この IRP を USB ハブデバイススタックの最上位に送信します。 このスタックのドライバーは、 *Iocompletion*ルーチンを設定し、IRP を usb ホストコントローラードライバー (usb ハブのバスドライバーとして機能します) に渡します。 USB ホストコントローラードライバーは、キーボードがウェイクイベントを通知するまで、IRP2 pending を保持します。

3.  同様に、usb ホストコントローラードライバーはシステムをウェイクアップできないため、usb ホストコントローラードライバーは**PoRequestPowerIrp**を呼び出して、待機/ウェイク IRP (IRP3) を usb ホストコントローラーデバイススタックに送信します。

    この IRP は、USB ホストコントローラーのデバイススタックの一番上に送信されます。ここで、ドライバーは*Iocompletion*ルーチンを設定し、IRP を PCI ドライバー (USB ハブのバスドライバーとして機能します) に渡します。 PCI ドライバーは、キーボードがウェイクイベントを通知するまで、IRP3 pending を保持します。

4.  Pci ドライバーはシステムをウェイクアップできないため、pci ドライバーは**PoRequestPowerIrp**を呼び出して、待機/ウェイク IRP (IRP4) を pci デバイススタックに送信します。 その親はルートデバイスであり、ACPI はバスドライバーです。

    電源マネージャーは、IRP を PCI バスデバイススタックの一番上に送信します。そのドライバーは、完了ルーチンを設定し、IRP を[WINDOWS acpi ドライバー](acpi-driver.md)(acpi) に渡します。

5.  Acpi はシステムをスリープ解除するため、待機/ウェイク IRP を他の PDO に送信しません。 Acpi は、ウェイクアップ信号が到着するまで IRP4 pending を保持します。

キーボードがウェイクアップシグナルをアサートすると、Acpi はそれをインターセプトします。 ただし、ACPI では、キーボードが信号をアサートしたことを判断することはできません。これは、ルートデバイスを経由した信号のみであることを意味します。 次に、IRP4 が完了し、i/o マネージャーが*Iocompletion*ルーチンを呼び出して PCI デバイススタックをバックアップします。 IRP4 が完了し、すべての*Iocompletion*ルーチンが実行されると、PCI ドライバーのコールバックルーチンが呼び出されます。 コールバックルーチンでは、PCI ドライバーは、信号が USB ホストコントローラー経由で送信されたと判断します。 PCI ドライバーは IRP3 を完了します。 このシーケンスは、キーボードドライバーが IRP1 を受け取るまで、USB ホストコントローラースタックと USB ハブスタックを介して実行されます。 この時点で、キーボードドライバーは必要に応じてウェイクアップイベントを処理できます。

ドライバーが親 PDO に待機/ウェイク IRP を送信するたびに、その irp に対して[*キャンセル*](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_cancel)ルーチンを設定する必要があります。 *キャンセル*ルーチンを設定すると、ドライバーをトリガーした irp が取り消された場合に、新しい irp をキャンセルする機会がドライバーに与えられます。 USB の例では、キーボードドライバーが待機/ウェイク IRP をキャンセルした場合 (キーボードウェイクアップを無効にした場合)、USB ハブ、USB ホストコントローラー、および PCI ドライバーは、キーボードの IRP の結果として送信した Irp をキャンセルする必要があります。 詳細については、「 [Wait/Wake irp のキャンセルルーチン](canceling-a-wait-wake-irp.md#ddk-cancel-routines-for-wait-wake-irps-kg)」を参照してください。

親ドライバーは、待機/ウェイクに対して有効にできる複数の子を列挙する場合がありますが、PDO に対して保留できる待機/ウェイク IRP は1つだけです。 このような場合、親ドライバーは、そのデバイスのいずれかがウェイクアップに対して有効になっている場合に、待機/ウェイク IRP を保留状態のままにしておく必要があります。 これを行うために、ドライバーは待機/ウェイク IRP を受信するたびに内部カウンターをインクリメントします。 ドライバーが待機/ウェイク IRP を完了するたびに、カウントをデクリメントし、結果として得られる値が0以外の場合は、別の待機/ウェイク IRP をそのデバイススタックに送信します。

たとえば、前の例の[Usb 構成](#sample-usb-configuration)図で示した usb 構成では、usb ハブは、キーボードとモデムの2つのデバイスを列挙します。 USB ハブドライバーは、キーボード PDO 用の待機/ウェイク IRP を受信すると、独自の PDO に対して IRP を要求する前に、待機/ウェイク Irp の数を増やします。 モデムのポリシー所有者が後でモデムのウェイクアップを有効にすると、USB hub ドライバーは、モデム PDO の新しい IRP を pends し、待機/ウェイク参照カウントをインクリメントします。 ただし、USB ハブ PDO は同時に2つの待機待機時間を待機することはできないため、usb ハブドライバーは、USB hub PDO に新しい待機/ウェイク IRP を要求しません。

ウェイクアップ信号がキーボードまたはモデムから到着すると、USB ハブドライバーはどのデバイスがシグナル状態であるかを判断し、対応する IRP を完了し、参照カウントをデクリメントします。 両方のデバイスでウェイクアップが有効にされている (つまり、参照カウントが0以外である) ため、独自のデバイススタックを別の待機/ウェイク IRP に送信して、ウェイクアップ用に独自の PDO を "rearm" する必要があります。 (これは、USB ホストコントローラーと PCI ドライバーにも当てはまります)。

ただし、ドライバーは IRP を送信するのではなく、ウェイクアップ信号が到着した同じデバイス上での待機/ウェイクを再び有効にします。 これを行うことができるのは、デバイスの電源ポリシーマネージャーだけです。 自動での待機/ウェイクは自動ではありません。

 

 




