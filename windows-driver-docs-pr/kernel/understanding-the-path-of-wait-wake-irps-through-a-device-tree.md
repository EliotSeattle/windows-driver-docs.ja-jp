---
title: デバイス ツリーを通じて待機/ウェイク Irp のパスを理解します。
description: デバイス ツリーを通じて待機/ウェイク Irp のパスを理解します。
ms.assetid: 35118367-d20b-45c9-a296-656028339c59
keywords:
- 待機/ウェイク Irp WDK 電源管理、デバイス ツリー パス
- バス ドライバー WDK 電源管理
- USB WDK 電源管理
- 関数のドライバー WDK の電源管理
- Fdo WDK の電源管理
- フィルター DOs WDK 電源管理
- 物理デバイス オブジェクトの WDK 電源管理
- Pdo WDK の電源管理
ms.date: 06/16/2017
ms.localizationpriority: medium
ms.openlocfilehash: 58cea02da33eb028b76b361ec20682be5a85b0e9
ms.sourcegitcommit: a33b7978e22d5bb9f65ca7056f955319049a2e4c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/31/2019
ms.locfileid: "56553466"
---
# <a name="understanding-the-path-of-waitwake-irps-through-a-device-tree"></a>デバイス ツリーを通じて待機/ウェイク Irp のパスを理解します。





電源ポリシー所有者は、1 つのデバイス スタック内で待機/ウェイク IRP を送信し、」の説明に従って、すべてのドライバーが待機/ウェイク IRP を処理[待機またはスリープ解除操作の概要](overview-of-wait-wake-operation.md)」で詳しく説明し、[送信待機/ウェイク IRP](sending-a-wait-wake-irp.md)と[待機/ウェイク IRP を受信](receiving-a-wait-wake-irp.md)、それぞれします。

分岐内で、[デバイス ツリー](device-tree.md) (で構成されるリーフ devnode とその親、祖父母、およびなどの devnode)、ドライバーは連携して待機/ウェイク IRP がドライバーの必要なすべてを有効にすることができますに達していることを確認する必要がありますウェイク アップのハードウェア。

ACPI は、ACPI のコンピューターで、各リーフ デバイスからウェイク アップ シグナルに関連付けられているシステムに固有の一般的な目的のイベント (GPE) 登録を有効にする責任を負います。 そのため、ドライバーを要求する必要があり、前方待機/ウェイク Irp まで 1 つは、ACPI フィルター ドライバー (起動時にデバイス スタックの挿入) または基になるのいずれかに達すると[ACPI の Windows ドライバー](acpi-driver.md)、Acpi.sys します。 応答、ACPI レジスタをできるように、通知が到着すると、および IRP を完了するまで、保留中の IRP を保持します。 ACPI は、ウェイク アップ信号に応答できる、ので、下位のドライバーに IRP は転送しません。

基になる ACPI ドライバー自体のように、ACPI フィルター ドライバーでは、他のドライバーに透過的です。 ハードウェアの設計で最大限の柔軟性を提供するには、任意のデバイス スタックで ACPI フィルター ドライバーの正確な位置は、デバイスおよびシステム固有です。 ドライバーを設計するには、デバイス スタック内の位置を ACPI フィルターの有無についてどのような想定を行うことはできません。

デバイスと親デバイス用に FDO、列挙子のドライバーがそれぞれの子の PDO を作成ことに留意してください。 そのため、ドライバーは、子デバイス用のバス ドライバーと親デバイスの関数のドライバーまたはポリシー所有者としては機能します。 そのため、バス ドライバーの PDO 子待機/ウェイク IRP を受け取ると、ときに別待機/ウェイク IRP、親の PDO を要求する必要があります。

### <a href="" id="sample-usb-configuration"></a>

次の図は、このような状況が発生する構成例を示します。

![usb の構成例を示す図](images/wwhw.png)

サンプルの構成では、キーボード、モデムは、さらに、PCI バスで列挙されている USB ホスト コント ローラーの子である USB ハブの子です。 次の図は、サンプル構成では、キーボード デバイス スタックを示します。

![サンプルの usb キーボード設定のデバイス スタックを示す図](images/wwdobj.png)

前図に示すよう下からの読み取り。

1.  [ACPI の Windows ドライバー](acpi-driver.md)Acpi.sys、PCI の PDO を作成します。

2.  PCI ドライバは、PCI FDO と USB ホスト コント ローラー PDO を作成し、ポリシー、PCI デバイス スタックを所有しています。

3.  USB ホスト コント ローラー ドライバー (ホスト ポート/ミニポート ドライバー ペア) は、USB ホスト コント ローラーの FDO と USB ハブの PDO を作成します。 USB ホスト コント ローラー デバイス スタックのポリシーが所有しています。 Acpi.sys がもこのスタックでフィルター操作を実行を作成することに注意してください。

4.  USB ハブのドライバーでは、USB ハブの FDO とキーボードの PDO を作成します。 このドライバーでは、電源ポリシー ハブの USB デバイス スタックを所有しています。

5.  キーボード機能ドライバーは、USB HID クラス ドライバー/ミニドライバー ペアです。 このドライバーは、キーボード FDO を作成し、その電源ポリシーを所有します。 キーボードに子デバイスがあるないため、このドライバーに Pdo は作成されません。

各デバイス スタックが表示されていない追加の省略可能なフィルター DOs を含めることができますに注意してください。

キーボードの場合、ポリシーの所有者が要求、システムがスリープ解除するキーボード入力を許可する、 **IRP\_MN\_待機\_WAKE**の PDO をします。 次の図に示すように、その他の待機/ウェイク Irp のチェーンをその IRP を設定します。

![usb のサンプル構成の irp の要求を待機スリープ解除.](images/wwcascade.png)

バス ドライバーが受信すると、 [ **IRP\_MN\_待機\_WAKE** ](https://msdn.microsoft.com/library/windows/hardware/ff551766)作成 PDO を対象とする必要があります要求する必要が別**IRP\_MN\_待機\_WAKE**デバイス スタックを電源ポリシーを所有し、FDO を作成します。

: 前の図に示す

1.  キーボードのドライバー呼び出し[ **PoRequestPowerIrp** ](https://msdn.microsoft.com/library/windows/hardware/ff559734)待機/ウェイク アップを送信する、pdo IRP (IRP1)。

    電源マネージャーは IRP を割り当てるし、キーボード デバイス スタックの一番上に、I/O マネージャーを通じて送信されます。 ドライバー セット[ *IoCompletion* ](https://msdn.microsoft.com/library/windows/hardware/ff548354)ルーチンを渡します IRP PDO キーボードに達するまで、スタックをダウンします。 キーボードのバス ドライバーとして機能する、USB のハブのドライバーでは、保留中の IRP1 を保持します。

2.  USB ハブのドライバーを呼び出す必要がありますので、ウェイク アップの信号が到着すると、USB ハブのドライバーはシステムをスリープ解除できない、 **PoRequestPowerIrp** USB ハブのデバイス スタックの待機/ウェイク IRP (IRP2) を要求します。

    電源マネージャーは、この IRP を USB ハブのデバイス スタックの一番上に送信します。 このドライバー スタック セット*IoCompletion*ルーチンと USB に IRP のパス ホスト コント ローラーのドライバー (これは、USB ハブのバス ドライバーとして機能します)。 USB ホスト コント ローラーのドライバーでは、キーボード ウェイク イベントを通知するまで、保留中の IRP2 が保持されます。

3.  同様に、USB ホスト コント ローラーのドライバーできないシステムをスリープ解除、USB ホスト コント ローラーのドライバーを呼び出して**PoRequestPowerIrp** IRP (IRP3)、usb ホスト コント ローラー デバイス スタックを待機/ウェイク アップを送信します。

    電源マネージャー送信この IRP USB ホスト コント ローラーの上部にデバイス スタック、ドライバーが設定されている*IoCompletion*ルーチンと IRP が PCI ドライバ (USB ハブのバス ドライバーとして機能) するまでのパス。 PCI ドライバは、キーボードが wake イベントを通知するまで、保留中の IRP3 を保持します。

4.  PCI ドライバを呼び出して、PCI ドライバが、システムをスリープ解除できない**PoRequestPowerIrp** PCI デバイスに IRP (IRP4) がスタック待機/ウェイク アップを送信します。 その親は、ACPI は、バス ドライバー、ルート デバイスです。

    電源マネージャーは、PCI バス デバイス スタックの先頭に IRP を送信しますそのドライバーは、完了ルーチンを設定し、下に IRP を渡して、 [ACPI の Windows ドライバー](acpi-driver.md)、Acpi.sys します。

5.  Acpi.sys は待機/ウェイク IRP は他の任意の PDO を送信しませんので、システムをスリープ解除できます。 ウェイク信号を受信するまで、Acpi.sys は保留中の IRP4 を保持します。

キーボードは、ウェイク アップの信号をアサートする場合は、Acpi.sys はインターセプトします。 ACPI、ただし、確認できません、キーボードにのみルート デバイスを介して、信号が付属するいると、シグナルがアサートされること。 Acpi.sys 完了 IRP4、および I/O マネージャーを呼び出す*IoCompletion*旅行ルーチンは、PCI デバイス スタックをバックアップします。 IRP4 が完了すると、すべて*IoCompletion*ルーチンが実行した場合、PCI ドライバのコールバック ルーチンが呼び出されます。 そのコールバック ルーチンでは、PCI ドライバは、信号が通過 USB ホスト コント ローラーを決定します。 PCI ドライバは、IRP3 を完了します。 同じシーケンスは、キーボードのドライバーが IRP1 を受信するまでに、USB ホスト コント ローラーのスタックと、USB ハブ スタックを介して行われます。 この時点でのキーボード ドライバーでは、必要に応じて、ウェイク アップ イベントを処理できます。

設定する必要がありますドライバー待機/ウェイク IRP を親 PDO に送信するたびに、 [*キャンセル*](https://msdn.microsoft.com/library/windows/hardware/ff540742) IRP を独自のルーチンです。 設定、*キャンセル*ルーチンはそれをトリガーした IRP が取り消された場合は、新しい IRP をキャンセルする機会、ドライバーを示します。 USB の例でのキーボード ドライバーがその待機/ウェイク IRP (したがってキーボードのウェイク アップを無効化) をキャンセルした場合、USB ハブ、USB ホスト コント ローラー、および PCI ドライバー取り消す必要があります Irp キーボード IRP の結果として送信します。 詳細については、[待機/ウェイク Irp のキャンセル ルーチン](canceling-a-wait-wake-irp.md#ddk-cancel-routines-for-wait-wake-irps-kg)を参照してください。

1 つだけ待機/ウェイク IRP が保留されているが、親のドライバーでは、待機またはスリープ解除を有効にできる 1 つ以上の子を列挙可能性があります、PDO の。 このような場合は、親のドライバーは待機/ウェイク IRP を保持することを確認してください保留中のときにそのデバイスのいずれかが有効になってウェイク アップします。 これを行うには、ドライバーは待機/ウェイク IRP を受信するたびに内部カウンターをインクリメントします。 ドライバーが待機/ウェイク IRP を完了するたびに、デクリメント カウントし、結果の値が 0 以外の場合は、そのデバイス スタックを別の待機またはスリープ解除 IRP を送信します。

USB の設定の例で示したなどで、 [USB のサンプル構成](#sample-usb-configuration)図、USB ハブは、2 つのデバイスや、キーボード、モデムを列挙します。 USB ハブのドライバーは、待機/ウェイク IRP キーボード PDO を受信すると、独自の PDO の IRP を要求する前に待機/ウェイク Irp のカウントをインクリメントします。 モデムのポリシーの所有者、モデムのウェイク アップ後で有効にした場合、USB ハブのドライバーのとれた PDO、モデムの新しい IRP と単位の待機/ウェイク参照カウントします。 ただし、PDO の USB ハブは、2 つ同時に保留中の待機/ウェイク Irp を含めることはできません、ため、USB ハブのドライバーは、新しい待機/ウェイク IRP の USB ハブ PDO は要求しません。

どのデバイスが通知されると、キーボード、モデムのいずれかからウェイク アップの信号が到着すると、USB ハブのドライバーを決定します IRP の対応する、およびデクリメント、参照カウントを完了します。 両方のデバイスがウェイク アップを有効になっている (および、参照カウントが 0 以外の場合はそのため)、ためには、別待機/ウェイク IRP を"rearm"ウェイク アップの独自の PDO を独自デバイス スタックに送信する必要があります。 (同じは PCI ドライバ、USB ホスト コント ローラーの場合は true) です。

ドライバーは、ただし、送信されません自体は IRP をウェイク アップのシグナルを受信したばかりの同じデバイスにウェイク アップの待機を再度有効にします。 デバイスの電源ポリシー マネージャーのみ実行できます。 待機またはスリープ解除を再有効化は自動ではありません。

 

 




