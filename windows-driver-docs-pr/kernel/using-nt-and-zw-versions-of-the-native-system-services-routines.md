---
title: Nt および Zw バージョンのネイティブシステムサービスルーチンの使用
description: Nt および Zw バージョンのネイティブシステムサービスルーチンの使用
ms.assetid: 89627ddb-621d-4d27-acd6-16308689165d
keywords:
- ネイティブシステムサービス API WDK
ms.date: 06/16/2017
ms.localizationpriority: medium
ms.openlocfilehash: 24178c710551d4cabd1543723d08ff573d4ee826
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72838343"
---
# <a name="using-nt-and-zw-versions-of-the-native-system-services-routines"></a>Nt および Zw バージョンのネイティブシステムサービスルーチンの使用


Windows ネイティブオペレーティングシステムサービス API は、カーネルモードで実行されるルーチンのセットとして実装されます。 これらのルーチンには、プレフィックス**Nt**または**Zw**で始まる名前が付いています。 カーネルモードドライバーは、これらのルーチンを直接呼び出すことができます。 ユーザーモードのアプリケーションは、システムコールを使用してこれらのルーチンにアクセスできます。

いくつかの例外を除き、それぞれのネイティブシステムサービスルーチンには、名前が似ていてプレフィックスが異なる2つの異なるバージョンがあります。 たとえば、 [Ntcreatefile](https://go.microsoft.com/fwlink/p/?linkid=157250)と[**zwcreatefile**](https://docs.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntcreatefile)を呼び出すと、同様の操作が実行され、実際には同じカーネルモードシステムルーチンによって処理されます。 ユーザーモードからのシステムコールの場合、 **Nt**および**Zw**バージョンのルーチンは同じように動作します。 カーネルモードドライバーからの呼び出しの場合、ルーチンの**Nt**および**Zw**バージョンは、呼び出し元がルーチンに渡すパラメーター値を処理する方法が異なります。

カーネルモードドライバーは、ネイティブシステムサービスルーチンの**Zw**バージョンを呼び出して、パラメーターが信頼されたカーネルモードのソースからのものであることをルーチンに通知します。 この場合、このルーチンでは、最初にパラメーターを検証せずに、パラメーターを安全に使用できると想定しています。 ただし、パラメーターがユーザーモードのソースまたはカーネルモードのソースのいずれかである場合は、代わりに、ドライバーは、呼び出し元のスレッドの履歴に基づいて、パラメーターがユーザーモードで発生したかどうかを判断する**Nt**バージョンのルーチンを呼び出します。またはカーネルモード。 ルーチンがユーザーモードパラメーターとカーネルモードパラメーターを区別する方法の詳細については、「前の[**モード**](previousmode.md)」を参照してください。

ユーザーモードアプリケーションがネイティブシステムサービスルーチンの**Nt**または**Zw**バージョンを呼び出すと、そのルーチンは、受け取ったパラメーターを、信頼されていないユーザーモードのソースから取得した値として常に扱います。 ルーチンは、パラメーターを使用する前にパラメーター値を徹底的に検証します。 特に、ルーチンは、呼び出し元が指定したバッファーをプローブして、バッファーが有効なユーザーモードメモリに配置され、適切にアラインされていることを確認します。

ネイティブシステムサービスルーチンは、受け取るパラメーターについて、追加の想定を行います。 ルーチンが、カーネルモードドライバーによって割り当てられたバッファーへのポインターを受け取る場合、このルーチンは、バッファーがユーザーモードメモリではなくシステムメモリに割り当てられたものと想定しています。 ルーチンがユーザーモードアプリケーションによって開かれたハンドルを受け取ると、ルーチンはカーネルモードハンドルテーブルではなく、ユーザーモードハンドルテーブルでハンドルを検索します。

いくつかのインスタンスでは、ユーザーモードとカーネルモードからの呼び出しの間で、パラメーター値の意味がより大きく異なります。 たとえば、 [**Zwnotifychangekey**](https://msdn.microsoft.com/library/windows/hardware/ff566488)ルーチン (またはそれに対応する**ntnotifychangekey** ) には、パラメーターが次のものであるかどうかによって異なることを意味する*Apcroutine*と*apcroutine*のペアがあります。ユーザーモードまたはカーネルモードのソース。 ユーザーモードからの呼び出しの場合、 *Apcroutine*は apc ルーチンをポイントし、 *APCROUTINE*は、apc ルーチンを呼び出すときにオペレーティングシステムによって提供されるコンテキスト値をポイントします。 カーネルモードからの呼び出しの場合、 *Apcroutine*は[**work\_queue\_item**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/ns-wdm-_work_queue_item)構造体を指し、 *apcroutine*は work **\_queue\_item**構造によって記述される作業キュー項目の種類を指定します。

ここでは、次のトピックについて説明します。

[**前のモード**](previousmode.md)

[ライブラリとヘッダー](libraries-and-headers.md)

[Zw プレフィックスは何を意味するのでしょうか。](what-does-the-zw-prefix-mean-.md)

[アクセス権の指定](access-mask.md)

[NtXxx ルーチン](ntxxx-routines.md)

 

 




