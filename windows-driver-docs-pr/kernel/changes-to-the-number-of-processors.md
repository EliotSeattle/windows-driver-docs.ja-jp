---
title: プロセッサ数の変更
description: プロセッサ数の変更
ms.assetid: 9ced4b42-c83d-49da-8405-b95b0c0144fa
keywords:
- 動的ハードウェアパーティション分割 WDK、プロセッサ数の変更
- ハードウェアのパーティション分割 WDK 動的、プロセッサ数の変更
- WDK 動的ハードウェアをパーティション分割し、プロセッサ数を変更する
- アクティブなプロセッサ WDK 動的ハードウェアパーティション分割
- プロセッサ数 WDK 動的ハードウェアパーティション分割
- プロセッサアフィニティ WDK 動的ハードウェア paritioning
- 'プロセッサごとのデータ構造: WDK 動的ハードウェアパーティション分割'
ms.date: 06/16/2017
ms.localizationpriority: medium
ms.openlocfilehash: a39ae1e5c04ef14e72a3e4b1809d0a35727f4319
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72828545"
---
# <a name="changes-to-the-number-of-processors"></a>プロセッサ数の変更


動的にパーティション分割されたサーバーでは、ハードウェアパーティションにプロセッサをいつでも追加できます。 そのため、ハードウェアパーティション内のアクティブなプロセッサの数、プロセッサの関係の値、または各アクティブなプロセッサに割り当てられているプロセッサの数について、想定しないでください。 プロセッサ関係の値に設定されているビットは、ハードウェアパーティション内の現在アクティブな各プロセッサを表します。 プロセッサをハードウェアパーティションに追加すると、設定されている特定のビットが変更されます。

次のいずれかのステートメントがデバイスドライバーに当てはまる場合は、プロセッサがハードウェアパーティションに動的に追加されるときに、動的にパーティション分割されたサーバーで正常に機能するようにドライバーを更新する必要があります。

-   デバイスドライバーは、ハードウェアパーティション内のアクティブなプロセッサの数を使用して、割り当てられるメモリの量、作成されるスレッドの数、または使用するその他のリソースの量など、使用するリソースの量を決定します。 この場合、プロセッサがハードウェアパーティションに動的に追加されると、デバイスドライバーのリソース割り当ては正しくありません。 これは、ドライバーのパフォーマンスや動作に悪影響を及ぼす可能性があります。

-   デバイスドライバーは、プロセッサ関係の値のビットを走査します。 この場合、プロセッサ関係の値に対する動的な変更を処理できないか、設定されているビットシーケンスのギャップを処理できないと、デバイスドライバーが正しく機能しない可能性があります。

-   デバイスドライバーは、プロセッサ関係の値のビットを使用して、ドライバーによって割り当てられたリソースを特定のプロセッサに割り当てます。 この場合、プロセッサがハードウェアパーティションに動的に追加されると、デバイスドライバーのリソース割り当ては正しくありません。 これは、ドライバーのパフォーマンスや動作に悪影響を及ぼす可能性があります。

-   デバイスドライバーは、各アクティブなプロセッサのデータ構造をハードウェアパーティションに割り当てます。 このような状況では、ハードウェアパーティションに動的に追加されたプロセッサのデータ構造にアクセスしようとすると、デバイスドライバーが悪影響を及ぼす、データの破損、またはバグチェックが発生する可能性があります。

-   デバイスドライバーのディスパッチルーチンは、そのプロセッサが実行されているプロセッサのプロセッサ番号を使用して、その特定のプロセッサに割り当てられているデータ構造またはその他のリソースにアクセスします。 このような状況では、デバイスドライバーのディスパッチルーチンによって、ハードウェアパーティションに動的に追加されたプロセッサのリソースにアクセスしようとしたときに、有害な動作やデータの破損が発生する可能性があります。

-   デバイスドライバーは、割り込みサービスルーチン (Isr)、遅延プロシージャ呼び出し (Dpc)、または特定のプロセッサ上のその他のスレッドをスケジュールします。 この場合、ハードウェアパーティションにプロセッサを追加すると、デバイスドライバーが正常に機能しなくなり、デバイスドライバーは新しいプロセッサを完全に使用できなくなります。

-   デバイスドライバーでは、リソースの再調整はサポートされていません。 この場合、デバイスドライバーは、割り込みを処理するためにハードウェアパーティションに追加された新しいプロセッサを使用できません。

-   デバイスドライバーは、負荷分散アルゴリズムを使用して、複数のプロセッサに i/o 要求の処理を分散します。 この場合、ハードウェアパーティションにプロセッサを追加すると、デバイスドライバーが正常に機能しなくなり、デバイスドライバーは新しいプロセッサを完全に使用できなくなります。

アクティブなプロセッサの数に対する変更によってデバイスドライバーが影響を受ける場合、プロセッサをハードウェアパーティションに追加したときに通知されるように、デバイスドライバーをオペレーティングシステムに登録する必要があります。 デバイスドライバーが通知されると、安全で最適な操作のために、必要に応じて応答できます。 デバイスドライバーをオペレーティングシステムに登録する方法の詳細については、「[ドライバーの通知](driver-notification.md)」を参照してください。

ハードウェアパーティション内の現在のアクティブなプロセッサ数を取得するには、デバイスドライバーが[**Kequeryactiveprocessorcount**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kequeryactiveprocessorcount)関数を呼び出す必要があります。 デバイスドライバーは、現在のプロセッサのアフィニティ値を取得するために、 [**Kequeryactiveprocessors**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kequeryactiveprocessors)関数または**Kequeryactiveprocessorcount**関数のいずれかを呼び出すことができます。

デバイスドライバーによってハードウェアパーティションにアクティブな各プロセッサのデータ構造が割り当てられ、新しいプロセッサのデータ構造のメモリ割り当てが失敗した場合、デバイスドライバーは、ドライバーの初期化中に、オペレーティングシステムがサポートするプロセッサの最大数を処理するのに十分なデータ構造を割り当てることが**できることを  し**ます。 このような状況では、新しいプロセッサをハードウェアパーティションに追加するときに、デバイスドライバーが新しいデータ構造を割り当てる必要はありません。 ただし、これらのデータ構造のサイズが非常に小さい場合を除き、メモリリソースの使用効率が悪くなる可能性があります。 デバイスドライバーは、 [**Kequerymaximumprocessorcount**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kequerymaximumprocessorcount)関数を呼び出すことによって、オペレーティングシステムがサポートするプロセッサの最大数を照会できます。

 

**重要**  デバイスドライバーは、プロセッサをハードウェアパーティションに追加したことが通知されたときに、常にアクティブなプロセッサの数とプロセッサのアフィニティの値を更新する必要があります。

 

**重要**  デバイスドライバーは、プロセッサのアフィニティ値に設定されているビットの数をカウントして、ハードウェアパーティション内のアクティブなプロセッサの数を判断することはできません。 デバイスドライバーでは、この目的のために**Kequeryactiveprocessorcount**関数を呼び出すことをお勧めします。 この関数は、アクティブなプロセッサの数と、関連付けられているプロセッサの関係の値の両方を返します。

 

**重要**  windows Vista 用に構築されたデバイスドライバでは、windows Server 2008 以降のバージョンの windows では、 [**KeNumberProcessors**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kequeryactiveprocessors)カーネル変数を使用して、ハードウェアパーティション内のアクティブなプロセッサの数を判断することはできません。 **KeNumberProcessors**カーネル変数は、Windows Vista Service Pack 1 (SP1)、windows Server 2008、およびそれ以降のバージョンの windows では廃止されています。

 

 

 




