---
title: IEEE 1394 バスでの非同期 I/O 要求パケットの送信
description: IEEE 1394 バスでの非同期 I/O 要求パケットの送信
ms.assetid: 93ad0cdf-5ac2-4916-b90e-1e64ca4494b6
keywords:
- 非同期 i/o 要求の送信
- WDK IEEE 1394 bus をアドレス指定する raw モード
- WDK IEEE 1394 バスの仮想モードアドレス指定
- 標準モードの WDK IEEE 1394 バスへのアドレス指定
- WDK IEEE 1394 バスに対応
- データブロック WDK IEEE 1394 バス
- 連続データブロック WDK IEEE 1394 バス
- 非増分データブロック WDK IEEE 1394 バス
- バッファー WDK IEEE 1394 バス
- バスリセット生成 WDK IEEE 1394 バス
- 世代 WDK IEEE 1394 バスのリセット
- WDK IEEE 1394 バスのロック
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 418efa59f4c8fc3a8143510c6c0740d60d4af011
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72841527"
---
# <a name="sending-asynchronous-io-request-packets-on-the-ieee-1394-bus"></a>IEEE 1394 バスでの非同期 I/O 要求パケットの送信





ドライバーは、要求\_非同期\_読み取り、要求\_非同期\_書き込み、要求\_非同期\_ロックを要求して、IEEE 1394 バス上のデバイスに非同期の読み取り、書き込み、およびロックの操作を送信します。 要求\_非同期\_読み取りと要求\_非同期\_書き込みの場合、IRB の操作固有のパラメーターは IRB の**AsyncRead**またはのメンバーに格納さ**れます。**

### <a name="types-of-addressing"></a>アドレス指定の種類

非同期 i/o 要求を行うドライバーでは、IRB の**Destinationaddress**メンバーの[**IO\_アドレス**](https://docs.microsoft.com/windows-hardware/drivers/ddi/1394/ns-1394-_io_address)型の宛先アドレスを指定する必要があります。 宛先アドレスは、ノードアドレスとアドレスオフセットの2つの値で構成されます。 バスドライバーがこれらの2つの値に与える解釈は、要求を開始するドライバーによって使用されるアドレス指定のモードによって異なります。

2つのアドレス指定モードを使用して、非同期1394パケット (*通常*、 *raw*、および*仮想*) を送信できます。

通常モードでは、要求を開始するドライバーはアドレスオフセットを指定しますが、ターゲットデバイスのノードアドレスは指定しません。 バスドライバーは、デバイスを列挙したときにデバイスの PDO に格納された情報を使用して、ノードアドレスを入力します。

Raw モードのアドレス指定では、要求を開始するドライバーは、ノードアドレスとアドレスオフセットの両方を提供する必要があります。 また、ターゲットデバイスの PDO に要求を送信するのではなく、ドライバーがホストコントローラーの PDO に要求を送信する必要があります。 これは、パケット内のノードアドレス情報を上書きしないようにバスドライバーに通知します。

仮想モードアドレス指定では、要求を開始するドライバーは、raw モードアドレス指定の場合と同様に、パケット内のターゲットデバイスのノードアドレスを明示的に示す必要があります。 ただし、仮想デバイスには、1394バス上の実際のノードアドレスがありません。 仮想デバイスのノードアドレスは、規則によって確立された値であり、仮想デバイスのドライバーがそのパケットを識別できるようにします。 正常に動作している場合、仮想デバイスドライバーは、バスでブロードキャストされたすべてのパケットを受信し、そのデバイスの "ノードアドレス" の事前に設定された値を含むパケットを検索します。

仮想デバイスの要求を開始するドライバーは、バスドライバーがパケットに記録されたノードアドレスを上書きしないようにするために、特別な手順を実行する必要はありません。 バスドライバーは、最初に仮想デバイスを列挙するときに、デバイスが仮想であることを示す、デバイスの PDO のデバイス拡張機能にフラグを設定します。 このデバイスの要求を受信すると、バスドライバーは、そのデバイスが仮想デバイスであることを確認できます。パケット内のノードアドレスは上書きされません。

### <a name="buffering-of-io-requests"></a>I/o 要求のバッファリング

非同期 i/o 要求を開始するドライバーは、i/o バッファーを指定する MDL へのポインターを提供する必要があります。 このポインターは、IRB の**Mdl**メンバーに格納されます。 バスドライバーは、このバッファーを使用して、デバイスから読み取ったデータをコピーします。または、デバイスに書き込むデータのソースとしてコピーします。

ドライバーは、 **nNumberOfBytesToRead**または**Nnumberofbytestowrite**のメンバーのデータバッファーのサイズを指定し**ます**。また、 **nblocksize**メンバーのブロックサイズを指定します。 トランザクションが実際に実行されると、バスドライバーは、 **Nblocksize**で指定されたサイズのパケットにデータを分割します。 既定では、バスドライバーはデータの読み取りまたは書き込みを連続して行います。各ブロックは、デバイスのアドレス空間内の複数の場所に対して読み取りまたは書き込みを行います。

次の図は、連続するデータブロックを示しています。

![連続するデータブロックを示す図](images/1394blkd.png)

必要に応じて、ドライバーは、要求の非同期\_フラグ\_非インクリメントフラグを指定できます。その後、バスドライバーは、ブロックごとに同じアドレスセットを使用します。

次の図は、非同期の非インクリメントデータブロックを示しています。

![非同期の非インクリメントデータブロックを示す図](images/1394blkf.png)

**警告**  バスドライバーは、デバイスとコンピューター間の現在の接続速度に対して最大の非同期パケットサイズを適用し、その構成 ROM の MAX\_REC フィールドにデバイスが報告する最大速度を設定します。 **Nblocksize**がこれらのいずれかの値より大きい場合、バスドライバーはブロックサイズに対して強制された値を使用します。 ドライバーで非同期\_フラグ\_設定しない場合は、必要な動作が得られない可能性があります。 ドライバーがこのフラグを設定する場合、要求を送信する前に、ブロックサイズが適用される制限よりも小さいことを確認する必要があります。

 

### <a name="sending-lock-requests"></a>ロック要求の送信

IEEE 1394 バスプロトコルには非同期ロック要求が用意されており、これによってアトミックなテストおよびセット型の操作が可能になります。 宛先アドレス ( **AsyncLock**) を指定するだけでなく、ドライバーはトランザクションの種類 ( **AsyncLock. fulTransactionType**) を指定します。 操作のデータ値と引数の値 (詳細については、「IEEE 1394 の仕様」を参照してください) は**AsyncLock**と**AsyncLock**で渡されます。

### <a name="bus-reset-generation"></a>バスリセット生成

非同期 i/o を使用するデバイスドライバーは、バスリセット生成を追跡します。 各非同期要求では、デバイスドライバーは、要求の IRB の**u. AsyncXxx**のメンバーにその値を報告します。 バスドライバーは、その値と実際の生成回数を比較します。一致しない場合は、状態の値が "状態" である要求を失敗として\_\_生成を無効にします。 要求がこのように失敗した場合、ドライバーは要求を使用して正しい生成をクエリし、\_生成\_カウントバス要求\_取得します。 ただし、ドライバーは、バスリセット通知コールバックで新しい世代を取得するまで、このステータスで失敗した要求を再発行しないでください。 これにより、デバイスが引き続きバス上に存在することが保証されます。 クライアントドライバーは、バスのリセットが通知されるようにリセット\_バス\_リセットする IRP\_に依存しないことに注意してください。 Windows XP 以降のオペレーティングシステムでは、IRP\_\_バス\_RESET は廃止されています。

 

 




