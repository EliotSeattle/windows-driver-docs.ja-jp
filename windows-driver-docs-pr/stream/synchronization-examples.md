---
title: 同期の例
description: 同期の例
ms.assetid: b9290fab-8213-4083-bda5-0e6c2af737a6
keywords:
- .Sys クラスドライバー WDK Windows 2000 カーネル、同期
- streaming ミニドライバー WDK Windows 2000 カーネル、同期
- ミニドライバー WDK Windows 2000 カーネルストリーミング、同期
- 同期 WDK streaming ミニドライバー
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 4fde59d3a379920982aeba2bc37941f969fcc247
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72837661"
---
# <a name="synchronization-examples"></a>同期の例





次の例では、同期に関してミニドライバーが行う必要があることを説明し、同期を使用しない場合の例を示します。

-   **例 1: ミニドライバーが機能している ISR を使用する**

    ストリームクラス同期が有効になっている場合、 [**KeSynchronizeExecution**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kesynchronizeexecution)を使用して、すべてのミニドライバーエントリポイントが発生した IRQL で呼び出されます。これは、ミニドライバーがコードを実行しているときに、アダプターの irq レベルとすべての下限の irq レベルがマスクされることを意味します。 このため、ミニドライバーでは、このモードでは少量の作業のみが実行されることが不可欠です。

    ミニドライバーは、発生した IRQL で通常は 10 ~ 20 マイクロ秒を超えるコードを実行しないでください。 *Stream*のデバッグビルドを使用する場合、ストリームクラスは、発生した IRQL にかかった時間をログに記録し、ドライバーがそれに費やしている時間が長すぎる場合はアサートします。 ミニドライバーが要求に対してハードウェア DMA レジスタをプログラミングする必要がある場合、または単に ISR のポートを読み取る必要がある場合、通常は、発生した IRQL ですべての処理を実行することが許容されます。

    ミニドライバーが、PIO を介してデータを転送するミニドライバーなど、数マイクロ秒以上かかる処理を実行する必要がある場合は、ミニドライバーで[**Streamclasscallatnewpriority**](https://docs.microsoft.com/windows-hardware/drivers/ddi/strmini/nf-strmini-streamclasscallatnewpriority)を使用してディスパッチ\_レベルのコールバックをスケジュールする必要があります。 コールバックでは、ミニドライバーが処理を行うまでに最大で 1/2 ~ 1 ミリ秒かかることがあります。 このモードでは、ディスパッチ\_レベルのコールバックが ISR と同期され*ない*という点に注意してください。

    この同期の欠如は、ミニドライバーがコールバックのリソース (ポートやキューなど) にアクセスしたときに、ISR にアクセスしたときに、ハードウェアが安定している場合には問題になりません。 しかし、不安定になる可能性がある場合は、ミニドライバーが**Streamclasscallatnewpriority**を使用して、ISR によって使用されるリソースと共有されるリソースに対するディスパッチ\_レベルのコールバックで優先度の高いコールバックをスケジュールする必要があります。

    優先順位の高いコールバックは、 **KeSynchronizeExecution**を呼び出すことと同じです。 **KeSynchronizeExecution**では、ミニドライバーが[**Streamclasscallatnewpriority**](https://docs.microsoft.com/windows-hardware/drivers/ddi/strmini/nf-strmini-streamclasscallatnewpriority)ではないいくつかのパラメーターを参照する必要がありますが、一般的に、この2つの結果は同じ動作になります。

    ミニドライバーが 1/2 ~ 1 ミリ秒を超えるコードを実行する必要がある場合や、場合によっては、パッシブ\_レベル (初期化時など) でサービスを呼び出す必要がある場合は、 **Streamclasscallatnewpriority**を LOW に設定します。優先順位は、パッシブ\_レベルのワーカースレッドを取得するために使用できます。 優先度の低いコールバックは何とも同期されず、ミニドライバーが新しい要求を受け取ることができることに注意してください ( **ReadyForNextRequest** NotificationType パラメーターが保留になっていることを前提としています)。または、低優先度のコールバックを実行するときに ISR を呼び出します。

-   **例 2: ISR のないミニドライバー**

    ストリームクラス同期が有効になっている場合、ミニドライバーのエントリポイントはすべてディスパッチ\_レベルで呼び出されます。 ミニドライバーは、優先度を調整することなく、最大で 1/2 ~ 1 ミリ秒の期間の処理を実行できます。 ミニドライバーが1/2 ミリ秒を超えるコードを実行する必要がある場合や、場合によっては、パッシブ\_レベル (初期化時など) でサービスを呼び出す必要がある場合は、低優先度の[**Streamclasscallatnewpriority**](https://docs.microsoft.com/windows-hardware/drivers/ddi/strmini/nf-strmini-streamclasscallatnewpriority)を使用できます。パッシブ\_レベルのワーカースレッドを取得するために使用します。 優先度の低いコールバックは何にも同期されないことに注意してください。低優先度のコールバックを実行すると、ミニドライバーが新しい要求を受け取ることができます ( **ReadyForNextRequest** NotificationType パラメーターが保留されていることを前提としています)。

-   **ストリームクラスの同期を** **使用**しない場合

    ストリームクラスの同期を使用しない場合の例を次に示します。 たとえば、次のような場合です。

    -   ドライバーが頻繁に (ミニドライバーが受信する要求の20% 以上)、1ミリ秒以上かかる処理を実行する必要がある場合、または Microsoft DirectDraw サービスなどのパッシブ\_レベルサービスを頻繁に呼び出す必要がある場合。 *Stream*のデバッグバージョンを使用する場合、stream クラスはこれらの両方のケースをアサートし、同期が有効になっていることが検出された場合は停止します。
    -   ミニドライバーが、ハードウェアが関連付けられていないフィルターの場合。 このようなミニドライバーは、同期に使用する基になるハードウェアがなく、ミニドライバーが通常大量の処理を行うため、パッシブ\_レベルで実行する必要があります。 この場合は、ストリームクラス同期を使用してオーバーヘッドを無駄にするよりも、独自の同期を行う方が簡単です。 必要に応じて、ミューテックスを使用してキューを保護します。

        多くの場合、同期コードのバグは検出が困難になることがあります。また、特定の環境 (マルチプロセッサシステムで実行されている NT ベースのオペレーティングシステムなど) では、バグは数時間のストレスが発生した後にのみ表示される可能性があります。 ベンダーの経験に基づいて、これらは、ほとんどのベンダーがデバッグに必要な機能を持つものではありません。 完全に非同期の WDM デバイスドライバーの記述に精通しているドライバーライターだけが、独自の同期を実行する必要があります。

    -   ミニドライバーが、実際のハードウェアの同期を気にせずに、実際のハードウェアの同期を気にせずに、次の\_層に要求を呼び出しただけで、コールバックを受信するバスオンバスタイプドライバー (たとえば、USB または1394周辺ドライバー) の場合。通常はディスパッチ\_レベルです。

 

 




