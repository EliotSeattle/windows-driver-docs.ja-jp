---
title: 割り込みストームのデバッグ
description: 割り込みストームのデバッグ
ms.assetid: b863cb9c-dce0-4572-b0ed-6f7d3a6ba472
keywords:
- 保留中の Irp
- 保留中の I/O 要求パケット (IRP)
ms.date: 05/23/2017
ms.localizationpriority: medium
ms.openlocfilehash: d78ad3206adb2f283c924098b620ce818e19dc0b
ms.sourcegitcommit: 0cc5051945559a242d941a6f2799d161d8eba2a7
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/23/2019
ms.locfileid: "63377196"
---
# <a name="debugging-an-interrupt-storm"></a>割り込みストームのデバッグ


## <span id="ddk_debugging_pending_irps_dbg"></span><span id="DDK_DEBUGGING_PENDING_IRPS_DBG"></span>


停止しているシステムの最も一般的な例の 1 つは、大量の割り込みです。 *割り込み storm*アサートされている状態で残っているレベルによってトリガーされる割り込みシグナルです。

次のイベントには、大量の割り込みが発生します。

-   ハードウェア デバイスが、デバイス ドライバーに送信した後は、割り込みシグナルを解放しません。

-   デバイス ドライバーは、割り込みシグナルを解放するには、そのハードウェアよう指示しない割り込みがそのハードウェアから開始されたことが検出されないためです。

-   デバイス ドライバーは、ハードウェアから割り込みが開始しない場合でも、割り込みを要求します。 このような状況は、複数のデバイスが同じ IRQ を共有する場合にのみ発生します。

-   Edge のレベルの制御レジスタ (ELCR) が正しく設定されていません。

-   割り込みによってトリガーされるデバイスの edge とレベルは、IRQ (たとえば、COM ポートおよび PCI SCSI コント ローラー) を共有します。

この例では、1 つを検出して、大量の割り込みのデバッグの方法を示します。

マシンがハングしたときにが破損してカーネル デバッガーを使用します。 使用して、 **! irpfind** Irp の保留中検索する拡張機能コマンド。 次に、使用、 **! irp** Irp 保留中の詳細を取得する拡張機能。 次に、例を示します。

```dbgcmd
kd> !irp 81183468 
Irp is active with 2 stacks 2 is current (= 0x811834fc)
 No Mdl Thread 00000000:  Irp stack trace.
     cmd  flg cl Device   File     Completion-Context
 [  0, 0]   0  0 8145f470 00000000 00000000-00000000
               \Driver\E100B
                        Args: 00000000 00000000 00000000 00000000
>[ 16, 2]   0 e1 8145f470 00000000 8047f744-814187a8 Success Error Cancel pending
               \Driver\E100B    ntoskrnl!PopCompleteSystemPowerIrp
                        Args: 00000000 00000000 00000002 00000002 
```

この例では\\ドライバー\\e100b がの IRP を返さない**ntoskrnl!PopCompleteSystemPowerIrp**します。 残っているように表示され、大量の割り込みが発生している可能性があります。

調査のため、使用、 **kb**スタック トレースを要求するコマンド。 次に、例を示します。

```dbgcmd
kd> kb
ChildEBP RetAddr  Args to Child
f714ee68 8046355a 00000001 80068c10 00000030 ntoskrnl!RtlpBreakWithStatusInstruction
f714ee68 80067a4f 00000001 80068c10 00000030 ntoskrnl!KeUpdateSystemTime+0x13e
f714eeec 8046380b 01001010 0000003b f714ef00 halacpi!HalBeginSystemInterrupt+0x83
f714eeec 80463c50 01001010 0000003b f714ef00 ntoskrnl!KiChainedDispatch+0x1b
f714ef78 80067cc2 00000000 00000240 8000017c ntoskrnl!KiDispatchInterrupt
f714ef78 80501cb5 00000000 00000240 8000017c halacpi!HalpDispatchInterrupt2ndEnt  
```

太字のセクションでは、割り込みのディスパッチであることを確認します。 使用する場合、 **g**コマンドともう一度中断により、多くの場合、別のスタック トレースが表示されますが、割り込みのディスパッチが表示されます。 2 番目のパラメーターに渡される見て割り込みがシステム停止の責任で判断**HalBeginSystemInterrupt** (この例では、0x3B) では。 標準の規則は、割り込みのベクター (0x3B) が表示されますが、IRQ 番号 0 xb を加えた 0x30、割り込みようにします。 別のスタック トレースを実行するいると、割り込みサービス要求 (ISR) を発行したデバイスの詳細についてが提供することがあります。 この場合、2 つ目のスタック トレースは、次の結果があります。

```dbgcmd
kd> kb
ChildEBP RetAddr  Args to Child
f714ee24 8046355a 00000001 00000010 00000030 ntoskrnl!RtlpBreakWithStatusInstruction
f714ee24 bfe854b9 00000001 00000010 00000030 ntoskrnl!KeUpdateSystemTime+0x13e
f714eed8 f7051796 00000000 80463850 8143ec88 atimpab!AtiInterrupt+0x109
f714eee0 80463850 8143ec88 81444038 8046380b VIDEOPRT!pVideoPortInterrupt+0x16
f714eef8 80463818 00000202 0000003b 80450bb8 ntoskrnl!KiChainedDispatch2ndLvl+0x28
f714eef8 80463c50 00000202 0000003b 80450bb8 ntoskrnl!KiChainedDispatch+0x28
f714ef78 80067cc2 00000000 00000240 8000017c ntoskrnl!KiDispatchInterrupt
f714ef78 80501cb5 00000000 00000240 8000017c halacpi!HalpDispatchInterrupt2ndEntry+0x1b
f714f084 8045f744 f714f16c 00020019 f714f148 ntoskrnl!NtCreateKey+0x113
f714f084 8042e487 f714f16c 00020019 f714f148 ntoskrnl!KiSystemService+0xc4
f714f118 804ab556 f714f16c 00020019 f714f148 ntoskrnl!ZwCreateKey+0xb
f714f184 8041f75b f714f1e8 8000017c f714f1d0 ntoskrnl!IopCreateRegistryKeyEx+0x4e
f714f204 804965cd 8145f630 00000000 00000001 ntoskrnl!IopProcessSetInterfaceState+0x93
f714f220 bfee1eb9 8145f630 00000000 8145f5a0 ntoskrnl!IoSetDeviceInterfaceState+0x2b
f714f254 bfedb416 00000004 00000800 0045f570 NDIS!ndisMCommonHaltMiniport+0x1f
f714f268 bfed4ddb bfed0660 811a2708 811a2708 NDIS!ndisPmHaltMiniport+0x9a
f714f288 bfed5146 811a2708 00000004 8145f570 NDIS!ndisSetPower+0x1d1
f714f2a8 8041c60f 81453a30 811a2708 80475b18 NDIS!ndisPowerDispatch+0x84
f714f2bc 8044cc52 80475b18 811a2708 811a279c ntoskrnl!IopfCallDriver+0x35
f714f2d4 8044cb89 811a279c 811a2708 811a27c0 ntoskrnl!PopPresentIrp+0x62 
```

システムには、ビデオ カードの ISR が現在実行中です。 システムは、ISR を IRQ 0 xb を共有するデバイスごとに実行されます。 プロセスには、割り込み要求なし、オペレーティング システムは待機無限、割り込みを処理するために isr を特定のドライバーを要求します。 プロセスの割り込みを処理および停止し、可能性がありますが、ハードウェアが切断された場合、割り込みが再アサートするだけです可能性がありますもできます。

使用して、 **! アービター 4** IRQ 0 xb でデバイスがされた特定の拡張機能。 IRQ 0 xb に 1 つだけのデバイスがある場合、問題の原因が見つかりました. 割り込み (ケースの 99%) を共有する 1 つ以上のデバイスがある場合は、(これは、システム状態に破壊的な) LNK ノードを手動でプログラミングするかを削除するか、ハードウェアを無効にすると、デバイスを分離する必要があります。

```dbgcmd
kd> !arbiter 4 
DEVNODE 8149a008 (HTREE\ROOT\0)
  Interrupt Arbiter "RootIRQ" at 80472a20
    Allocated ranges:
      0000000000000000 - 0000000000000000   B   8149acd0
      0000000000000001 - 0000000000000001   B   8149acd0
      0000000000000002 - 0000000000000002   B   8149acd0
      0000000000000003 - 0000000000000003   B   8149acd0
      0000000000000004 - 0000000000000004   B   8149acd0
      0000000000000005 - 0000000000000005   B   8149acd0
      0000000000000006 - 0000000000000006   B   8149acd0
      0000000000000007 - 0000000000000007   B   8149acd0
      0000000000000008 - 0000000000000008   B   8149acd0
      0000000000000009 - 0000000000000009   B   8149acd0
      000000000000000a - 000000000000000a   B   8149acd0
      000000000000000b - 000000000000000b   B   8149acd0
      000000000000000c - 000000000000000c   B   8149acd0
 000000000000000d - 000000000000000d   B   8149acd0
      000000000000000e - 000000000000000e   B   8149acd0
 000000000000000f - 000000000000000f   B   8149acd0
      0000000000000010 - 0000000000000010   B   8149acd0
      0000000000000011 - 0000000000000011   B   8149acd0
      0000000000000012 - 0000000000000012   B   8149acd0
      0000000000000013 - 0000000000000013   B   8149acd0
      0000000000000014 - 0000000000000014   B   8149acd0
      0000000000000015 - 0000000000000015   B   8149acd0
      0000000000000016 - 0000000000000016   B   8149acd0
      0000000000000017 - 0000000000000017   B   8149acd0
      0000000000000018 - 0000000000000018   B   8149acd0
      0000000000000019 - 0000000000000019   B   8149acd0
      000000000000001a - 000000000000001a   B   8149acd0
      000000000000001b - 000000000000001b   B   8149acd0
      000000000000001c - 000000000000001c   B   8149acd0
      000000000000001d - 000000000000001d   B   8149acd0
 000000000000001e - 000000000000001e   B   8149acd0
      000000000000001f - 000000000000001f   B   8149acd0
 0000000000000020 - 0000000000000020   B   8149acd0
      0000000000000021 - 0000000000000021   B   8149acd0
      0000000000000022 - 0000000000000022   B   8149acd0
      0000000000000023 - 0000000000000023   B   8149acd0
      0000000000000024 - 0000000000000024   B   8149acd0
      0000000000000025 - 0000000000000025   B   8149acd0
      0000000000000026 - 0000000000000026   B   8149acd0
      0000000000000027 - 0000000000000027   B   8149acd0
      0000000000000028 - 0000000000000028   B   8149acd0
      0000000000000029 - 0000000000000029   B   8149acd0
      000000000000002a - 000000000000002a   B   8149acd0
      000000000000002b - 000000000000002b   B   8149acd0
      000000000000002c - 000000000000002c   B   8149acd0
 000000000000002d - 000000000000002d   B   8149acd0
      000000000000002e - 000000000000002e   B   8149acd0
 000000000000002f - 000000000000002f   B   8149acd0
      0000000000000032 - 0000000000000032   B   8149acd0
      0000000000000039 - 0000000000000039 S     814776d0  (ACPI)
    Possible allocation:
      < none >

    DEVNODE 81476f28 (ACPI_HAL\PNP0C08\0)
      Interrupt Arbiter "ACPI_IRQ" at bfff10e0
        Allocated ranges:
          0000000000000000 - 0000000000000000   B   81495bb0
          0000000000000001 - 0000000000000001       814952b0  (i8042prt)
          0000000000000003 - 0000000000000003 S     81495610  (Serial)
          0000000000000004 - 0000000000000004   B   8149acd0
          0000000000000006 - 0000000000000006       81495730  (fdc)
          0000000000000008 - 0000000000000008       81495a90
          0000000000000009 - 0000000000000009 S     814776d0  (ACPI)
          000000000000000b - 000000000000000b S
            000000000000000b - 000000000000000b S     81453c30  (ds1)
            000000000000000b - 000000000000000b S     81453a30  (E100B)
            000000000000000b - 000000000000000b S     81493c30  (uhcd)
            000000000000000b - 000000000000000b S     8145c390  (atirage3)
          000000000000000c - 000000000000000c       814953d0  (i8042prt)
 000000000000000d - 000000000000000d   B   81495850
          000000000000000e - 000000000000000e       8145bb50  (atapi)
 000000000000000f - 000000000000000f       8145b970  (atapi)
        Possible allocation:
          < none > 
```

ここでは、オーディオ、ユニバーサル シリアル バス (USB)、ネットワーク インターフェイス カード (NIC)、およびビデオはすべて同じ IRQ を使用します。

割り込みのどの ISR 要求の所有権を確認するには、ISR からの戻り値を調べる 単に ISR を使用して、逆アセンブル、 **U**コマンド指定されたアドレスを **! アービター**表示、および (これは、'ret' 命令になります) ISR の最後の命令にブレークポイントを設定します。 コマンドを使用している**g&lt;アドレス&gt;** そのアドレスにブレークポイントを設定するのと同じです。

```dbgcmd
kd> g bfe33e7b 
ds1wdm!AdapterIsr+ad:
bfe33e7b c20800           ret     0x8 
```

使用して、 **r**レジスタを確認するコマンド。 具体的には、EAX レジスタを見てください。 レジスタの内容は、(次のコード例では) で太字の部分が他のものを 0 の場合は、この ISR 割り込みを要求しました。 それ以外の場合、割り込みが請求されていないと、オペレーティング システムでは、[次へ] の ISR を呼び出します この例では、ビデオ カードが割り込みを要求していないことを示します。

```dbgcmd
kd> r 
eax=00000000 ebx=813f4ff0 ecx=00000010 edx=ffdff848 esi=8145d168 edi=813f4fc8
eip=bfe33e7b esp=f714eec4 ebp=f714eee0 iopl=0         nv up ei pl zr na po nc
cs=0008  ss=0010  ds=0023  es=0023  fs=0030  gs=0000             efl=00000246
ds1wdm!AdapterIsr+ad:
bfe33e7b c20800           ret     0x8 
```

実際には、この場合は、割り込みによって請求されていない IRQ 0 xb 上のデバイスのいずれか。 この問題が発生したときに、割り込みに関連付けられているハードウェアの各部分が実際に有効になっているかどうかを確認する必要がありますもします。 PCI、これは簡単に--参照によって表示される、CMD レジスタで、 **! pci**拡張機能の出力。

```dbgcmd
kd> !pci 0 0 
PCI Bus 0
00:0  8086:7190.03  Cmd[0006:.mb...]  Sts[2210:c....]  Device  Host bridge
01:0  8086:7191.03  Cmd[0107:imb..s]  Sts[0220:.6...]  PciBridge 0->1-1  PCI-PCI bridge
03:0  1073:000c.03  Cmd[0000:......]  Sts[0210:c....]  Device  SubID:1073:000c Audio device
04:0  8086:1229.05  Cmd[0007:imb...]  Sts[0290:c....]  Device  SubID:8086:0008 Ethernet
07:0  8086:7110.02  Cmd[000f:imb...]  Sts[0280:.....]  Device  ISA bridge
07:1  8086:7111.01  Cmd[0005:i.b...]  Sts[0280:.....]  Device  IDE controller
07:2  8086:7112.01  Cmd[0005:i.b...]  Sts[0280:.....]  Device  USB host controller
07:3  8086:7113.02  Cmd[0003:im....]  Sts[0280:.....]  Device  Class:6:80:0 
```

オーディオのチップの CMD レジスタがゼロであるに注意してください。 つまり、この時点で、オーディオ チップは無効になります。 これは、オーディオ、チップができないことに対応できるアクセス、ドライバーによっても意味します。

この場合、オーディオのチップを手動で再度有効にする必要があります。

 

 





