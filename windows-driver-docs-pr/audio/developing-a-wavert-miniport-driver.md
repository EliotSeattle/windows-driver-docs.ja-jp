---
title: WaveRT ミニポート ドライバーの開発
description: WaveRT ミニポート ドライバーの開発
ms.assetid: d2d37c9e-fbfb-4bf3-bd7d-c8e19070a3f1
ms.date: 07/03/2017
ms.localizationpriority: medium
ms.openlocfilehash: 881105e63faa200ebcc09461a9ff8136f69f0402
ms.sourcegitcommit: a33b7978e22d5bb9f65ca7056f955319049a2e4c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/31/2019
ms.locfileid: "56530588"
---
# <a name="developing-a-wavert-miniport-driver"></a>WaveRT ミニポート ドライバーの開発


このトピックでは、ソフトウェアとハードウェアに関連するポイントを WaveRT ミニポート ドライバーを開発するときに考慮する必要がありますを示します。

Microsoft は一連のハードウェア設計のガイドラインを開発、[ユニバーサル オーディオ アーキテクチャ (UAA)](https://download.microsoft.com/download/9/c/5/9c5b2167-8017-4bae-9fde-d599bac8184a/UAA_Guidelines.doc)し、ガイドラインをお勧め WaveRT オーディオ デバイスの機能を組み込むことです。 UAA ガイドラインは Intel が開発した高精細画質 (HD) オーディオ仕様に密接に基づきます。

Windows Vista と以降の Windows オペレーティング システムは、UAA 準拠のオーディオ デバイスに対して、HD オーディオ ドライバーを提供します。 したがって、オーディオ デバイスが UAA 準拠の場合は、WaveRT ミニポート ドライバーを開発する必要はありません。 ただし、いくつか専用、非 UAA ハードウェア機能のオーディオ デバイスは、独自の機能をサポートするために、独自の WaveRT ミニポート ドライバーを開発する必要があります。

WaveRT ミニポート ドライバーを開発するために、最初、サンプル アダプターのドライバーを確認し、WaveRT に適した UAA 機能を確認することお勧めします。

### <a name="span-idthesampleadapterdriverspanspan-idthesampleadapterdriverspanthe-sample-adapter-driver"></a><span id="the_sample_adapter_driver"></span><span id="THE_SAMPLE_ADAPTER_DRIVER"></span>サンプル アダプターのドライバー

ドライバーのサンプルについては、次を参照してください。[サンプル オーディオ ドライバー](sample-audio-drivers.md)します。

### <a name="span-idthewavertfriendlyfeaturesspanspan-idthewavertfriendlyfeaturesspanthe-wavert-friendly-features"></a><span id="the_wavert_friendly_features"></span><span id="THE_WAVERT_FRIENDLY_FEATURES"></span>WaveRT フレンドリな機能

開始、WaveRT ミニポート ドライバーを設計してサンプル アダプターのドライバーを確認した後は、次のソフトウェアとハードウェアの機能をサポートしていることを確認する必要があります。 その結果、しをビルドするミニポート ドライバーが WaveRT ポートのシステムによって提供されるドライバーとは、Windows Vista の操作のモードと互換性のある[オーディオ エンジン](exploring-the-windows-vista-audio-engine.md)します。

-   **ハードウェアの低待機時間。** WaveRT ミニポート ドライバーは、完全に機能の実装を提供する必要があります、 [ **IMiniportWaveRTStream::GetHWLatency** ](https://msdn.microsoft.com/library/windows/hardware/ff536747)メソッド。 このメソッドは、サポートに必要な[ **KSPROPERTY\_RTAUDIO\_HWLATENCY** ](https://msdn.microsoft.com/library/windows/hardware/ff537378)プロパティ。

-   **FIFO を中断します。** WaveRT ミニポート ドライバーは、割り込みに自動的に生成する必要があります FIFO オーバーランとアンダーランが発生します。 この機能は、オーディオ デバイスとドライバー ソフトウェアのテストを実行すると、オーディオ ストリーム内の異常の検出を使用できます。 ハードウェアのサポートがない場合 (つまり、FIFO 中断)、不具合情報を取得するために便利で信頼性の高いメソッドが存在しません。

-   **DMA とバッファーのループ、スキャッター/ギャザーします。** ミニポート ドライバーでは、スキャッター/ギャザーの機能を備えている DMA コント ローラーをサポートするときに、ミニポート ドライバーからの介入を必要としない循環バッファーの内外に移動するデータができます。

    ミニポート ドライバーでは、バッファーのループを実行できる DMA コント ローラーをサポートするときに DMA コント ローラーできます自動的に、読み取りバッファーの末尾に達した後、バッファーの先頭にラップまたは書き込み操作。 ラップの介入なしには、ミニポート ドライバーから実行できます。

    WaveRT ポート ドライバーがスキャッター/ギャザー転送または自動のバッファーのループを実行する機能がない既存のハードウェア設計をサポートしていることに注意してください。

    オーディオ デバイスでは、スキャッター/ギャザー機能がない場合、WaveRT ミニポート ドライバーは最初のメモリ内で物理的に連続しているページで構成される循環バッファーを割り当てる必要があります。 ミニポート ドライバーはし、データ転送および自動のバッファーのループを実行するのに、WaveRT ポート ドライバーのヘルパー関数を使用します。 欠点は、ように、システムの非ページ メモリ プールの断片化、連続した物理メモリの大きなブロックを割り当てることの要求が失敗する可能性が高くなります。 スキャッター/ギャザーの機能を使用したデバイスは、メモリの断片化の影響を受けません。

    オーディオ デバイスは、DMA チャネルが循環バッファーの末尾に達すると、バッファーのループを自動的に実行できません、WaveRT ミニポート ドライバーでは介入し、バッファーの先頭にあるデータの転送を開始するチャネルを構成する必要があります。

-   **位置に登録します。** 新しい設計は、ハードウェアの実装者は、DMA チャネルごとの位置のレジスタを含める必要があります。 位置、レジスタでは、循環バッファーの先頭からのバイト オフセットとして現在のバッファー位置を示します。 読み取り位置レジスタは、バッファーの先頭に 0 です。 位置、レジスタでは、循環バッファーの末尾に達すると、その (0 にリセット) バッファーの先頭に戻って自動的に、バッファーの位置の進歩としてインクリメントし続けます。

    位置のレジスタは、クライアントは、レジスタを直接読み取ることができるように、仮想メモリにマップできます。

    理想的には、位置のレジスタは、オーディオ デバイスのアナログ デジタルおよびアナログ/デジタル コンバーター (Dac および ADCs) を使って現在移動できるサンプルのバッファーの位置を示す必要があります。

    ただし、この情報は、デジタルおよびアナログ関数を別のバス コント ローラーとエンコーダー/デコーダー (コーデック) チップに分割するオーディオのチップセットから直接使用できません可能性があります。 通常、位置、レジスタでは、バス コント ローラー チップにし、各レジスタは、コント ローラーがへの書き込みまたは読み取り、コーデックからオーディオ データの位置を示します。

    この種類の位置から、読み取りを得た後で登録は、クライアントは、Dac または ADCs を加算または減算コーデックを遅延して移動するサンプルの現在の位置を見積もることができます。 クライアントからコーデックの遅延を取得する、 **KSPROPERTY\_RTAUDIO\_HWLATENCY**プロパティ要求。 このため、WaveRT ミニポート ドライバーする必要があります正確に報告コーデック遅延ポート ドライバーを呼び出すと、 **IMiniportWaveRTStream::GetHardwareLatency**メソッドをこの種類のプロパティの要求に応答します。

    WaveRT ポート ドライバーが位置レジスタがない既存のハードウェア設計をサポートしていることに注意してください。 WaveRT ミニポート ドライバー制限はこのデバイスへの呼び出しが失敗する必要があります、 [ **IMiniportWaveRTStream::GetPositionRegister** ](https://msdn.microsoft.com/library/windows/hardware/ff536752)メソッドを返すことによって、**状態\_いない\_サポートされている**エラー コードは、強制的に失敗するポート ドライバー [ **KSPROPERTY\_RTAUDIO\_POSITIONREGISTER** ](https://msdn.microsoft.com/library/windows/hardware/ff537381)プロパティに要求します。 この場合、クライアントが現在位置からを取得する必要があります、 [ **KSPROPERTY\_オーディオ\_位置**](https://msdn.microsoft.com/library/windows/hardware/ff537297)プロパティで、ユーザー モードの間の遷移のオーバーヘッドが発生します各位置のカーネル モードの読み取り。

-   **クロックに登録します。** クロックの登録は、WaveRT と互換性のあるオーディオ デバイスのハードウェアの省略可能ですが、便利な機能です。 オーディオ アプリケーション プログラムでは、2 つ以上独立したオーディオ デバイスで同期されていない別のハードウェア クロックのオーディオ ストリームを同期するのに時計のレジスタを使用できます。 クロックのレジスタせず、アプリケーションを検出し、ハードウェア クロック間ドリフトを修正できません。

    デジタルのアナログまたはアナログ/デジタル コンバーターを使ってオーディオ データを clock へのオーディオ ハードウェアを使用するサンプルのクロックは、クロックのレジスタをインクリメントする内部クロックから派生する必要があります。 サンプル クロックに対して非同期であるレートで値が増加する時計レジスタは、同期を使用しないのは、および公開してはなりません。

    位置レジスタと同様に、クロック レジスタにマップできる仮想メモリのクライアントが直接登録を読み取ることができるようにします。

-   **オーディオ処理オブジェクト。** 適切に設計された WaveRT ミニポート ドライバーでは、オーディオ デバイスの循環バッファー内のオーディオ データをタッチする必要があることはありません。 ハードウェアは、オーディオ ドライバー ソフトウェアがクライアントとの介入なしでのオーディオ ハードウェア間で直接オーディオ データが流れるように設計する必要があります。 ただし、Windows Vista では、この規則に違反せずにオーディオ データの処理をソフトウェアを実行するオーディオ処理オブジェクト (APOs) の 2 つの種類をサポートします。

    -   ローカルの効果 (LFX) APOs

        LFX APOs では、特定のオーディオ デバイスに固有ではないジェネリック オーディオ処理関数 (たとえば、イコライゼーション) を実行します。 ストリームがグローバル ミックスに追加する前に、LFX APO はアプリケーションからのオーディオ ストリームを処理します。

    -   グローバルの効果 (GFX) APOs

        GFX APOs では、オーディオ ストリームのハードウェアに固有の処理を実行します。 GFX APO はデバイスをインストールする INF ファイルで特定のオーディオ デバイスに関連付けられています。 オーディオ デバイスで再生されるグローバル ミックスに影響するので、GFX APO の効果はグローバルです。
    
    グローバルの混在は、オーディオのすべてのアプリケーションからのオーディオ ストリームの混在を担当するユーザー モード システム コンポーネント、オーディオ エンジンによって実行されます。 通常、オーディオ エンジンは、循環バッファーを使用して WaveRT オーディオ デバイスで直接データを交換するクライアントです。

    ユーザーが有効な LFX APO、ときに、オーディオ システムは、オーディオ エンジンへの入力ストリームのいずれかに、APO を挿入します。 GFX APO ことができます、ときに、システムは、オーディオ エンジンからの出力ストリームにその APO を挿入します。 LFX と GFX APOs およびオーディオ エンジンの詳細については、次を参照してください。、 [、Windows Vista のオーディオ エンジンが調べる](exploring-the-windows-vista-audio-engine.md)トピック。

    APOs、オーディオ ストリームの共有モードでのみ使用できます。 排他モード ストリームは、アプリケーションは、循環バッファーを WaveRT ハードウェア デバイスと直接データを交換およびその他のコンポーネントがバッファー内のデータをタッチありません。

 

 




