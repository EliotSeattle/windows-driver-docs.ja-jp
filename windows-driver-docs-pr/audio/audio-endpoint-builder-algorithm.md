---
title: Audio Endpoint Builder のアルゴリズム
description: Audio Endpoint Builder のアルゴリズム
ms.assetid: 2338bca7-5743-42c3-9baf-ac4a54cf0393
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: aac4c8b70594f341c51b2109aa17e185c59d3ec7
ms.sourcegitcommit: 0cc5051945559a242d941a6f2799d161d8eba2a7
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/23/2019
ms.locfileid: "63331512"
---
# <a name="audio-endpoint-builder-algorithm"></a>Audio Endpoint Builder のアルゴリズム


Windows Vista および Windows の以降のバージョンでは、AudioEndpointBuilder は、列挙、初期化、およびシステム オーディオのエンドポイントをアクティブにするシステム サービスです。 このトピックでは、AudioEndpointBuilder サービスによって使用されるアルゴリズムの概要を示します。

AudioEndpointBuilder サービスは、探索エンドポイントを列挙し、アルゴリズムを使用します。 アルゴリズムは、(MUXed) キャプチャ デバイスを多重化して、ホストの複数ピンと複数のブリッジの pin、またはその両方を含むトポロジで動作するシステム アクセスを簡略化に設計されています。

Windows XP でオーディオのモデルでは、用語のオーディオ デバイスを使用し、プラグ アンド プレイ (PnP) ツリーの概念のデバイスを参照してください。 Windows Vista および以降のバージョンの Windows では、オーディオ デバイスの概念が再設計されました、ユーザーが物理的に対話するデバイスの表現が向上しました。

Windows Vista での 2 つの新しい Api を使用した[MMDevice API](https://go.microsoft.com/fwlink/p/?linkid=130863)と[WASAPI](https://go.microsoft.com/fwlink/p/?linkid=130864)、アクセスし、これらの新しいオーディオ デバイスを操作することができます。 MMDevice API は、エンドポイントとして新しいオーディオ デバイスを指します。

AudioEndpointBuilder サービス モニター、 [ **KSCATEGORY\_オーディオ**](https://msdn.microsoft.com/library/windows/hardware/ff548261)デバイス インターフェイスの到着と削除のためのクラス。 オーディオ デバイスが、KSCATEGORY の新しいインスタンスを登録するときに\_オーディオ デバイス インターフェイスのクラス、AudioEndpointBuilder サービスは、デバイス インターフェイスの通知を検出し、アルゴリズムを使用して、トポロジ内のオーディオ デバイスの確認システムを適切なアクション。

AudioEndpointBuilder によって使用されるアルゴリズムのしくみを次に示します。

1.  ピンが接続されていないブリッジを検索します。

2.  ピンが接続されていないブリッジ エンドポイントを作成します。 たとえば、AudioEndpointBuilder が、暗証番号 (pin) カテゴリの GUID の KSNODETYPE、接続されていないブリッジの pin を見つかると\_講演者、このブリッジの暗証番号 (pin) のスピーカー エンドポイントを作成しますが。 KSNODETYPE の詳細については\_スピーカーとその他の暗証番号 (pin) カテゴリ GUID WinDDK で Ksmedia.h を参照してください。\\&lt;ビルド番号&gt;\\inc\\api。

3.  エンドポイントの既定のプロパティを設定します。 たとえば、名前、アイコン、およびフォーム ファクター AudioEndpointBuilder を設定します。

4.  エンドポイントからパルス符号変調 (PCM) をサポートするホスト pin へのパスがあるかどうかを決定するオーディオ コーデック 3 (AC3) または Windows media ビデオ (WMV)。 ホストの pin が KSPIN に設定、通信のメンバーを持つ KSPIN 構造体\_通信\_シンクまたは KSPIN\_通信\_両方。 KSPIN 構造の詳細については、次を参照してください。 [ **KSPIN**](https://msdn.microsoft.com/library/windows/hardware/ff563483)します。

5.  エンドポイントのプロパティ ストアは、オーディオ デバイス インターフェイスのレジストリ キーのプロパティ情報を設定します。

6.  エンドポイントの状態を設定します。 エンドポイントの状態には、次の 3 つの値のいずれかを指定できます。

    -   アクティブ: これは、手順 4. で説明したように、パスが存在することを示します。

    -   電源が入っていません。 オーディオ デバイスは、回線のモジュラー ジャックの検出をサポートする場合、この状態は、エンドポイントのパスが存在して、ジャックがオーディオのアダプターの物理コネクタから外れていることを示します。

    -   存在しません。 この状態は、手順 4 で、パスが見つからなかったし、ジャック検出は、このエンドポイントでサポートされていないことを示します。

7.  関連付けられている INF ファイルで指定されている場合は、既定のエンドポイントとしてこのエンドポイントを設定します。

エンドポイントが列挙された後に、オーディオ システムのクライアント操作できます (前に示した) ように Windows Vista の新しい Api を使用して直接または間接的には、Wave などについての理解の Api を使用して、 [DShow](https://go.microsoft.com/fwlink/p/?linkid=130871)または[DirectSound します。](https://go.microsoft.com/fwlink/p/?linkid=130872) オーディオ クライアントがエンドポイントの ID が MMDevice を起動して同じエンドポイントを Wave または DirectSound ID にアクセスできるように、API の新しいメソッドを提供されています。

エンドポイントを使用するときに、次の利用できます。

-   同じグローバルに一意な ID (GUID) は、マシンを再起動するどのくらいの頻度に関係なく使用できます。 この永続的な GUID は waveOut ID や、エンドポイントのフレンドリ名を保存するよりも高い信頼性です。

-   同じプロパティ ストアは、コンピューターを再起動するどのくらいの頻度に関係なく使用できます。 オーディオ デバイスに関連するメタデータは、エンドポイントのプロパティ ストアに保存されます。

-   多重化された (マルチプレクサー) と非多重化された (DEMUX) ピンと、自動的に管理され AudioEndpointBuilder サービスによって列挙します。

独自のオーディオ デバイス ドライバーとのオーディオ デバイス、およびオーディオ アプリケーション、またはその両方を開発する INF ファイルを開発する場合は、次の問題とベスト プラクティスを意識することをお勧めします。 ドライバーとこれらの推奨事項を念頭にアプリケーションを開発する際に、ドライバー、INF ファイル、および、AudioEndpointBuilder でより効果的に機能するオーディオのクライアントを生成します。

-   名前付け規則。 エンドポイントに使用される名前付け規則は、ブリッジのピンのフレンドリ名に基づきます。 ただし、スピーカーのエンドポイントの場合、名前が「スピーカー」にハードコーディングされた、ドライバーやサード パーティのアプリケーションによっては変更できません。

-   準最適なトポロジです。 特定のトポロジは、エンドポイントを列挙するために、AudioEndpointBuilder によって使用されるアルゴリズムが原因の準最適なであると見なされます。 たとえば、これらの準最適なトポロジを作成するときに、ホスト ピンを非表示のエンドポイントと AudioEndpointBuilder または関連付けられているホストの pin にはリンクできません、AudioEndpointBuilder 分割ウィンドウ (分割エンドポイント) は表示できませんを作成します。

    -   **非表示のエンドポイント**

        次の図で KS フィルターは、1 つのブリッジ pin (スピーカー) に接続されている 2 つのホスト ピンに表示されます。

        ![非表示のエンドポイントと ac-3 ホスト暗証番号 (pin) を示すトポロジの問題を示す図](images/hidden-endpoint-bad.png)

        AudioEndpointBuilder では、このブリッジの暗証番号 (pin) を検出、ホスト ピンの 1 つだけにパスをトレース、ブリッジの暗証番号 (pin) の既定値を設定、作成し、スピーカーのエンドポイントをアクティブにし、引き続き他のブリッジのピンを検出します。 したがって、AudioEndpointBuilder から非表示のまま、その他のホストのピン留めします。

        ![ホストのピンとエンドポイントの間追跡可能なパスで推奨されるトポロジを示す図](images/hidden-endpoint-good.png)

        前の図では、トポロジの問題が再設計されましたが、AudioEndpointBuilder は、2 つのホストのピンを検出できるように (PCM および ac-3/PCM) ため、2 つのブリッジ ピン (スピーカーと SPDIF) がわかります。

    -   **分割ウィンドウ**

        ホストの 1 つの pin が 1 つ以上のブリッジ暗証番号 (pin) に接続するときは、別の種類の準最適なトポロジが作成されます。 次の図は、スピーカー ブリッジ暗証番号 (pin) と SPDIF ブリッジ pin に PCM ホスト暗証番号 (pin) が接続するトポロジを示しています。

        ![ピン留めする 1 つのホストに接続されているトポロジの問題が表示された 2 つのエンドポイントを示す図](images/splitter-bad.png)

        ここで、AudioEndpointBuilder は 1 つのブリッジ暗証番号 (pin) を検出しますと PCM ホストの pin にパスをトレース、既定値を設定を作成し、スピーカー エンドポイントがアクティブになります。 AudioEndpointBuilder 検出されると、[次へ] のブリッジ暗証番号 (pin)、同じ PCM ホスト pin にパスをトレース、既定値の設定とを作成し、SPDIF エンドポイントがアクティブになります。 ただし、両方のエンドポイントを初期化およびアクティブ化がそれらのいずれかにストリーミングできなくなりますストリームに、他の同時;つまり、相互に排他的なエンドポイントです。

        次の図は、個別の接続が存在するこのトポロジの再設計を示します。 この設計では、ピンが 2 つのブリッジの各 PCM のホストの pin にパスをトレースする AudioEndpointBuilder できます。

        ![ホストのピンとエンドポイントの間追跡可能なパスで推奨されるトポロジを示す図](images/splitter-good.png)

-   エンドポイントの形式。 オーディオ エンジンは、共有モードで実行中は、INF ファイルのインストール時に指定されたエンドポイントの形式の特定の設定と仮定します。 たとえば、オーディオ ドライバー、オーディオ デバイスは、44.1 kHz、16 ビット、ステレオ PCM 形式に既定のエンドポイントを設定するのに、関連付けられている INF ファイルを使用します。 インストール後に、エンドポイントの形式を変更するのにには、コントロール パネルまたはサード パーティのアプリケーションを使用します。

-   既定のデバイス。 既定のデバイスとして設定されるエンドポイントは、INF ファイルに情報を使用で、インストール時に選択されます。 インストールが完了すると、既定のエンドポイントである別のエンドポイントを選択するのにコントロール パネルまたはサード パーティのアプリケーションを使用する必要があります。

**注**   MMDevice API を使用してクライアント アプリケーションが、エンドポイントを選択、INF ファイルによってインストール時に既定として設定されるエンドポイントが選択されない場合。 API は、フォーム ファクターのランクと、エンドポイントは、レンダーまたはキャプチャ エンドポイントかどうかに基づいて、その選択を行います。 次の表では、選択の順序を示します。
<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">ランクをレンダリングします。</th>
<th align="left">ランクをキャプチャします。</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p>スピーカー</p></td>
<td align="left"><p>マイク</p></td>
</tr>
<tr class="even">
<td align="left"><p>ライン出力</p></td>
<td align="left"><p>行に</p></td>
</tr>
<tr class="odd">
<td align="left"><p>SPDIF</p></td>
<td align="left"><p>SPDIF</p></td>
</tr>
</tbody>
</table>

 

 

MMDevice API を使用して、既定のエンドポイントを選択すると、使用可能なエンドポイントが同じ順位付けされる、MMDevice API は、既定として選択するエンドポイントを決定するエンドポイント Id をアルファベット順です。 たとえば、オーディオのアダプターがライン出力および行の両方を含む場合コネクタ、および関連付けられている INF ファイルは、既定のインストール時に、いずれかのいずれかを選択しない、MMDevice API を識別するエンドポイント Id がアルファベット順に最初で、設定既定値としてのコネクタです。 この選択は、エンドポイントの Id は永続的であるため、システムの再起動後に永続化します。 ただし、システムでさらに高度エンドポイント (たとえば、マイク コネクタの使用の 2 つ目のアダプター) が表示された場合に、この選択は保持されません。

 

 




