---
title: WavePci デバイスのハードウェア要件
description: WavePci デバイスのハードウェア要件
ms.assetid: 58a73ac1-baba-42df-a590-e7282f902157
keywords:
- WavePci ハードウェア要件 WDK オーディオ
- バスマスタ WDK オーディオ
- 任意のアラインメントの WDK オーディオ
- メモリ WDK オーディオ
- WDK オーディオをキャッシュする
- WDK オーディオのデータコピー
- オーディオデータのコピー
- WDK オーディオをバッファーする
- p) バッファーフレーム WDK オーディオ
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 7653814bd3fac18867b4eb9067b0fbf488ff3c48
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2019
ms.locfileid: "72833335"
---
# <a name="hardware-requirements-for-wavepci-devices"></a>WavePci デバイスのハードウェア要件


## <span id="hardware_requirements_for_wavepci_devices"></span><span id="HARDWARE_REQUIREMENTS_FOR_WAVEPCI_DEVICES"></span>


新しいハードウェア設計の機能を選択する場合、ベンダーは次の一般的な原則に従う必要があります。

-   すべての処理をハードウェアに移動するのではなく、ベンダーは各機能のコストとパフォーマンスの影響を比較する必要があります。

-   ハードウェア機能の潜在的な価値を検討する場合、ベンダーは、オーディオなどの特定のサブシステムに限定するのではなく、システム全体に対する影響についてその機能を評価する必要があります。

-   ハードウェアで高速化する機能を選択することによって、ベンダーは CPU の負荷を軽減し、メモリの使用率を向上させることができるため、システムのリソースを他のタスクで使用できるようになります。

以前は、これらの原則に従って、すべてのオーディオハードウェア設計が成功しているわけではありませんでした。

オーディオコンテンツを再生する場合、または複数のストリームを混合する場合、一部の WDM オーディオドライバーでは、CPU 時間とバス帯域幅が不必要に消費されます。 通常、このような欠陥は、ハードウェア設計が欠陥し、ドライバーの実装が非効率な場合に発生します。 ハードウェア設計の欠陥によって、オーディオドライバーが特定の wave 形式を処理できないようにしたり、ソフトウェアの介入を必要とする回避策を要求したりすることもできます。

WaveCyclic デバイスモデルの目的は、古いオーディオデバイスのハードウェア制限に対応することです。 新しいハードウェア設計は、WavePci に完全に準拠している必要があります。

真のスキャッター/ギャザー DMA を実行できる WavePci デバイスでは、バッファー間のオーディオデータのコピーに時間を費やす必要がなくなります。 WaveCyclic とは異なり、WavePci はデータをコピーする必要がないため、複数ストリームまたはハードウェアアクセラレータのオーディオデバイス用の優先ミニポートドライバーとして使用できます。 適切に設計された WavePci デバイスは、ほとんどの CPU リソースを消費しないため、3-d 処理と混合のために大量のオーディオストリーム (64 以上) をハードウェアに送信することができます。

WavePci デバイスには、スキャッター/ギャザー DMA 転送をサポートするバスマスタ DMA コントローラーが必要です。 ハードウェア設計では、DMA コントローラーが処理できるデータ転送の種類に対して、任意の制限を設けることはできません。 WavePci デバイスは、次の要件を満たしている必要があります。

-   **デバイスはバスマスターである必要があります。**

    システム DMA リソースを使用せずに、オペレーティングシステムからの介入なしにシステムメモリに自律的にアクセスできる必要があります。

-   **デバイスは、任意の長さのデータ転送を処理できる必要があります。**

    メモリページより大きいマッピングを処理する必要があります (「 [**Iportwavepcistream:: GetMapping**](https://docs.microsoft.com/windows-hardware/drivers/ddi/portcls/nf-portcls-iportwavepcistream-getmapping)」を参照してください)。 たとえば、転送制限が4キロバイトのデバイスは、WavePci の完全な要件に適合しません。 Microsoft Windows をサポートする64ビットの Cpu では、ページサイズは 8 kb であるため、一部のマッピングはサイズが 4 kb を超える可能性があります。 1つのマッピングで 32 kb を超えるデータ転送は、物理的なメモリの断片化によっては理論的に可能です。 それ以外では、1バイトのマッピングサイズが可能です。

-   **デバイスは、システムメモリ内の任意の場所との間のデータ転送を処理する必要があります。**

    データ転送は、32 kb 以上のまたがるの境界を超えている可能性が非常に高くなります。 コンピューターに 4 gb を超える RAM を含めることができるようになりました。これらのシステムでは、64ビットの CPU または x86 の物理アドレス拡張 (PAE) の場合は、4 gb を超える物理メモリを割り当てることができます。 これらのマシンで最高のパフォーマンスを実現するには、ベンダーは64ビットのアドレス指定をサポートするデバイスを作成する必要があります。 それ以外の場合は、ソフトウェアでデータをコピーする必要があります。 16 mb を超える RAM を搭載したシステムで24ビットのアドレス指定を行うデバイスでは、データのコピーが従来必要でした。 物理メモリ内のどこからでも読み取りまたは書き込みができない場合、デバイスは WavePci ではなく WaveCyclic を使用する必要があります。 ドライバーは、デバイスの起動時にこの決定を行うことができます (システムメモリバスの完全なアドレス範囲にアクセスするのに十分なアドレスがあるかどうかを判断する機会を得られた後に、デバイスの[**開始時\_IRP\_完了し\_デバイスを起動**](https://docs.microsoft.com/windows-hardware/drivers/kernel/irp-mn-start-device)します)。

-   **デバイスは、任意の配置でデータ転送を処理する必要があります。**

    マッピングは、メモリ内の任意のバイト境界で開始および終了できます。 オーディオデータのフレームは、マッピング間で分割できます。最初のマッピングの最後にある最初の少数のチャネルのサンプルと、2番目のマッピングの残りのチャネルのサンプルが含まれます。 例については、「 [Wave フィルター](wave-filters.md)」を参照してください。 サンプルサイズによっては、マッピング間でサンプルコンテナーを分割することもできます。 デバイスで、転送がキャッシュラインの境界上にある必要がある場合、またはデバイスで転送が厳密にオーディオフレームの境界に固定されている必要がある場合 (たとえば、転送サイズがステレオ16ビットの場合は4に均等に分割されることを想定)、このデバイスは、完全な WavePci 準拠には適していません。 準拠していないハードウェアを WavePci デバイスとして公開できることに注意してください。これは、ドライバーが公開するデータの範囲または形式 (特定のビットの深さのみ、特定のチャネル構成のみなど) を制限することによって行います。

前の一覧の最後のポイントに関して、WavePci デバイスのスキャッター/ギャザー DMA エンジンは、メモリページの境界をまたがるするバッファーを処理する必要があります。 たとえば、10ミリ秒相当の16ビット PCM オーディオサンプルを格納しているバッファーは、48の5.1 チャネル wave ストリームに対して、次のサイズになります。

(6 サンプル/フレーム)\*(2 バイト/サンプル)\*(48K フレーム/秒)\*(10 ミリ秒) = 5760 バイト

これは、メモリページのサイズ (4096 バイト) を超えています。つまり、バッファーには、メモリ内での位置に応じて、1ページまたは2ページの境界が含まれています。 バッファーには、オーディオデータのフレームの整数 (480) が含まれていますが、これらのフレームの1つまたは2つがページの境界をまたがる可能性があります。

このため、WavePci デバイスのスキャッター/ギャザー DMA ハードウェアは、物理的に連続していない2つのページをメモリ内に分割するオーディオフレーム (次の図のフレーム197など) を処理するように設計する必要があります。

![ページの先頭からのオフセット位置にあるオーディオバッファーを示す図](images/framealign.png)

上の図の上部には、2つのページ間の境界をまたがっする5760バイトのバッファーがあります。 この例では、バッファーは最初のページの先頭から1728バイトのオフセットで開始され、バッファーの先頭がメモリ内の64バイトの境界に配置されます。 各オーディオフレームが12バイトを占有し、6つのチャネルが含まれているとします。 最初のページには、0 ~ 196 のすべてのフレームが含まれていますが、フレーム197の最初の4バイトのみが含まれています。

図の下部には、オーディオフレーム197の詳細ビューが表示されます。これは、チャンネル0および1のサンプルだけが最初のページに含まれることを示しています。 チャネル 2 ~ 5 のサンプルは、2番目のページに含まれています。

2つのページは図の上部に表示されますが、実際にはカーネル仮想メモリ内でのみ連続しています。 バッファーを含むページは物理メモリ内で連続していないため、物理アドレスを使用するスキャッター/ギャザー DMA コントローラーでは、バッファーの2つの部分を転送キューに2つの個別のエントリとして指定する必要があります。 WavePci port ドライバーは、ページの境界で自動的にバッファーを2つの個別の物理マッピングに分割します。

前の例を変更してバッファーを最初のページの先頭に揃える場合でも、分割フレームの問題は消えません。 次の図は、この点を示しています。 この場合、フレーム341は、チャネル0とチャンネル1のサンプルを使用してページ境界で分割され、2ページ目では、最初のページとチャネル 2 ~ 5 のサンプルになります。

![ページの先頭に合わせたオーディオバッファーを示す図](images/framealign2.png)

スキャッター/ギャザー DMA コントローラーが正しく処理できない WavePci デバイスは、処理できるオーディオデータ形式の種類に制限されますが、ソフトウェアの回避策はハードウェア設計の欠陥を軽減するのに役立ちます。 詳細については、「 [WavePci Latency](wavepci-latency.md)」を参照してください。

 

 




